<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚ªãƒ¼ãƒŠãƒ¼ | ç®¡ç†ãƒšãƒ¼ã‚¸</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#1a2a6c; --bg2:#b21f1f; --bg3:#fdbb2d;
      --card-bg: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.18);
      --text:#fff; --accent:#fff;
      --shadow: 0 12px 32px rgba(0,0,0,.28);
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{
        --card-bg: rgba(255,255,255,.74);
        --border: rgba(0,0,0,.08);
        --text:#111827; --accent:#111827;
      }
    }
    *{ box-sizing:border-box }
    html,body{
      height:100%; margin:0; color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Poppins", "Noto Sans JP", sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2) 55%, var(--bg3));
      background-attachment: fixed;
    }
    .wrap{
      min-height:100%;
      display:grid; place-items:center;
      padding:32px;
    }
    .card{
      width:min(1100px, 94vw);
      background: var(--card-bg);
      border:1px solid var(--border);
      border-radius:24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: clamp(20px, 4vw, 36px);
      animation: pop .5s ease both;
    }
    @keyframes pop{ from{opacity:0; transform:translateY(8px) scale(.985)} to{opacity:1; transform:none} }

    .title{ font-weight:700; font-size:clamp(22px,2.6vw,30px); margin:0 0 8px }
    .sub{ opacity:.9; margin:0 0 16px; font-size:clamp(13px,1.6vw,15px) }

    .row{ display:flex; gap:10px; align-items:center }
    .col{ display:flex; flex-direction:column; gap:8px }
    .input, .btn, select, textarea{
      font:600 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      border-radius:12px; padding:12px 14px;
      border:1px solid var(--border); background: rgba(255,255,255,.1);
      color:inherit;
    }
    .input, select, textarea{ min-width:0; }
    textarea{ resize:vertical }
    .btn{ cursor:pointer; user-select:none; white-space:nowrap; }
    .btn.primary{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35); }
    .btn.warn{ background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.35); }
    .btn.neutral{ background: rgba(255,255,255,.12); }
    .btn:hover{ filter:brightness(1.04) }
    .btn:active{ transform: translateY(1px) }

    .help{ font-size:12px; opacity:.85; margin-top:8px }
    .msg{ margin-top:10px; font-size:13px; }
    .msg.ok{ color: var(--ok) } .msg.err{ color: var(--err) } .msg.warn{ color: var(--warn) }

    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.15fr 1fr;
      margin-top:16px;
    }
    @media (max-width:980px){ .grid{ grid-template-columns: 1fr } }

    .panel{
      padding:14px; border:1px solid var(--border); border-radius:16px;
      background: rgba(0,0,0,.12);
    }
    .panel h3{ margin:0 0 10px; font-size:16px }

    .kv{ display:flex; gap:8px; align-items:center; margin-top:10px }
    .kv .k{ width:9em; opacity:.85; font-size:13px }
    .kv .v{ flex:1; font-weight:700 }

    .links{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--border);
      background: rgba(255,255,255,.12); font-weight:700; font-size:12px;
    }
    .chip .x{ cursor:pointer; opacity:.9 }
    .muted{ opacity:.8 }

    .list{ margin-top:10px; border:1px solid var(--border); border-radius:14px; overflow:hidden }
    .thead, .trow{
      display:grid; grid-template-columns: 140px 200px 1fr 220px 190px; gap:8px;
      align-items:center; padding:10px 12px;
    }
    .thead{ background: rgba(255,255,255,.08); font-weight:800 }
    .trow{ border-top:1px solid var(--border) }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <main class="wrap">

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
    <section id="loginCard" class="card" aria-labelledby="loginTitle">
      <h1 id="loginTitle" class="title">ã‚ªãƒ¼ãƒŠãƒ¼ãƒ­ã‚°ã‚¤ãƒ³</h1>
      <p class="sub">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ç®¡ç†ãƒšãƒ¼ã‚¸ã¸é€²ã‚“ã§ãã ã•ã„ã€‚</p>

      <div class="row" style="margin-top:6px;">
        <input id="pw" class="input" type="password" placeholder="ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button id="togglePw" class="btn neutral" aria-pressed="false" title="è¡¨ç¤º/éè¡¨ç¤º">ğŸ‘</button>
        <button id="loginBtn" class="btn primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>
      <div id="loginMsg" class="msg" role="status" aria-live="polite"></div>

      <p class="help">
        â€»Firebase Realtime Database ã® <code>game/ownerPassword</code> ã«è¨­å®šã•ã‚ŒãŸæ–‡å­—åˆ—ã¨ä¸€è‡´ã—ãŸå ´åˆã«å…¥å®¤ã§ãã¾ã™ã€‚
      </p>
    </section>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <section id="dashCard" class="card hidden" aria-labelledby="dashTitle">
      <h1 id="dashTitle" class="title">ã‚ªãƒ¼ãƒŠãƒ¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p class="sub">ã“ã®ãƒšãƒ¼ã‚¸ã¯ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ãŒé–²è¦§ãƒ»æ“ä½œã§ãã¾ã™ã€‚</p>

      <div class="grid">

        <!-- å·¦ï¼šæ³¨æ–‡ã‚’ä½œæˆ -->
        <div class="panel">
          <h3>æ³¨æ–‡ã‚’ä½œæˆ</h3>

          <div class="col">
            <label>æ³¨æ–‡ã®ç¨®é¡</label>
            <input id="orderTypeInput" class="input" list="orderTypesList" placeholder="ä¾‹ï¼šé€šå¸¸æ³¨æ–‡ / ç‰¹æ€¥æ³¨æ–‡ / ã‚¤ãƒ™ãƒ³ãƒˆæ³¨æ–‡">
            <datalist id="orderTypesList"></datalist>
          </div>

          <div class="col" style="margin-top:10px;">
            <label>æ–™ç†åï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰</label>
            <input id="dishInput" class="input" placeholder="ä¾‹ï¼šã‚­ãƒã‚³ã®ã‚¯ãƒªãƒ¼ãƒ ãƒ‘ã‚¹ã‚¿">
          </div>

          <div class="col" style="margin-top:10px;">
            <label>ç´ æï¼ˆè¤‡æ•°å¯ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰</label>
            <div class="row">
              <input id="materialInput" class="input" list="materialsList" placeholder="ç´ æã‚’å…¥åŠ›ã—ã¦ã€è¿½åŠ ã€">
              <button id="addMatBtn" class="btn neutral">è¿½åŠ </button>
            </div>
            <datalist id="materialsList"></datalist>
            <div id="matChips" class="links"></div>

            <div class="muted" style="margin-top:6px;">å€™è£œï¼š</div>
            <div id="matSuggests" class="links"></div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button id="createOrderBtn" class="btn primary">æ³¨æ–‡ã‚’ä½œæˆ</button>
            <div id="createMsg" class="msg" role="status" aria-live="polite"></div>
          </div>
        </div>

        <!-- å³ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
        <div class="panel">
          <h3>ã‚»ãƒƒã‚·ãƒ§ãƒ³</h3>
          <div class="kv"><div class="k">çŠ¶æ…‹</div><div id="sessState" class="v">â€”</div></div>
          <div class="kv"><div class="k">æœ‰åŠ¹æœŸé™</div><div id="sessExp" class="v">â€”</div></div>
          <div class="links" style="margin-top:8px;">
            <button id="logoutBtn" class="btn warn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <button id="backBtn" class="btn neutral">æˆ»ã‚‹</button>
          </div>

          <div class="panel" style="margin-top:14px;">
            <h3>ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
            <div class="row">
              <input id="newPw" class="input" type="text" placeholder="æ–°ã—ã„ã‚ªãƒ¼ãƒŠãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
              <button id="changeBtn" class="btn primary">å¤‰æ›´</button>
            </div>
            <div id="changeMsg" class="msg" role="status" aria-live="polite"></div>
            <p class="help">â€» DBã® <code>game/ownerPassword</code> ã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã€‚</p>
          </div>
        </div>

      </div>

      <!-- æ³¨æ–‡ä¸€è¦§ -->
      <div class="panel" style="margin-top:16px;">
        <h3>æ³¨æ–‡ä¸€è¦§</h3>
        <div class="thead">
          <div>ID</div><div>ç¨®é¡</div><div>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ–™ç†å / ç´ æï¼‰</div><div>ä½œæˆ</div><div>æ“ä½œ</div>
        </div>
        <div id="ordersList" class="list"></div>
        <div id="listMsg" class="msg muted"></div>
      </div>

      <div class="panel" style="margin-top:14px;">
        <h3>ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯</h3>
        <div class="links">
          <a class="btn link neutral" href="tyuumon.html">æ³¨æ–‡ãƒšãƒ¼ã‚¸ã¸</a>
          <a class="btn link neutral" href="turi.html">é‡£ã‚Š</a>
          <a class="btn link neutral" href="kari.html">ç‹©ã‚Š</a>
          <a class="btn link neutral" href="toru.html">æ¡å–</a>
        </div>
      </div>
    </section>

  </main>

  <!-- Firebase & ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, child, get, set, push, onValue, update, remove
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // â˜…Firebase è¨­å®šï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨åŒã˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyDPe5cSCavq5gHopugdOfQ-9_50cTrqmyk",
      authDomain: "school-178c2.firebaseapp.com",
      databaseURL: "https://school-178c2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "school-178c2",
      storageBucket: "school-178c2.firebasestorage.app",
      messagingSenderId: "409885673101",
      appId: "1:409885673101:web:25bf0483547e2d470304c4"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* ====== å®šæ•°ï¼ˆå€™è£œï¼‰ ====== */
    const ORDER_TYPES = ["é€šå¸¸æ³¨æ–‡","ç‰¹æ€¥æ³¨æ–‡","ã‚¤ãƒ™ãƒ³ãƒˆæ³¨æ–‡","è£œå……ä¾é ¼","ãƒ†ã‚¹ãƒˆæ³¨æ–‡"];
    const MATERIAL_SUGGESTIONS = ["è‚‰","é­š","ã‚­ãƒã‚³","é‡èœ","å°éº¦","ç±³","åµ","ä¹³","å¡©","ç ‚ç³–","æ²¹","æ°´","ã‚¹ãƒ‘ã‚¤ã‚¹","ãƒãƒ¼ãƒ–","è²","æµ·è—»"];

    /* ====== DOM ====== */
    const loginCard = document.getElementById('loginCard');
    const dashCard  = document.getElementById('dashCard');
    const pwInput   = document.getElementById('pw');
    const loginBtn  = document.getElementById('loginBtn');
    const loginMsg  = document.getElementById('loginMsg');
    const togglePw  = document.getElementById('togglePw');

    const sessState = document.getElementById('sessState');
    const sessExp   = document.getElementById('sessExp');
    const logoutBtn = document.getElementById('logoutBtn');
    const backBtn   = document.getElementById('backBtn');

    const newPw     = document.getElementById('newPw');
    const changeBtn = document.getElementById('changeBtn');
    const changeMsg = document.getElementById('changeMsg');

    // æ³¨æ–‡UI
    const orderTypeInput = document.getElementById('orderTypeInput');
    const orderTypesList = document.getElementById('orderTypesList');
    const dishInput      = document.getElementById('dishInput');
    const materialInput  = document.getElementById('materialInput');
    const materialsList  = document.getElementById('materialsList');
    const addMatBtn      = document.getElementById('addMatBtn');
    const matChips       = document.getElementById('matChips');
    const matSuggests    = document.getElementById('matSuggests');
    const createOrderBtn = document.getElementById('createOrderBtn');
    const createMsg      = document.getElementById('createMsg');

    const ordersList     = document.getElementById('ordersList');
    const listMsg        = document.getElementById('listMsg');

    /* ====== ã‚»ãƒƒã‚·ãƒ§ãƒ³ ====== */
    const SS_KEY = 'owner_session_v1';
    const SESSION_MS = 2 * 60 * 60 * 1000;

    function now(){ return Date.now(); }
    function fmt(ts){
      try{
        const d = new Date(ts);
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      }catch{ return 'â€”'; }
    }
    function loadSess(){ try{ const raw = sessionStorage.getItem(SS_KEY); return raw ? JSON.parse(raw) : null; }catch{ return null; } }
    function saveSess(obj){ try{ sessionStorage.setItem(SS_KEY, JSON.stringify(obj)); }catch{} }
    function clearSess(){ try{ sessionStorage.removeItem(SS_KEY); }catch{} }
    function updateSessUI(sess){
      if (sess && sess.ok){
        sessState.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­';
        sessExp.textContent = fmt(sess.exp);
      }else{
        sessState.textContent = 'æœªãƒ­ã‚°ã‚¤ãƒ³';
        sessExp.textContent = 'â€”';
      }
    }
    function showDash(){ loginCard.classList.add('hidden'); dashCard.classList.remove('hidden'); }
    function showLogin(){ dashCard.classList.add('hidden'); loginCard.classList.remove('hidden'); }

    // èµ·å‹•æ™‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    (function boot(){
      // å€™è£œã®æç”»
      ORDER_TYPES.forEach(t => {
        const o = document.createElement('option'); o.value = t; orderTypesList.appendChild(o);
      });
      MATERIAL_SUGGESTIONS.forEach(m => {
        const o = document.createElement('option'); o.value = m; materialsList.appendChild(o);
        const b = document.createElement('button');
        b.className = 'btn neutral'; b.textContent = m;
        b.addEventListener('click', ()=> addMaterial(m));
        matSuggests.appendChild(b);
      });

      const s = loadSess();
      if (s && s.ok && s.exp > now()){ updateSessUI(s); showDash(); }
      else{ clearSess(); showLogin(); }
    })();

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
    togglePw.addEventListener('click', ()=>{
      const visible = pwInput.type === 'text';
      pwInput.type = visible ? 'password' : 'text';
      togglePw.setAttribute('aria-pressed', String(!visible));
    });

    // Enterã§ãƒ­ã‚°ã‚¤ãƒ³
    pwInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') loginBtn.click(); });

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    loginBtn.addEventListener('click', async ()=>{
      loginMsg.textContent = '';
      const input = pwInput.value || '';
      if (!input){ loginMsg.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; loginMsg.className='msg err'; return; }
      try{
        const snap = await get(child(ref(db), 'game/ownerPassword'));
        if (!snap.exists()){ loginMsg.textContent = 'ownerPassword ãŒæœªè¨­å®šã§ã™ã€‚'; loginMsg.className='msg warn'; return; }
        const correct = String(snap.val() ?? '');
        if (input === correct){
          const s = { ok:true, exp: now() + SESSION_MS };
          saveSess(s); updateSessUI(s); showDash(); pwInput.value=''; loginMsg.textContent='';
        }else{
          loginMsg.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚'; loginMsg.className='msg err';
        }
      }catch(e){
        console.error(e);
        loginMsg.textContent = 'é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; loginMsg.className='msg err';
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    logoutBtn.addEventListener('click', ()=>{ clearSess(); updateSessUI(null); showLogin(); });

    // æˆ»ã‚‹
    backBtn.addEventListener('click', ()=>{
      if (document.referrer) history.back();
      else location.href = 'menu.html'; // å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
    });

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
    changeBtn.addEventListener('click', async ()=>{
      changeMsg.textContent = '';
      const s = loadSess();
      if (!(s && s.ok && s.exp > now())){ changeMsg.textContent='ãƒ­ã‚°ã‚¤ãƒ³æœ‰åŠ¹æœŸé™åˆ‡ã‚Œã§ã™ã€‚'; changeMsg.className='msg warn'; return; }
      const v = (newPw.value || '').trim();
      if (!v){ changeMsg.textContent='æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; changeMsg.className='msg err'; return; }
      if (v.length < 4){ changeMsg.textContent='4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚'; changeMsg.className='msg err'; return; }
      try{
        await set(ref(db, 'game/ownerPassword'), v);
        changeMsg.textContent='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚'; changeMsg.className='msg ok'; newPw.value='';
      }catch(e){
        console.error(e);
        changeMsg.textContent='æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªï¼‰ã€‚'; changeMsg.className='msg err';
      }
    });

    /* ====== æ³¨æ–‡ä½œæˆ UI ãƒ­ã‚¸ãƒƒã‚¯ ====== */
    let selectedMaterials = [];

    function dedupe(arr){ return [...new Set(arr.map(v => (v||'').trim()).filter(v => v))]; }

    function renderMatChips(){
      matChips.innerHTML = '';
      selectedMaterials.forEach((name, idx)=>{
        const chip = document.createElement('span');
        chip.className = 'chip';
        const label = document.createElement('span'); label.textContent = name;
        const x = document.createElement('span'); x.textContent = 'âœ•'; x.className='x';
        x.title = 'å‰Šé™¤'; x.addEventListener('click', ()=>{ selectedMaterials.splice(idx,1); selectedMaterials = dedupe(selectedMaterials); renderMatChips(); });
        chip.appendChild(label); chip.appendChild(x);
        matChips.appendChild(chip);
      });
      if (selectedMaterials.length === 0){
        const tip = document.createElement('span');
        tip.className='muted'; tip.textContent='ï¼ˆè¿½åŠ ã—ãŸç´ æã¯ã“ã“ã«ä¸¦ã³ã¾ã™ï¼‰';
        matChips.appendChild(tip);
      }
    }
    renderMatChips();

    function addMaterial(name){
      const v = (name ?? materialInput.value ?? '').trim();
      if (!v) return;
      selectedMaterials.push(v);
      selectedMaterials = dedupe(selectedMaterials);
      materialInput.value = '';
      renderMatChips();
    }

    addMatBtn.addEventListener('click', ()=> addMaterial());
    materialInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); addMaterial(); } });

    // æ³¨æ–‡ä½œæˆ
    createOrderBtn.addEventListener('click', async ()=>{
      createMsg.textContent = '';
      const s = loadSess();
      if (!(s && s.ok && s.exp > now())){ createMsg.textContent='ãƒ­ã‚°ã‚¤ãƒ³æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚'; createMsg.className='msg warn'; return; }

      const type = (orderTypeInput.value || '').trim();
      const dish = (dishInput.value || '').trim();
      const materials = dedupe(selectedMaterials);

      if (!type){ createMsg.textContent='ã€Œæ³¨æ–‡ã®ç¨®é¡ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; createMsg.className='msg err'; return; }
      if (!dish){ createMsg.textContent='ã€Œæ–™ç†åã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'; createMsg.className='msg err'; return; }

      const data = {
        type,
        status: { dish, materials },
        createdAt: now(),
        updatedAt: now()
      };

      try{
        await push(ref(db, 'game/orders'), data);
        createMsg.textContent = 'æ³¨æ–‡ã‚’ä½œæˆã—ã¾ã—ãŸã€‚'; createMsg.className='msg ok';
        // ã‚¯ãƒªã‚¢
        // å€™è£œã«ç„¡ã„ã‚¿ã‚¤ãƒ—ã¯æ¬¡å›å…¥åŠ›è£œåŠ©ã®ãŸã‚ datalist ã«è¿½åŠ 
        if (!ORDER_TYPES.includes(type)){
          const o = document.createElement('option'); o.value = type; orderTypesList.appendChild(o);
        }
        orderTypeInput.value=''; dishInput.value=''; selectedMaterials=[]; renderMatChips();
      }catch(e){
        console.error(e);
        createMsg.textContent = 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ«ãƒ¼ãƒ«/æ¨©é™ã‚’ç¢ºèªï¼‰ã€‚'; createMsg.className='msg err';
      }
    });

    /* ====== æ³¨æ–‡ä¸€è¦§ï¼ˆè³¼èª­ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ï¼‰ ====== */
    function renderOrdersView(map){
      ordersList.innerHTML = '';
      const entries = map ? Object.entries(map) : [];
      if (entries.length === 0){
        listMsg.textContent = 'æ³¨æ–‡ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚';
        return;
      }
      listMsg.textContent = '';

      // æ–°ã—ã„é †ã«ä¸¦ã¹æ›¿ãˆ
      entries.sort((a,b)=> (b[1]?.createdAt||0) - (a[1]?.createdAt||0));

      for (const [id, o] of entries){
        const row = document.createElement('div');
        row.className = 'trow';

        // è¡¨ç¤ºç”¨DOM
        const idEl   = document.createElement('div'); idEl.textContent = id.slice(-6);
        const typeEl = document.createElement('div'); typeEl.textContent = o.type || 'â€”';

        const statusEl = document.createElement('div');
        const dishSpan = document.createElement('div'); dishSpan.innerHTML = `<b>${o?.status?.dish || 'â€”'}</b>`;
        const matsSpan = document.createElement('div'); matsSpan.className='muted';
        matsSpan.textContent = (o?.status?.materials||[]).join(', ') || 'â€”';
        statusEl.appendChild(dishSpan); statusEl.appendChild(matsSpan);

        const timeEl = document.createElement('div'); timeEl.className='muted';
        timeEl.textContent = fmt(o.createdAt);

        const actEl = document.createElement('div'); actEl.className='actions';
        const editBtn = document.createElement('button'); editBtn.className='btn neutral'; editBtn.textContent='ç·¨é›†';
        const delBtn  = document.createElement('button'); delBtn.className='btn warn'; delBtn.textContent='å‰Šé™¤';
        actEl.appendChild(editBtn); actEl.appendChild(delBtn);

        // ã‚°ãƒªãƒƒãƒ‰ã«è¿½åŠ 
        row.appendChild(idEl); row.appendChild(typeEl); row.appendChild(statusEl); row.appendChild(timeEl); row.appendChild(actEl);
        ordersList.appendChild(row);

        // ç·¨é›†ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰
        editBtn.addEventListener('click', ()=>{
          // æ—¢å­˜è¡¨ç¤ºã‚’ç·¨é›†UIã«å·®ã—æ›¿ãˆ
          const typeInp = document.createElement('input'); typeInp.className='input'; typeInp.value = o.type || '';
          const dishInp = document.createElement('input'); dishInp.className='input'; dishInp.value = o?.status?.dish || '';
          const matsInp = document.createElement('input'); matsInp.className='input'; matsInp.placeholder='ç´ æã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š'; matsInp.value = (o?.status?.materials||[]).join(', ');

          // ç½®æ›
          typeEl.replaceChildren(typeInp);
          statusEl.replaceChildren(dishInp, matsInp);

          // æ“ä½œãƒœã‚¿ãƒ³ã‚’å·®ã—æ›¿ãˆ
          actEl.innerHTML='';
          const saveBtn = document.createElement('button'); saveBtn.className='btn primary'; saveBtn.textContent='ä¿å­˜';
          const cancelBtn = document.createElement('button'); cancelBtn.className='btn neutral'; cancelBtn.textContent='ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
          actEl.appendChild(saveBtn); actEl.appendChild(cancelBtn);

          cancelBtn.addEventListener('click', ()=>{ renderOrdersView(map); }); // å…¨ä½“å†æç”»ã§å…ƒã«æˆ»ã™

          saveBtn.addEventListener('click', async ()=>{
            const s = loadSess();
            if (!(s && s.ok && s.exp > now())){ alert('ãƒ­ã‚°ã‚¤ãƒ³æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ'); return; }
            const nType = (typeInp.value||'').trim();
            const nDish = (dishInp.value||'').trim();
            const nMats = dedupe((matsInp.value||'').split(',').map(v=>v.trim()).filter(Boolean));
            if (!nType || !nDish){ alert('ç¨®é¡ã¨æ–™ç†åã¯å¿…é ˆã§ã™ã€‚'); return; }
            try{
              await update(ref(db, 'game/orders/'+id), {
                type: nType,
                status: { dish: nDish, materials: nMats },
                updatedAt: now()
              });
            }catch(e){
              console.error(e); alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
          });
        });

        // å‰Šé™¤
        delBtn.addEventListener('click', async ()=>{
          if (!confirm('ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
          try{
            await remove(ref(db, 'game/orders/'+id));
          }catch(e){
            console.error(e); alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        });
      }
    }

    // è³¼èª­
    onValue(ref(db, 'game/orders'), (snap)=>{
      renderOrdersView(snap.exists() ? snap.val() : null);
    });
  </script>
</body>
</html>
