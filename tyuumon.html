<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ³¨æ–‡å¯¾å¿œ | èª¿ç†å ´</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg:#ffffff;
    --card:rgba(255,255,255,0.85);
    --muted:#6b7280;
    --border:rgba(0,0,0,.12);
    --accent:#0ea5e9;
    --ok:#16a34a;
    --warn:#d97706;
    --err:#dc2626;
  }

  *{ box-sizing:border-box }

  html,body{
    margin:0;
    height:100%;
    color:#111827;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Poppins","Noto Sans JP", sans-serif;

    /* ğŸŒŸ èƒŒæ™¯ç”»åƒã‚’ã€Œ1æšã ã‘ã€ã€Œå…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆã€ã€Œæ˜ã‚‹ãå›ºå®šã€ */
    background: #f8fafc url("assets/ryouri.png") center center no-repeat;
    background-size: cover;       /* ç”»é¢ã„ã£ã±ã„ã«æ‹¡å¤§ç¸®å°ã—ã¦è¡¨ç¤º */
    background-attachment: fixed; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚èƒŒæ™¯ã¯å‹•ã‹ãªã„ */
  }

  .wrap{ min-height:100%; padding:16px; display:grid; gap:16px; }

  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:rgba(255,255,255,0.7);
    border:1px solid var(--border);
    padding:12px 14px;
    border-radius:14px;
    backdrop-filter: blur(8px);
  }

  .team{ display:flex; gap:10px; align-items:center; font-weight:700 }
  .points{ font-weight:700; }

  select,button,input{
    font:600 14px/1.2 system-ui,-apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:#ffffff;
    color:#111827;
  }
  button{ cursor:pointer }
  button:disabled{ opacity:.6; cursor:not-allowed }

  /* ğŸ’¡ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯å¸¸ã«ç¸¦ä¸¦ã³ */
  .grid {
  display: grid;
  grid-template-columns: 1.2fr 1fr; /* å·¦ãŒåºƒã‚ãƒ»å³ãŒã‚„ã‚„ç‹­ã‚ */
  gap: 16px;
}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px 12px 14px;
    box-shadow:0 6px 20px rgba(0,0,0,.05);
  }
  .card h2{ margin:0 0 10px; font-size:18px }
  .sub{ color:var(--muted); font-size:12px; margin:4px 0 10px }

  .list{ display:grid; gap:8px; }
  .row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    padding:10px;
    border:1px solid var(--border);
    border-radius:12px;
    background:rgba(255,255,255,0.9);
  }
  .row .name{ font-weight:700 }

  .kv{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .qty{ padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; }
  .muted{ color:var(--muted) }
  .ok{ color:var(--ok) } .err{ color:var(--err) } .warn{ color:var(--warn) }

  .cook{
    display:grid;
    grid-template-columns: repeat(6, minmax(0,1fr));
    gap:10px;
    margin-top:8px;
  }
  .slot{
    height:58px;
    border:1px dashed rgba(0,0,0,.25);
    border-radius:12px;
    display:grid;
    place-items:center;
    background:#fff;
    position:relative;
  }
  .slot.filled{ border-style:solid; }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    background:#f3f4f6;
    border:1px solid var(--border);
    font-weight:700;
  }
  .x{ cursor:pointer; opacity:.9; }
  .toolbar{ display:flex; gap:8px; margin-top:10px; align-items:center; }
  .msg{ margin-top:8px; font-size:13px; min-height:18px }

  .orders-head,.orders-row{
    display:grid;
    grid-template-columns: 120px 1fr 200px;
    gap:10px;
    align-items:center;
    padding:8px 10px;
    border-radius:10px;
  }
  .orders-head{
    background:rgba(255,255,255,0.8);
    font-weight:800;
    border:1px solid var(--border);
  }
  .orders-row{
    border:1px solid var(--border);
    background:rgba(255,255,255,0.9);
    margin-top:6px;
  }

  footer{
    text-align:center;
    color:var(--muted);
    font-size:12px;
    background:rgba(255,255,255,0.6);
    border-radius:10px;
    padding:6px;
  }

  .toast{
    position:fixed;
    left:50%;
    top:16px;
    transform:translateX(-50%) translateY(-8px);
    background:#ffffff;
    border:1px solid var(--border);
    color:#111827;
    padding:10px 14px;
    border-radius:999px;
    box-shadow:0 8px 30px rgba(0,0,0,.08);
    opacity:0;
    pointer-events:none;
    z-index:100000;
    transition:opacity .22s ease, transform .22s ease;
    font:600 14px/1.2 system-ui,-apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .toast.warn{ border-color: var(--warn); color: var(--warn); }
  .toast.ok{ border-color: var(--ok); color: var(--ok); }
  .toast.err{ border-color: var(--err); color: var(--err); }

  *{ -webkit-tap-highlight-color: transparent; }
  html,body{ -webkit-user-select:none; user-select:none; }
  button, input, select, textarea { -webkit-user-select:auto; user-select:auto; }
  .drag{ -webkit-user-drag: element; touch-action:none; }
  .chip, .row .name{ white-space: nowrap; overflow: hidden; }
    /* è¿½åŠ ï¼šå‰Šé™¤ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›® */
button.btn-danger{
  border-color: var(--err);
  color: var(--err);
  background:#fff;
}
button.btn-danger:hover{
  background: rgba(220,38,38,.06); /* var(--err)ã®è–„ã„èƒŒæ™¯ */
}
.section { display:block; }
.section-head{
  margin-top:6px; margin-bottom:8px;
  display:flex; align-items:center; justify-content:space-between; gap:8px;
}
.section-tools{ display:flex; gap:8px; align-items:center; }
.section-tools input[type="search"]{
  width:min(280px, 60vw);
  padding:8px 10px; border-radius:10px;
  border:1px solid var(--border); background:#fff;
  font:600 14px/1.2 system-ui,-apple-system,"Noto Sans JP",sans-serif;
}
button.chev{
  width:36px; height:36px; display:grid; place-items:center;
  border:1px solid var(--border); border-radius:10px;
  background:#fff; cursor:pointer; font-weight:700;
  line-height:1; padding:0;
}
</style>


</head>
<body>
  <div class="wrap">
    <header>
<div class="team">
   <span>ç¾åœ¨ã®ãƒãƒ¼ãƒ ï¼š</span>
   <strong id="teamLabel"></strong>
</div>
      <div class="points">ãƒã‚¤ãƒ³ãƒˆï¼š<span id="pointsLbl">0</span></div>
    </header>

    <div class="grid">
      <!-- å·¦ï¼šå€‰åº«ã¨æŒã¡ç‰© -->
      <div class="card">
<div class="section" id="whSection">
    <div class="section-head">
      <h2>å€‰åº«ã®é£Ÿæ</h2>
      <div class="section-tools">
        <input type="search" id="whSearch" placeholder="æ¤œç´¢ï¼ˆä¾‹: ãƒšãƒƒãƒ‘ãƒ¼ï¼‰" aria-label="å€‰åº«ã‚’æ¤œç´¢">
        <button id="whToggle" class="chev" aria-expanded="true" aria-controls="warehouseList">â–¾</button>
      </div>
    </div>
    <div id="warehouseList" class="list"></div>
    <div class="sub">å€‰åº« â‡„ æ‰‹æŒã¡ã«ç§»å‹•ã§ãã¾ã™ã€‚</div>
  </div>

  <div class="section" id="invSection">
    <div class="section-head">
      <h2 style="margin-top:14px;">è‡ªåˆ†ãŒæŒã£ã¦ã„ã‚‹ã‚‚ã®</h2>
      <div class="section-tools">
        <input type="search" id="invSearch" placeholder="æ¤œç´¢ï¼ˆä¾‹: ãƒ©ã‚¤ã‚¹ï¼‰" aria-label="æ‰‹æŒã¡ã‚’æ¤œç´¢">
        <button id="invToggle" class="chev" aria-expanded="true" aria-controls="invList">â–¾</button>
      </div>
    </div>
    <div id="invList" class="list"></div>
  </div>
        
      </div>

      <!-- å³ï¼šèª¿ç† / æ³¨æ–‡ -->
      <div class="card">
        <h2>èª¿ç†</h2>
        <div class="sub">ç´ æã‚’ä¸‹ã®ã‚¹ãƒ­ãƒƒãƒˆã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— â†’ ã€Œæ–™ç†ã™ã‚‹ã€</div>
        <div class="cook" id="slots"></div>
        <div class="toolbar">
          <button id="cookBtn">æ–™ç†ã™ã‚‹</button>
          <button id="clearSlotsBtn">ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="cookMsg" class="msg"></div>

        <h2 style="margin-top:16px;">å—æ³¨ä¸­ï¼ˆã“ã®ãƒãƒ¼ãƒ ï¼‰</h2>
        <div class="orders-head">
          <div>æ³¨æ–‡ID</div><div>æ–™ç†å / ç´ æ</div><div>ä½œæˆæ™‚åˆ»</div>
        </div>
        <div id="ordersList" class="list"></div>
        <div id="ordersMsg" class="msg muted"></div>
      </div>
    </div>

    <footer>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚¹ãƒ­ãƒƒãƒˆå¤–ã«é›¢ã—ãŸå ´åˆã¯è‡ªå‹•ã§æ‰‹æŒã¡ã«æˆ»ã‚Šã¾ã™ã€‚</footer>
  </div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
   import {
    getDatabase, ref, child, get, onValue, push, remove, runTransaction, onDisconnect, set
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import {
    initializeAuth,
    indexedDBLocalPersistence,
    browserLocalPersistence,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";


    /* =====================  è¨­å®šãƒ»ãƒ¬ã‚·ãƒ”  ===================== */
    // â˜…ã‚ªãƒ¼ãƒŠãƒ¼ç”»é¢ã¨åŒã˜ã«ã—ã¦ãã ã•ã„
    const DISH_MASTER = {
  "ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ†ãƒ¼ã‚­": { "materials": ["ãƒ‰ãƒ©ã‚´ãƒ³ãƒŸãƒ¼ãƒˆ","ãƒ•ã‚¡ã‚¤ã‚¢ãƒšãƒƒãƒ‘ãƒ¼","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹"] },
  "ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°ã‚ªãƒ ãƒ¬ãƒ„": { "materials": ["ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°","ã‚µãƒ³ãƒªãƒ¼ãƒ•","ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ¬ã‚¤ãƒ³"] },
  "é¦™è‰ç„¼ãã‚¹ãƒˆãƒ¼ãƒ³ãƒ•ã‚£ãƒƒã‚·ãƒ¥": { "materials": ["ã‚¹ãƒˆãƒ¼ãƒ³ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ãƒŸã‚¹ãƒˆãƒªãƒ¼ãƒ•","ãƒšãƒƒãƒ‘ãƒ¼ã‚·ãƒ¼ãƒ‰"] },
  "ãƒ ãƒ¼ãƒ³ãƒ™ãƒªãƒ¼ã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚«ãƒ¼ãƒ—": { "materials": ["ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚«ãƒ¼ãƒ—","ãƒ ãƒ¼ãƒ³ãƒ™ãƒªãƒ¼","ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼"] },
  "ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼ãƒ•ãƒ­ã‚¹ãƒˆãƒˆãƒ©ã‚¦ãƒˆã‚¹ãƒ¼ãƒ—": { "materials": ["ãƒ•ãƒ­ã‚¹ãƒˆãƒˆãƒ©ã‚¦ãƒˆ","ãƒ•ã‚¡ã‚¤ã‚¢ãƒšãƒƒãƒ‘ãƒ¼","ã‚µãƒ³ãƒªãƒ¼ãƒ•"] },
  "ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ãƒ«ãƒ¼ãƒ„é‹ãƒ«ãƒŸãƒŠã‚¹ãƒ•ã‚£ãƒƒã‚·ãƒ¥": { "materials": ["ãƒ«ãƒŸãƒŠã‚¹ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ãƒ«ãƒ¼ãƒ„","ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«"] },
  "ã‚ªãƒ¼ãƒ­ãƒ©ãƒ•ã‚£ãƒƒã‚·ãƒ¥å¯¿å¸": { "materials": ["ã‚ªãƒ¼ãƒ­ãƒ©ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹","ãƒŸã‚¹ãƒˆãƒ‰ãƒ­ãƒƒãƒ—"] },
  "ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³ã®è±ªè¯é‹": { "materials": ["ãƒ‰ãƒ©ã‚´ãƒ³ãƒŸãƒ¼ãƒˆ","ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°","ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„"] },
  "ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã®é¦™è‰ç„¼ã": { "materials": ["ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ã‚µãƒ³ãƒªãƒ¼ãƒ•","ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„"] },
  "ãƒ¢ã‚¹ã‚«ãƒ¼ãƒ—ã®ãƒãƒ¼ãƒ–ãƒ•ãƒ©ã‚¤": { "materials": ["ãƒ¢ã‚¹ã‚«ãƒ¼ãƒ—","ã‚µãƒ³ãƒªãƒ¼ãƒ•","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹"] },
  "ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã®ç”˜éœ²ç…®": { "materials": ["ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼","ã‚µãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼"] },
  "ã‚µãƒ³ãƒ€ãƒ¼ãƒ‹ãƒ¼ãƒ‰ãƒ«ã®å”æšã’": { "materials": ["ã‚µãƒ³ãƒ€ãƒ¼ãƒ‹ãƒ¼ãƒ‰ãƒ«","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹","ãƒ•ã‚¡ã‚¤ã‚¢ãƒšãƒƒãƒ‘ãƒ¼"] },
  "ãƒ–ãƒ©ãƒƒãƒ‰ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã®èµ¤ãƒ¯ã‚¤ãƒ³é¢¨ç…®è¾¼ã¿": { "materials": ["ãƒ–ãƒ©ãƒƒãƒ‰ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ãƒ™ãƒªãƒ¼ã‚¸ãƒ¥ãƒ¼ã‚¹","ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼"] },
  "ãƒ†ãƒ³ãƒšã‚¹ãƒˆã‚¤ãƒ¼ãƒ«ã®å‘³å™Œé¢¨ç…®è¾¼ã¿": { "materials": ["ãƒ†ãƒ³ãƒšã‚¹ãƒˆã‚¤ãƒ¼ãƒ«","ãƒŸã‚¹ãƒˆãƒªãƒ¼ãƒ•","ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«"] },
  "ãƒ•ãƒ¬ã‚¤ãƒ ã‚µãƒ¼ãƒ¢ãƒ³ã®ãƒã‚¿ãƒ¼ç„¼ã": { "materials": ["ãƒ•ãƒ¬ã‚¤ãƒ ã‚µãƒ¼ãƒ¢ãƒ³","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹","ã‚µãƒ³ãƒªãƒ¼ãƒ•"] },
  "ã‚¹ã‚«ã‚¤ãƒ¬ã‚¤ã®ã‚«ãƒ«ãƒ‘ãƒƒãƒãƒ§": { "materials": ["ã‚¹ã‚«ã‚¤ãƒ¬ã‚¤","ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚³ã‚¢","ãƒŸã‚¹ãƒˆãƒ‰ãƒ­ãƒƒãƒ—"] },
  "ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã®ç…®ä»˜ã‘": { "materials": ["ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹","ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼"] },
  "ãƒŸãƒ©ãƒ¼ã‚¸ãƒ¥ã‚·ãƒ£ãƒ¼ã‚¯ã®ã‚°ãƒªãƒ«": { "materials": ["ãƒŸãƒ©ãƒ¼ã‚¸ãƒ¥ã‚·ãƒ£ãƒ¼ã‚¯","ãƒšãƒƒãƒ‘ãƒ¼ã‚·ãƒ¼ãƒ‰","ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼"] },

  "ç«œåµãƒãƒ£ãƒ¼ãƒãƒ³": { "materials": ["ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹","ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹"] },
  "ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ¬ã‚¤ãƒ³ãƒ‘ãƒ³": { "materials": ["ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ¬ã‚¤ãƒ³","ã‚°ãƒ¬ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼"] },
  "ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹ãŠã«ãã‚Š": { "materials": ["ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹","ãƒŸã‚¹ãƒˆãƒªãƒ¼ãƒ•","ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼"] },
  "ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ‘ã‚¤": { "materials": ["ã‚°ãƒ¬ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„","ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„"] },
  "ãƒ©ã‚¤ã‚¹ãƒŒã‚«æ¼¬ã‘": { "materials": ["ãƒ©ã‚¤ã‚¹ãƒŒã‚«","ã‚µãƒ³ãƒªãƒ¼ãƒ•","ãƒŸã‚¹ãƒˆãƒ‰ãƒ­ãƒƒãƒ—"] },
  "ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹ã‚¯ãƒ©ãƒƒã‚«ãƒ¼": { "materials": ["ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹","ã‚°ãƒ¬ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„"] },

  "ãƒ•ãƒ¬ã‚¤ãƒ ãƒšãƒƒãƒ‘ãƒ¼ã‚µãƒ©ãƒ€": { "materials": ["ãƒ•ã‚¡ã‚¤ã‚¢ãƒšãƒƒãƒ‘ãƒ¼","ã‚µãƒ³ãƒªãƒ¼ãƒ•","ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ãƒ«ãƒ¼ãƒ„"] },
  "ã‚µãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼ã‚¹ãƒ¼ãƒ—": { "materials": ["ã‚µãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼","ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«"] },
  "ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚³ã‚¢é£´": { "materials": ["ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚³ã‚¢","ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼"] },
  "ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„ãƒ­ãƒ¼ã‚¹ãƒˆ": { "materials": ["ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹"] },
  "ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«ã®ç…®å‡ã‚Š": { "materials": ["ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«","ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹"] },
  "ã‚µãƒ³ãƒªãƒ¼ãƒ•ã®é¦™è‰ç‚’ã‚": { "materials": ["ã‚µãƒ³ãƒªãƒ¼ãƒ•","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹"] },

  "ãƒ ãƒ¼ãƒ³ãƒ™ãƒªãƒ¼ãƒ‘ã‚¤": { "materials": ["ãƒ ãƒ¼ãƒ³ãƒ™ãƒªãƒ¼","ã‚°ãƒ¬ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼"] },
  "ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼ãƒ—ãƒªãƒ³": { "materials": ["ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼","ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼","ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°"] },
  "ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼ã‚¯ãƒƒã‚­ãƒ¼": { "materials": ["ã‚°ãƒ¬ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼","ãƒŸã‚¹ãƒˆãƒªãƒ¼ãƒ•"] },
  "ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¼ãƒªãƒ¼": { "materials": ["ã‚¯ãƒªã‚¹ã‚¿ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„","ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«","ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼"] },
  "ãƒ ãƒ¼ãƒ³ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚±ãƒ¼ã‚­": { "materials": ["ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹","ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼","ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ¬ã‚¤ãƒ³"] },
  "ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¿ãƒ«ãƒˆ": { "materials": ["ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ãƒ«ãƒ¼ãƒ„","ã‚°ãƒ¬ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„"] },
  "ã‚¹ãƒ”ãƒªãƒƒãƒˆãƒ‰ãƒªãƒ³ã‚¯": { "materials": ["ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹","ãƒŸã‚¹ãƒˆãƒ‰ãƒ­ãƒƒãƒ—","ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼"] },
  "ãƒ©ã‚¤ãƒˆãƒ€ã‚¹ãƒˆã‚­ãƒ£ãƒ³ãƒ‡ã‚£": { "materials": ["ãƒ©ã‚¤ãƒˆãƒ€ã‚¹ãƒˆ","ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼"] },
  "ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°ã‚·ãƒ•ã‚©ãƒ³": { "materials": ["ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°","ã‚°ãƒ¬ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼"] },
  "ã‚ªãƒ¼ãƒ­ãƒ©ãƒ•ã‚£ãƒƒã‚·ãƒ¥ã®å†·è£½ãƒãƒªãƒ": { "materials": ["ã‚ªãƒ¼ãƒ­ãƒ©ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ã‚µãƒ³ãƒ•ãƒ©ãƒ¯ãƒ¼","ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹"] },

  "ãƒ€ã‚¤ã‚ªã‚¦ã‚¤ã‚«ã®å¢¨ç…®": { "materials": ["ãƒ€ã‚¤ã‚ªã‚¦ã‚¤ã‚«","ãƒŸã‚¹ãƒˆãƒªãƒ¼ãƒ•","ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹"] },
  "ãƒ€ã‚¤ã‚ªã‚¦ã‚¤ã‚«ã®å”æšã’": { "materials": ["ãƒ€ã‚¤ã‚ªã‚¦ã‚¤ã‚«","ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹","ãƒ•ã‚¡ã‚¤ã‚¢ãƒšãƒƒãƒ‘ãƒ¼"] },
  "ãƒ€ã‚¤ã‚ªã‚¦ã‚¤ã‚«ã¨ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹ã®ç‚Šãè¾¼ã¿ã”é£¯": { "materials": ["ãƒ€ã‚¤ã‚ªã‚¦ã‚¤ã‚«","ã‚¹ã‚¿ãƒ¼ãƒ©ã‚¤ã‚¹","ã‚µãƒ³ãƒªãƒ¼ãƒ•"] }
    };
// ===== 24æ™‚é–“æœ‰åŠ¹æœŸé™ã®è¨­å®š =====
const EXPIRE_MS = 24 * 60 * 60 * 1000; // 24æ™‚é–“
const nowMs = () => Date.now();
// ===== æ—§ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªå¼·åˆ¶ãƒ‘ãƒ¼ã‚¸ï¼ˆ1å›ã ã‘ï¼‰ =====
const INV_KEY = 'inventory_v1';                // æ—§ã‚­ãƒ¼
const PURGE_FLAG_KEY = 'inventory_purge_2025_11_04'; // é©å½“ãªä¸€æ„ãƒ•ãƒ©ã‚°ï¼ˆæ—¥ä»˜å…¥ã‚Šã«ã—ã¦ãŠãï¼‰

if (!localStorage.getItem(PURGE_FLAG_KEY)) {
  try {
    localStorage.removeItem(INV_KEY);          // æ—§åœ¨åº«ã‚’å®Œå…¨å‰Šé™¤
    // ï¼ˆã‚‚ã—ä»–ã«ä½¿ã£ã¦ãŸæ—§ã‚­ãƒ¼ãŒã‚ã‚Œã°ã“ã“ã§ä¸€ç·’ã«æ¶ˆã™ï¼‰
    // localStorage.removeItem('inventory');    // ä¾‹ï¼šã•ã‚‰ã«å¤ã„ã‚­ãƒ¼ãŒã‚ã‚Œã°

  } catch (_) {}
  localStorage.setItem(PURGE_FLAG_KEY, '1');   // äºŒåº¦ã¨èµ°ã‚‰ãªã„ã‚ˆã†ã«ãƒ•ãƒ©ã‚°
}

    /* =====================  Firebase  ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyDPe5cSCavq5gHopugdOfQ-9_50cTrqmyk",
      authDomain: "school-178c2.firebaseapp.com",
      databaseURL: "https://school-178c2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "school-178c2",
      storageBucket: "school-178c2.firebasestorage.app",
      messagingSenderId: "409885673101",
      appId: "1:409885673101:web:25bf0483547e2d470304c4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

  // ---- Auth ã‚’æ˜ç¤ºåˆæœŸåŒ–ï¼ˆIndexedDB å„ªå…ˆã€ä¸å¯ãªã‚‰ localStorageï¼‰----
  const auth = initializeAuth(app, {
    persistence: [indexedDBLocalPersistence, browserLocalPersistence]
  });

  // ---- è¤‡æ•°ã‚¿ãƒ–åŒæ™‚ã‚µã‚¤ãƒ³ã‚¤ãƒ³æŠ‘æ­¢ãƒ­ãƒƒã‚¯ ----
  const AUTH_LOCK_KEY = "auth_signin_lock_v1";
  const AUTH_BC_CH    = "auth_signin_bc_v1";
  const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(AUTH_BC_CH) : null;
  bc?.addEventListener("message", (ev) => {
    if (ev?.data === "signed-in") {
     try { localStorage.removeItem(AUTH_LOCK_KEY); } catch {}
    }
  });
  function tryAcquireLock(){
    const now = Date.now();
    try{
      const raw = localStorage.getItem(AUTH_LOCK_KEY);
      const t = raw ? Number(raw) : 0;
      if (!raw || !t || (now - t) > 10000) { // 10ç§’ã§æœŸé™åˆ‡ã‚Œ
        localStorage.setItem(AUTH_LOCK_KEY, String(now));
       return true;
     }
    }catch{}
    return false;
  }
  function releaseLock(){ try{ localStorage.removeItem(AUTH_LOCK_KEY); }catch{} }

  // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ â†’ ç„¡ã‘ã‚Œã°â€œ1ã‚¿ãƒ–ã ã‘â€åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
  await auth.authStateReady();
  if (!auth.currentUser) {
    const iAmLeader = tryAcquireLock();
    if (iAmLeader) {
      try {
        await signInAnonymously(auth);
        bc?.postMessage("signed-in");
     } finally { releaseLock(); }
    } else {
      // ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ãƒ–å®Œäº†ã‚’æœ€å¤§12ç§’å¾…æ©Ÿ
      const until = Date.now() + 12000;
      while (!auth.currentUser && Date.now() < until) {
        await new Promise(r => setTimeout(r, 200));
      }
      if (!auth.currentUser) { // ä¿é™º
        const got = tryAcquireLock();
        if (got) {
         try {
           await signInAnonymously(auth);
            bc?.postMessage("signed-in");
          } finally { releaseLock(); }
        }
      }
    }
  }

 // ---- presenceï¼ˆåœ¨å¸­ï¼‰ ----
  const EVENT_ID = "your-event-id";
  const TAB_ID   = (crypto?.randomUUID?.() ?? String(Math.random()).slice(2));
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    const myRef = ref(db, `rooms/${EVENT_ID}/presence/${user.uid}/${TAB_ID}`);
    await set(myRef, true);
    onDisconnect(myRef).remove();
    window.CURRENT_UID = user.uid;
  });

  // ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†å…¬é–‹ï¼ˆå€‰åº«ã® runTransaction ç­‰ã§åˆ©ç”¨ï¼‰
  window.firebaseDB = { db, ref, onValue, runTransaction };
  // === ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€æ™‚åœæ­¢ãƒ•ãƒƒã‚¯ ===
(function installGlobalPause(db){
  let paused = false;

  // ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed; inset:0; display:none; z-index:99999;
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    background: rgba(0,0,0,.65); color:#fff;
    font:600 18px/1.4 system-ui,-apple-system,"Noto Sans JP",sans-serif;
    align-items:center; justify-content:center; text-align:center; padding:24px;
  `;
  overlay.innerHTML = `
    <div style="max-width:740px;">
      <div style="font-size:22px; margin-bottom:8px;">ä¸€æ™‚åœæ­¢ä¸­</div>
      <div id="__pauseMsg" style="opacity:.9;"></div>
    </div>`;
  document.body.appendChild(overlay);
  const msgEl = overlay.querySelector('#__pauseMsg');

  // çŠ¶æ…‹è³¼èª­ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ç”»é¢ã§ set ã™ã‚‹ãƒãƒ¼ãƒ‰ï¼‰
  onValue(ref(db, 'game/control/state'), (snap)=>{
    const s = snap.exists()? snap.val(): null;
    paused = !!(s && s.paused);
    if (paused){
      msgEl.textContent = s?.message || 'ã‚ªãƒ¼ãƒŠãƒ¼ãŒä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ';
      overlay.style.display = 'flex';
    }else{
      overlay.style.display = 'none';
    }
  });

  // å…¥åŠ›ã‚’ã¾ã¨ã‚ã¦ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£æ®µéšï¼‰
  const block = (e)=>{ if (paused){ e.stopPropagation(); e.preventDefault(); } };
  ['click','mousedown','mouseup','touchstart','touchend','keydown','keyup','pointerdown','pointerup'].forEach(t=>{
    document.addEventListener(t, block, true);
  });

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã‚¬ãƒ¼ãƒ‰
  window.assertNotPaused = function(){
    if (paused) throw new Error('PAUSED');
  };
})(db);
/* è¿½è¨˜ï¼šã‚¹ãƒ­ãƒƒãƒˆå¹…ã«åã¾ã‚‹ã¾ã§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ä¸‹ã’ã‚‹ */
function fitNoWrapText(textEl, containerEl, opt = {}){
  const maxPx = opt.maxPx ?? 16;   // åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
  const minPx = opt.minPx ?? 10;   // ã“ã“ã¾ã§ä¸‹ã’ã‚‹
  textEl.style.whiteSpace = 'nowrap';
  textEl.style.fontSize = maxPx + 'px';
  // å°‘ã—ä½™ç™½ã‚’è¦‹è¾¼ã‚€
  const maxWidth = Math.max(0, containerEl.clientWidth - 16);
  let s = maxPx;
  // è¨ˆæ¸¬ãƒ«ãƒ¼ãƒ—
  while (s > minPx && textEl.scrollWidth > maxWidth){
    s -= 1;
    textEl.style.fontSize = s + 'px';
  }
}
/* è¿½è¨˜ï¼šæœ€åˆã®ç©ºãã‚¹ãƒ­ãƒƒãƒˆã‚’è¿”ã™ */
function firstEmptySlotIdx(){
  for (let i=0;i<SLOTS;i++){ if (!slots[i]) return i; }
  return -1;
}

/* è¿½è¨˜ï¼šåœ¨åº«â†’ã‚¹ãƒ­ãƒƒãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹å³é…ç½®ï¼‰ */
function quickPutFromInv(name){
  const idx = firstEmptySlotIdx();
  if (idx === -1){ showToast('ç©ºãã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'warn'); return; }
  if (removeFromInv(name,1)){
    slots[idx] = { name };
    renderSlots();
    showToast(`ã€Œ${name}ã€ã‚’å…¥ã‚Œã¾ã—ãŸ`, 'ok', 900);
  }
}

    /* =====================  ãƒãƒ¼ãƒ æ±ºå®š  ===================== */
const teamLabel = document.getElementById('teamLabel');
function getTeamFromURL(){
   const m = location.search.match(/[?&]team=(\d)/);
   return m ? 'team'+m[1] : null;
 }
 // URL > localStorage > team1 ã®å„ªå…ˆé †ã§å›ºå®š
 const TEAM = getTeamFromURL() || localStorage.getItem('selected_team') || 'team1';
 // å¿µã®ãŸã‚ä¿å­˜ï¼ˆURLã§æ¥ã¦ã‚‚ä¿æŒï¼‰
 localStorage.setItem('selected_team', TEAM);
 teamLabel.textContent = TEAM.replace('team','ãƒãƒ¼ãƒ ');

    /* =====================  ãƒ­ãƒ¼ã‚«ãƒ«åœ¨åº«ï¼ˆæ‰‹æŒã¡ï¼‰  ===================== */
// 24h å¤±åŠ¹ã®å®šæ•°ï¼ˆã¾ã ç„¡ã‘ã‚Œã°ï¼‰


function loadInv(){
  try{
    const raw = localStorage.getItem(INV_KEY);
    const obj = raw ? JSON.parse(raw) : null;
    if (obj && obj.version === 2 && obj.byItem && obj.stamps) return obj;
  }catch(_) {}
  // ã“ã“ã«æ¥ã‚‹ã®ã¯ã€Œåˆå› or ãƒ‘ãƒ¼ã‚¸ç›´å¾Œã€â†’ ç©ºã®æ–°ã‚¹ã‚­ãƒ¼ãƒã§é–‹å§‹
  const neo = { version:2, total:0, byItem:{}, stamps:{} };
  localStorage.setItem(INV_KEY, JSON.stringify(neo));
  return neo;
}

let inv = loadInv();

function saveInv(){
  try{ localStorage.setItem(INV_KEY, JSON.stringify(inv)); }catch{}
}

// æœŸé™åˆ‡ã‚Œã‚¢ã‚¤ãƒ†ãƒ ã‚’æƒé™¤ï¼ˆ24hï¼‰
function pruneExpiredInv(){
  if (!inv || inv.version !== 2) return;
  const now = nowMs();
  inv.stamps = inv.stamps || {};
  let deltaTotal = 0;

  for (const name of Object.keys(inv.byItem || {})){
    const qty = inv.byItem[name] | 0;
    let arr = Array.isArray(inv.stamps[name]) ? inv.stamps[name] : [];

    // stampsã¨æ•°é‡ã®æ•´åˆ
    if (arr.length < qty){ arr = arr.concat(Array(qty - arr.length).fill(now)); }
    if (arr.length > qty){ arr = arr.slice(0, qty); }

    // æœŸé™å†…ã ã‘æ®‹ã™
    const keep = arr.filter(t => (now - t) < EXPIRE_MS);
    const removed = arr.length - keep.length;

    if (removed > 0){
      inv.byItem[name] = Math.max(0, qty - removed);
      deltaTotal -= removed;
    }

    if (inv.byItem[name] <= 0){
      delete inv.byItem[name];
      delete inv.stamps[name];
    }else{
      inv.stamps[name] = keep;
    }
  }

  inv.total = Math.max(0, (inv.total | 0) + deltaTotal);
  saveInv();
}

// è¿½åŠ ï¼šå–å¾—æ™‚åˆ»ã‚’è¨˜éŒ²
function addToInv(name, qty=1){
  if (qty <= 0) return;
  inv.version = 2;
  inv.byItem[name] = (inv.byItem[name] || 0) + qty;

  inv.stamps = inv.stamps || {};
  const arr = inv.stamps[name] = inv.stamps[name] || [];
  const t = nowMs();
  for (let i=0;i<qty;i++) arr.push(t);

  inv.total += qty;
  pruneExpiredInv();
  renderInv();
}

// å‰Šé™¤ï¼šå¤ã„ã‚‚ã®ã‹ã‚‰æ¶ˆè²»ï¼ˆå…ˆå…¥ã‚Œå…ˆå‡ºã—ï¼‰
function removeFromInv(name, qty=1){
  if (qty <= 0) return false;
  if (!inv.byItem[name] || inv.byItem[name] < qty) return false;

  inv.byItem[name] -= qty;
  inv.total -= qty;

  if (inv.version === 2){
    inv.stamps = inv.stamps || {};
    const arr = inv.stamps[name] = inv.stamps[name] || [];
    arr.splice(0, Math.min(qty, arr.length)); // FIFO
    if (arr.length === 0) delete inv.stamps[name];
  }

  if (inv.byItem[name] <= 0) delete inv.byItem[name];

  saveInv();
  renderInv();
  return true;
}


    /* =====================  å€‰åº«é›†è¨ˆï¼ˆãƒãƒ¼ãƒ åˆ¥ï¼‰  ===================== */
const warehouseList = document.getElementById('warehouseList');
let warehouseAgg = {}; // ãã®ã¾ã¾ { itemName: count, ... } ã‚’ä¿æŒ


    /* =====================  æ³¨æ–‡ãƒ»ãƒã‚¤ãƒ³ãƒˆ  ===================== */
    const ordersList = document.getElementById('ordersList');
    const ordersMsg  = document.getElementById('ordersMsg');
    const pointsLbl  = document.getElementById('pointsLbl');
    let ordersMap = {}; // id -> order

    /* =====================  èª¿ç†ã‚¹ãƒ­ãƒƒãƒˆ  ===================== */
    const SLOTS = 6;
    const slotsEl = document.getElementById('slots');
    const cookBtn = document.getElementById('cookBtn');
    const clearSlotsBtn = document.getElementById('clearSlotsBtn');
    const cookMsg = document.getElementById('cookMsg');
    const slots = new Array(SLOTS).fill(null); // ä¾‹: [{name:"é­š"} or null]

function initSlots(){
  slotsEl.innerHTML = '';
  for (let i=0;i<SLOTS;i++){
    const s = document.createElement('div');
    s.className = 'slot';
    s.dataset.idx = String(i);
    // ã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã™
    s.addEventListener('click', ()=>{
      if (slots[i]){
        addToInv(slots[i].name,1);
        slots[i] = null;
        renderSlots();
        showToast('ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰æˆ»ã—ã¾ã—ãŸ', 'ok', 900);
      }
    });
    slotsEl.appendChild(s);
  }
  renderSlots();
}
function renderSlots(){
  for (let i=0;i<SLOTS;i++){
    const s = slotsEl.children[i];
    s.classList.toggle('filled', !!slots[i]);
    s.innerHTML = '';
    if (slots[i]){
      const chip = document.createElement('span');
      chip.className = 'chip';
      // åå‰ã‚’åŒ…ã‚€spanã‚’ç”¨æ„ï¼ˆè¨ˆæ¸¬ã®ãŸã‚ï¼‰
      const label = document.createElement('span');
      label.textContent = slots[i].name;
      chip.appendChild(label);

      // Ã—ãƒœã‚¿ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã™ï¼‰
      const x = document.createElement('span');
      x.className='x'; x.textContent='âœ•'; x.title='æ‰‹æŒã¡ã«æˆ»ã™';
      x.addEventListener('click', (e)=>{ 
        e.stopPropagation();
        addToInv(slots[i].name,1); slots[i]=null; renderSlots();
      });
      chip.appendChild(x);

      s.appendChild(chip);

      // æ–‡å­—ãƒ•ã‚£ãƒƒãƒˆï¼ˆæ”¹è¡Œãªã—ã§åã¾ã‚‹ã¾ã§ç¸®å°ï¼‰
      // chip ãŒã‚¹ãƒ­ãƒƒãƒˆå†…ã§å®Ÿã‚µã‚¤ã‚ºã«ãªã£ãŸå¾Œã«å®Ÿè¡Œ
      requestAnimationFrame(()=> fitNoWrapText(label, s, {maxPx:16, minPx:10}));
    }else{
      s.textContent = 'ç´ æ';
    }
  }
}

    function clearSlots(){
      // ã‚¹ãƒ­ãƒƒãƒˆã®ä¸­èº«ã‚’ã™ã¹ã¦æ‰‹æŒã¡ã«è¿”ã™
      for (let i=0;i<SLOTS;i++){
        if (slots[i]) addToInv(slots[i].name,1);
        slots[i]=null;
      }
      renderSlots();
      cookMsg.textContent = '';
    }
    clearSlotsBtn.addEventListener('click', clearSlots);



    /* =====================  èª¿ç†ãƒ­ã‚¸ãƒƒã‚¯  ===================== */
    // ä¸€ç¬ã ã‘å‡ºã™ãƒˆãƒ¼ã‚¹ãƒˆ
let __toastTimer = null;
function showToast(message, type='warn', duration=1400){
  const el = document.getElementById('toast');
  if (!el) return;
  el.textContent = message;
  el.className = `toast ${type} show`;
  if (__toastTimer) clearTimeout(__toastTimer);
  __toastTimer = setTimeout(()=>{ el.classList.remove('show'); }, duration);
}

    function normalize(arr){ return (arr||[]).slice().sort(); }
    function matchDish(materialsArr){
      const use = normalize(materialsArr);
      for (const [dish, def] of Object.entries(DISH_MASTER)){
        const need = normalize(def.materials||[]);
        if (need.length === use.length && need.every((v,i)=> v===use[i])){
          return dish;
        }
      }
      return null;
    }

    cookBtn.addEventListener('click', ()=>{
      try{ assertNotPaused(); }catch(_){ return; }
      cookMsg.textContent = '';
      const mats = slots.filter(Boolean).map(x => x.name);
      if (mats.length === 0){ cookMsg.textContent='ç´ æã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚'; cookMsg.className='msg warn'; return; }

      const dish = matchDish(mats);
if (!dish){
  showToast('ãã®çµ„ã¿åˆã‚ã›ã§ã¯ä½œã‚Œã¾ã›ã‚“', 'warn');
  clearSlots();
  return;
}

      // æˆåŠŸï¼šç´ æã¯æ¶ˆè²»æ¸ˆã¿ï¼ˆã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¦ã„ã‚‹ãŸã‚ï¼‰ã€ã‚¹ãƒ­ãƒƒãƒˆã¯ç©ºã«
      for (let i=0;i<SLOTS;i++) slots[i] = null;
      renderSlots();
      addToInv(dish, 1);
      cookMsg.textContent = `ã€Œ${dish}ã€ã‚’ä½œã‚Šã¾ã—ãŸï¼`; cookMsg.className='msg ok';
    });

    /* =====================  UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæŒã¡ç‰© / å€‰åº« / æ³¨æ–‡ / ãƒã‚¤ãƒ³ãƒˆï¼‰ ===================== */
    const invList = document.getElementById('invList');
function renderInv(){
  const listRoot = document.getElementById('invList');
  if (!listRoot) return;
  listRoot.innerHTML = '';

  const entriesAll = Object.entries(inv.byItem || {}).sort((a,b)=> a[0].localeCompare(b[0],'ja'));
  const q = invQuery;
  const entries = q ? entriesAll.filter(([name]) => name.toLowerCase().includes(q)) : entriesAll;

  for (const [name, qty] of entries){
    const row  = document.createElement('div'); row.className='row'; row.setAttribute('tabindex','0');

    const left = document.createElement('div'); left.className='kv';
    const n    = document.createElement('span'); n.className='name'; n.textContent = name;
    const qv   = document.createElement('span'); qv.className='qty';  qv.textContent = `Ã— ${qty}`;
    left.appendChild(n); left.appendChild(qv);

    const right = document.createElement('div'); right.className='kv';
    const isDish = !!DISH_MASTER[name];

    if (isDish){
      const serve = document.createElement('button'); serve.textContent = 'å‡ºã™';
      serve.addEventListener('click', (e)=>{ e.stopPropagation(); serveDish(name); });
      right.appendChild(serve);
    }else{
      const back = document.createElement('button'); back.textContent = 'å€‰åº«ã¸æˆ»ã™';
      back.addEventListener('click', (e)=>{ e.stopPropagation(); moveToWarehouse(name, 1); });
      right.appendChild(back);
    }

    const del = document.createElement('button');
    del.textContent = 'å‰Šé™¤';
    del.className = 'btn-danger';
    del.title = '1å€‹ã ã‘å‰Šé™¤ï¼ˆAlt+ã‚¯ãƒªãƒƒã‚¯ã§å…¨ã¦å‰Šé™¤ï¼‰';
    del.addEventListener('click', (e)=>{
      e.stopPropagation();
      if (e.altKey){
        const nAll = inv.byItem[name] || 0;
        if (!nAll) return;
        if (confirm(`ã€Œ${name}ã€ã‚’ ${nAll} å€‹ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){
          removeFromInv(name, nAll);
          showToast(`ã€Œ${name}ã€ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã—ãŸ`, 'ok', 1200);
        }
        return;
      }
      if (removeFromInv(name, 1)){
        showToast(`ã€Œ${name}ã€ã‚’1å€‹å‰Šé™¤ã—ã¾ã—ãŸ`, 'ok', 900);
      }else{
        showToast('å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'warn');
      }
    });
    right.appendChild(del);

    row.appendChild(left); row.appendChild(right);

    // è¡Œã‚¯ãƒªãƒƒã‚¯/ã‚­ãƒ¼ã§ã‚¹ãƒ­ãƒƒãƒˆæŠ•å…¥
    row.addEventListener('click', ()=> quickPutFromInv(name));
    row.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); quickPutFromInv(name); }
    });

    listRoot.appendChild(row);
  }

  if (entries.length === 0){
    const empty = document.createElement('div'); empty.className='sub';
    empty.textContent = invQuery ? 'ï¼ˆä¸€è‡´ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰' : 'ï¼ˆä½•ã‚‚æŒã£ã¦ã„ã¾ã›ã‚“ï¼‰';
    listRoot.appendChild(empty);
  }
}

let warehouseQuery = '';
let invQuery = '';
let warehouseCollapsed = false;
let invCollapsed = false;

// å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆèµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘å¼µã‚Œã°OKï¼‰
const whSearch = document.getElementById('whSearch');
const invSearch = document.getElementById('invSearch');
const whToggle = document.getElementById('whToggle');
const invToggle = document.getElementById('invToggle');

if (whSearch){
  whSearch.addEventListener('input', e => {
    warehouseQuery = (e.target.value || '').trim().toLowerCase();
    renderWarehouse();
  });
}
if (invSearch){
  invSearch.addEventListener('input', e => {
    invQuery = (e.target.value || '').trim().toLowerCase();
    renderInv();
  });
}
if (whToggle){
  whToggle.addEventListener('click', ()=>{
    warehouseCollapsed = !warehouseCollapsed;
    document.getElementById('warehouseList').style.display = warehouseCollapsed ? 'none' : 'grid';
    whToggle.textContent = warehouseCollapsed ? 'â–¸' : 'â–¾';
    whToggle.setAttribute('aria-expanded', String(!warehouseCollapsed));
  });
}
if (invToggle){
  invToggle.addEventListener('click', ()=>{
    invCollapsed = !invCollapsed;
    document.getElementById('invList').style.display = invCollapsed ? 'none' : 'grid';
    invToggle.textContent = invCollapsed ? 'â–¸' : 'â–¾';
    invToggle.setAttribute('aria-expanded', String(!invCollapsed));
  });
}
function renderWarehouse(){
  const listRoot = document.getElementById('warehouseList');
  if (!listRoot) return;
  listRoot.innerHTML = '';

  const all = Object.entries(warehouseAgg||{}).filter(([,qty]) => (qty||0) > 0);
  all.sort((a,b)=> a[0].localeCompare(b[0],'ja'));
  const q = warehouseQuery;
  const entries = q ? all.filter(([name]) => name.toLowerCase().includes(q)) : all;

  for (const [name, qty] of entries){
    const row = document.createElement('div'); row.className='row';
    const left = document.createElement('div'); left.className='kv';
    const n = document.createElement('span'); n.className='name'; n.textContent = name;
    const qv = document.createElement('span'); qv.className='qty'; qv.textContent = `Ã— ${qty}`;
    left.appendChild(n); left.appendChild(qv);

    const right = document.createElement('div'); right.className='kv';
    const take = document.createElement('button'); take.textContent='å–ã‚Šå‡ºã™';
    take.disabled = qty <= 0;
    take.addEventListener('click', ()=> takeFromWarehouse(name, 1));
    right.appendChild(take);

    row.appendChild(left); row.appendChild(right);
    listRoot.appendChild(row);
  }

  if (entries.length === 0){
    const empty = document.createElement('div'); empty.className='sub';
    empty.textContent = warehouseQuery ? 'ï¼ˆä¸€è‡´ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰' : 'ï¼ˆå€‰åº«ã¯ç©ºã§ã™ï¼‰';
    listRoot.appendChild(empty);
  }
}

    function renderOrders(){
      ordersList.innerHTML = '';
      const entries = Object.entries(ordersMap).sort((a,b)=> (b[1]?.createdAt||0) - (a[1]?.createdAt||0));
      if (entries.length === 0){
        ordersMsg.textContent = 'ã“ã®ãƒãƒ¼ãƒ ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'; return;
      }
      ordersMsg.textContent = '';
      for (const [id, o] of entries){
        const row = document.createElement('div'); row.className='orders-row';
        const idEl = document.createElement('div'); idEl.textContent = id.slice(-6);
        const st  = document.createElement('div');
        const nm  = document.createElement('div'); nm.innerHTML = `<b>${o?.status?.dish || 'â€”'}</b>`;
        const mats= document.createElement('div'); mats.className='muted'; mats.textContent = (o?.status?.materials||[]).join('ã€') || 'â€”';
        st.appendChild(nm); st.appendChild(mats);
        const ts  = document.createElement('div'); ts.className='muted'; ts.textContent = fmt(o.createdAt||0);
        row.appendChild(idEl); row.appendChild(st); row.appendChild(ts);
        ordersList.appendChild(row);
      }
    }

    /* =====================  å€‰åº«â‡„æŒã¡ç‰©ã®ç§»å‹•  ===================== */
function warehouseRef(){ return ref(db, `warehouse/${TEAM}/byItem`); }


async function takeFromWarehouse(name, qty){
  try{ assertNotPaused(); }catch(_){ return; }
  const res = await runTransaction(ref(db, `warehouse/${TEAM}/byItem/${name}`), (cur)=>{
    cur = cur || 0;
    if (cur < qty) return;              // åœ¨åº«ä¸è¶³ â†’ å–å¼•ä¸­æ­¢ï¼ˆcommitted=falseï¼‰
    const next = cur - qty;
    return next <= 0 ? null : next;     // â˜…å¤‰æ›´ï¼š0ä»¥ä¸‹ã¯ãƒãƒ¼ãƒ‰å‰Šé™¤
  });
  if (res.committed){
    // â˜…å¤‰æ›´ï¼š0ã§ãƒãƒ¼ãƒ‰å‰Šé™¤ã—ãŸå ´åˆã§ã‚‚ committed ã¯ true
    addToInv(name, qty);
  } else {
    showToast('åœ¨åº«ãŒè¶³ã‚Šã¾ã›ã‚“', 'warn');
  }
}

async function moveToWarehouse(name, qty){
  try{ assertNotPaused(); }catch(_){ return; }
  if (!removeFromInv(name, qty)) return; // æ‰‹æŒã¡å´å…ˆè¡Œ
  const res = await runTransaction(ref(db, `warehouse/${TEAM}/byItem/${name}`), (cur)=>{
    cur = cur || 0;
    return cur + qty;           // åŸå­çš„ã«åŠ ç®—
  });
  if (!(res.committed && res.snapshot.exists())){
    // å¤±æ•—ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    addToInv(name, qty);
    showToast('å€‰åº«ã«æˆ»ã›ã¾ã›ã‚“ã§ã—ãŸ', 'err');
  }
}


    /* =====================  æ–™ç†ã®æå‡ºï¼ˆå‡ºã™ï¼‰  ===================== */
    async function serveDish(dish){
      try{ assertNotPaused(); }catch(_){ return; }
      // å¯¾è±¡æ³¨æ–‡ã‚’æ¤œç´¢ï¼ˆæœ€ã‚‚å¤ã„ã‚‚ã®ã‹ã‚‰æ¶ˆã™ï¼‰
      const match = Object.entries(ordersMap).find(([id, o]) => o?.status?.dish === dish);
      if (!match){ alert('ãã®æ–™ç†ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }

      const [orderId] = match;

      // æ‰‹æŒã¡ã«æ–™ç†ãŒã‚ã‚‹ã‹
      if (!inv.byItem[dish] || inv.byItem[dish] <= 0){ alert('æ‰‹æŒã¡ã«ãã®æ–™ç†ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

      try{
        // æ–™ç†ã‚’1ã¤æ¶ˆè²»
        removeFromInv(dish, 1);

        // æ³¨æ–‡ã‚’å‰Šé™¤
        await remove(ref(db, `game/orders/${TEAM}/${orderId}`));

        // ãƒã‚¤ãƒ³ãƒˆ+1ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
        await runTransaction(ref(db, `game/points/${TEAM}`), (cur)=> (cur||0)+1);

        alert('æ³¨æ–‡ã«ã“ãŸãˆã¾ã—ãŸï¼ ãƒã‚¤ãƒ³ãƒˆ+1');
      }catch(e){
        console.error(e);
        alert('æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
        // å¤±æ•—æ™‚ã¯å¿µã®ãŸã‚æˆ»ã™
        addToInv(dish, 1);
      }
    }

    /* =====================  ãƒ‡ãƒ¼ã‚¿è³¼èª­ã®ä»˜ã‘æ›¿ãˆ  ===================== */
    let unsubOrders = null, unsubWarehouse = null, unsubPoints = null;
    function attachDataBindings(){
      // æ—¢å­˜ã®è³¼èª­ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆonValueã¯è§£é™¤APIãŒãªã„ã®ã§äºŒé‡ç™»éŒ²ã‚’é¿ã‘ã‚‹ãŸã‚DOMå´ã®TEAMåˆ‡æ›¿ã§å†æç”»ï¼‰
      // æ³¨æ–‡
      onValue(ref(db, `game/orders/${TEAM}`), (snap)=>{
        ordersMap = snap.exists()? snap.val(): {};
        renderOrders();
      });
      // å€‰åº«
// å€‰åº«
onValue(warehouseRef(), (snap)=>{
  warehouseAgg = snap.exists()? snap.val(): {};
  renderWarehouse();
});

      // ãƒã‚¤ãƒ³ãƒˆ
      onValue(ref(db, `game/points/${TEAM}`), (snap)=>{
        pointsLbl.textContent = String(snap.exists()? snap.val(): 0);
      });
    }

/* =====================  èµ·å‹•  ===================== */
initSlots();
 pruneExpiredInv();    // èµ·å‹•ç›´å¾Œã«ã¾ãšæƒé™¤
 renderInv();
 setInterval(()=>{     // æ”¾ç½®ä¸­ã§ã‚‚è‡ªå‹•ã§æœŸé™åˆ‡ã‚Œã‚’æƒé™¤
   pruneExpiredInv();
   renderInv();
 }, 60 * 1000);
attachDataBindings(); // â† ã“ã‚Œä¸€å›ã ã‘ã§OKã€‚ä»¥é™ TEAM ã¯å›ºå®šã€‚


    // util
    function fmt(ts){ try{ const d=new Date(ts); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` }catch{ return 'â€”' } }
  </script>
</body>
</html>

















