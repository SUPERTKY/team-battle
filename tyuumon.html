<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ³¨æ–‡å¯¾å¿œ | èª¿ç†å ´</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg:#ffffff;
    --card:rgba(255,255,255,0.85);
    --muted:#6b7280;
    --border:rgba(0,0,0,.12);
    --accent:#0ea5e9;
    --ok:#16a34a;
    --warn:#d97706;
    --err:#dc2626;
  }

  *{ box-sizing:border-box }

  html,body{
    margin:0;
    height:100%;
    color:#111827;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Poppins","Noto Sans JP", sans-serif;

    /* ğŸŒŸ èƒŒæ™¯ç”»åƒã‚’ã€Œ1æšã ã‘ã€ã€Œå…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆã€ã€Œæ˜ã‚‹ãå›ºå®šã€ */
    background: #f8fafc url("assets/ryouri.png") center center no-repeat;
    background-size: cover;       /* ç”»é¢ã„ã£ã±ã„ã«æ‹¡å¤§ç¸®å°ã—ã¦è¡¨ç¤º */
    background-attachment: fixed; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚èƒŒæ™¯ã¯å‹•ã‹ãªã„ */
  }

  .wrap{ min-height:100%; padding:16px; display:grid; gap:16px; }

  header{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    background:rgba(255,255,255,0.7);
    border:1px solid var(--border);
    padding:12px 14px;
    border-radius:14px;
    backdrop-filter: blur(8px);
  }

  .team{ display:flex; gap:10px; align-items:center; font-weight:700 }
  .points{ font-weight:700; }

  select,button,input{
    font:600 14px/1.2 system-ui,-apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:#ffffff;
    color:#111827;
  }
  button{ cursor:pointer }
  button:disabled{ opacity:.6; cursor:not-allowed }

  /* ğŸ’¡ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯å¸¸ã«ç¸¦ä¸¦ã³ */
  .grid{ display:grid; grid-template-columns:1fr; gap:16px; }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px;
    padding:12px 12px 14px;
    box-shadow:0 6px 20px rgba(0,0,0,.05);
  }
  .card h2{ margin:0 0 10px; font-size:18px }
  .sub{ color:var(--muted); font-size:12px; margin:4px 0 10px }

  .list{ display:grid; gap:8px; }
  .row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    padding:10px;
    border:1px solid var(--border);
    border-radius:12px;
    background:rgba(255,255,255,0.9);
  }
  .row .name{ font-weight:700 }

  .kv{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .qty{ padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; }
  .muted{ color:var(--muted) }
  .ok{ color:var(--ok) } .err{ color:var(--err) } .warn{ color:var(--warn) }

  .cook{
    display:grid;
    grid-template-columns: repeat(6, minmax(0,1fr));
    gap:10px;
    margin-top:8px;
  }
  .slot{
    height:58px;
    border:1px dashed rgba(0,0,0,.25);
    border-radius:12px;
    display:grid;
    place-items:center;
    background:#fff;
    position:relative;
  }
  .slot.filled{ border-style:solid; }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    background:#f3f4f6;
    border:1px solid var(--border);
    font-weight:700;
  }
  .x{ cursor:pointer; opacity:.9; }
  .toolbar{ display:flex; gap:8px; margin-top:10px; align-items:center; }
  .msg{ margin-top:8px; font-size:13px; min-height:18px }

  .orders-head,.orders-row{
    display:grid;
    grid-template-columns: 120px 1fr 200px;
    gap:10px;
    align-items:center;
    padding:8px 10px;
    border-radius:10px;
  }
  .orders-head{
    background:rgba(255,255,255,0.8);
    font-weight:800;
    border:1px solid var(--border);
  }
  .orders-row{
    border:1px solid var(--border);
    background:rgba(255,255,255,0.9);
    margin-top:6px;
  }

  footer{
    text-align:center;
    color:var(--muted);
    font-size:12px;
    background:rgba(255,255,255,0.6);
    border-radius:10px;
    padding:6px;
  }

  .toast{
    position:fixed;
    left:50%;
    top:16px;
    transform:translateX(-50%) translateY(-8px);
    background:#ffffff;
    border:1px solid var(--border);
    color:#111827;
    padding:10px 14px;
    border-radius:999px;
    box-shadow:0 8px 30px rgba(0,0,0,.08);
    opacity:0;
    pointer-events:none;
    z-index:100000;
    transition:opacity .22s ease, transform .22s ease;
    font:600 14px/1.2 system-ui,-apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
  .toast.warn{ border-color: var(--warn); color: var(--warn); }
  .toast.ok{ border-color: var(--ok); color: var(--ok); }
  .toast.err{ border-color: var(--err); color: var(--err); }

  *{ -webkit-tap-highlight-color: transparent; }
  html,body{ -webkit-user-select:none; user-select:none; }
  button, input, select, textarea { -webkit-user-select:auto; user-select:auto; }
  .drag{ -webkit-user-drag: element; touch-action:none; }
  .chip, .row .name{ white-space: nowrap; overflow: hidden; }
</style>


</head>
<body>
  <div class="wrap">
    <header>
<div class="team">
   <span>ç¾åœ¨ã®ãƒãƒ¼ãƒ ï¼š</span>
   <strong id="teamLabel"></strong>
</div>
      <div class="points">ãƒã‚¤ãƒ³ãƒˆï¼š<span id="pointsLbl">0</span></div>
    </header>

    <div class="grid">
      <!-- å·¦ï¼šå€‰åº«ã¨æŒã¡ç‰© -->
      <div class="card">
        <h2>å€‰åº«ã®é£Ÿæ</h2>
        <div id="warehouseList" class="list"></div>
        <div class="sub">å€‰åº« â‡„ æ‰‹æŒã¡ã«ç§»å‹•ã§ãã¾ã™ã€‚</div>

        <h2 style="margin-top:14px;">è‡ªåˆ†ãŒæŒã£ã¦ã„ã‚‹ã‚‚ã®</h2>
        <div id="invList" class="list"></div>
        <div class="sub">â€» æ–™ç†ã«ã¯ã€Œå‡ºã™ã€ãƒœã‚¿ãƒ³ã€ç´ æã«ã¯ã€Œå€‰åº«ã¸æˆ»ã™ã€ãƒœã‚¿ãƒ³ãŒä»˜ãã¾ã™ã€‚å‰Šé™¤ãƒœã‚¿ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>

      <!-- å³ï¼šèª¿ç† / æ³¨æ–‡ -->
      <div class="card">
        <h2>èª¿ç†</h2>
        <div class="sub">ç´ æã‚’ä¸‹ã®ã‚¹ãƒ­ãƒƒãƒˆã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— â†’ ã€Œæ–™ç†ã™ã‚‹ã€</div>
        <div class="cook" id="slots"></div>
        <div class="toolbar">
          <button id="cookBtn">æ–™ç†ã™ã‚‹</button>
          <button id="clearSlotsBtn">ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="cookMsg" class="msg"></div>

        <h2 style="margin-top:16px;">å—æ³¨ä¸­ï¼ˆã“ã®ãƒãƒ¼ãƒ ï¼‰</h2>
        <div class="orders-head">
          <div>æ³¨æ–‡ID</div><div>æ–™ç†å / ç´ æ</div><div>ä½œæˆæ™‚åˆ»</div>
        </div>
        <div id="ordersList" class="list"></div>
        <div id="ordersMsg" class="msg muted"></div>
      </div>
    </div>

    <footer>ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚¹ãƒ­ãƒƒãƒˆå¤–ã«é›¢ã—ãŸå ´åˆã¯è‡ªå‹•ã§æ‰‹æŒã¡ã«æˆ»ã‚Šã¾ã™ã€‚</footer>
  </div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase, ref, child, get, onValue, push, remove, runTransaction
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    /* =====================  è¨­å®šãƒ»ãƒ¬ã‚·ãƒ”  ===================== */
    // â˜…ã‚ªãƒ¼ãƒŠãƒ¼ç”»é¢ã¨åŒã˜ã«ã—ã¦ãã ã•ã„
    const DISH_MASTER = {
      "ä¾‹": { materials: ["ãƒã‚°ãƒ­","ã‚¹ãƒ©ã‚¤ãƒ ","ãƒˆãƒãƒˆ","ã‚­ãƒ£ãƒ™ãƒ„"] },
      "ç„¼ãé­šå®šé£Ÿ":            { materials: ["é­š","ç±³","å¡©"] },
      "ãƒãƒ¼ãƒ–ã‚¹ãƒ¼ãƒ—":            { materials: ["é‡èœ","ãƒãƒ¼ãƒ–","å¡©","æ°´"] },
      // è¿½åŠ ...
    };

    /* =====================  Firebase  ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyDPe5cSCavq5gHopugdOfQ-9_50cTrqmyk",
      authDomain: "school-178c2.firebaseapp.com",
      databaseURL: "https://school-178c2-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "school-178c2",
      storageBucket: "school-178c2.firebasestorage.app",
      messagingSenderId: "409885673101",
      appId: "1:409885673101:web:25bf0483547e2d470304c4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
  // === ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€æ™‚åœæ­¢ãƒ•ãƒƒã‚¯ ===
(function installGlobalPause(db){
  let paused = false;

  // ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed; inset:0; display:none; z-index:99999;
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    background: rgba(0,0,0,.65); color:#fff;
    font:600 18px/1.4 system-ui,-apple-system,"Noto Sans JP",sans-serif;
    align-items:center; justify-content:center; text-align:center; padding:24px;
  `;
  overlay.innerHTML = `
    <div style="max-width:740px;">
      <div style="font-size:22px; margin-bottom:8px;">ä¸€æ™‚åœæ­¢ä¸­</div>
      <div id="__pauseMsg" style="opacity:.9;"></div>
    </div>`;
  document.body.appendChild(overlay);
  const msgEl = overlay.querySelector('#__pauseMsg');

  // çŠ¶æ…‹è³¼èª­ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ç”»é¢ã§ set ã™ã‚‹ãƒãƒ¼ãƒ‰ï¼‰
  onValue(ref(db, 'game/control/state'), (snap)=>{
    const s = snap.exists()? snap.val(): null;
    paused = !!(s && s.paused);
    if (paused){
      msgEl.textContent = s?.message || 'ã‚ªãƒ¼ãƒŠãƒ¼ãŒä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ';
      overlay.style.display = 'flex';
    }else{
      overlay.style.display = 'none';
    }
  });

  // å…¥åŠ›ã‚’ã¾ã¨ã‚ã¦ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£æ®µéšï¼‰
  const block = (e)=>{ if (paused){ e.stopPropagation(); e.preventDefault(); } };
  ['click','mousedown','mouseup','touchstart','touchend','keydown','keyup','pointerdown','pointerup'].forEach(t=>{
    document.addEventListener(t, block, true);
  });

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã‚¬ãƒ¼ãƒ‰
  window.assertNotPaused = function(){
    if (paused) throw new Error('PAUSED');
  };
})(db);
/* è¿½è¨˜ï¼šã‚¹ãƒ­ãƒƒãƒˆå¹…ã«åã¾ã‚‹ã¾ã§ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ä¸‹ã’ã‚‹ */
function fitNoWrapText(textEl, containerEl, opt = {}){
  const maxPx = opt.maxPx ?? 16;   // åˆæœŸãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
  const minPx = opt.minPx ?? 10;   // ã“ã“ã¾ã§ä¸‹ã’ã‚‹
  textEl.style.whiteSpace = 'nowrap';
  textEl.style.fontSize = maxPx + 'px';
  // å°‘ã—ä½™ç™½ã‚’è¦‹è¾¼ã‚€
  const maxWidth = Math.max(0, containerEl.clientWidth - 16);
  let s = maxPx;
  // è¨ˆæ¸¬ãƒ«ãƒ¼ãƒ—
  while (s > minPx && textEl.scrollWidth > maxWidth){
    s -= 1;
    textEl.style.fontSize = s + 'px';
  }
}
/* è¿½è¨˜ï¼šæœ€åˆã®ç©ºãã‚¹ãƒ­ãƒƒãƒˆã‚’è¿”ã™ */
function firstEmptySlotIdx(){
  for (let i=0;i<SLOTS;i++){ if (!slots[i]) return i; }
  return -1;
}

/* è¿½è¨˜ï¼šåœ¨åº«â†’ã‚¹ãƒ­ãƒƒãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹å³é…ç½®ï¼‰ */
function quickPutFromInv(name){
  const idx = firstEmptySlotIdx();
  if (idx === -1){ showToast('ç©ºãã‚¹ãƒ­ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'warn'); return; }
  if (removeFromInv(name,1)){
    slots[idx] = { name };
    renderSlots();
    showToast(`ã€Œ${name}ã€ã‚’å…¥ã‚Œã¾ã—ãŸ`, 'ok', 900);
  }
}

    /* =====================  ãƒãƒ¼ãƒ æ±ºå®š  ===================== */
const teamLabel = document.getElementById('teamLabel');
function getTeamFromURL(){
   const m = location.search.match(/[?&]team=(\d)/);
   return m ? 'team'+m[1] : null;
 }
 // URL > localStorage > team1 ã®å„ªå…ˆé †ã§å›ºå®š
 const TEAM = getTeamFromURL() || localStorage.getItem('selected_team') || 'team1';
 // å¿µã®ãŸã‚ä¿å­˜ï¼ˆURLã§æ¥ã¦ã‚‚ä¿æŒï¼‰
 localStorage.setItem('selected_team', TEAM);
 teamLabel.textContent = TEAM.replace('team','ãƒãƒ¼ãƒ ');

    /* =====================  ãƒ­ãƒ¼ã‚«ãƒ«åœ¨åº«ï¼ˆæ‰‹æŒã¡ï¼‰  ===================== */
    const INV_KEY = 'inventory_v1'; // æ—¢å­˜ä»•æ§˜ã¨äº’æ›
    function loadInv(){
      try{
        const raw = localStorage.getItem(INV_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        if (!('total' in obj) || !('byItem' in obj)){
          const byItem = obj && typeof obj === 'object' ? obj : {};
          const total = Object.values(byItem).reduce((a,b)=> a+(b||0), 0);
          const neo = { total, byItem }; localStorage.setItem(INV_KEY, JSON.stringify(neo)); return neo;
        }
        return obj;
      }catch{ return { total:0, byItem:{} } }
    }
    let inv = loadInv();
    function saveInv(){ try{ localStorage.setItem(INV_KEY, JSON.stringify(inv)); }catch{} }
    function addToInv(name, qty=1){
      inv.total += qty; inv.byItem[name] = (inv.byItem[name]||0)+qty; if (inv.byItem[name]<=0){ delete inv.byItem[name] }
      saveInv(); renderInv();
    }
    function removeFromInv(name, qty=1){
      if (!inv.byItem[name] || inv.byItem[name] < qty) return false;
      inv.total -= qty; inv.byItem[name] -= qty;
      if (inv.byItem[name] <= 0) delete inv.byItem[name];
      saveInv(); renderInv(); return true;
    }

    /* =====================  å€‰åº«é›†è¨ˆï¼ˆãƒãƒ¼ãƒ åˆ¥ï¼‰  ===================== */
const warehouseList = document.getElementById('warehouseList');
let warehouseAgg = {}; // ãã®ã¾ã¾ { itemName: count, ... } ã‚’ä¿æŒ


    /* =====================  æ³¨æ–‡ãƒ»ãƒã‚¤ãƒ³ãƒˆ  ===================== */
    const ordersList = document.getElementById('ordersList');
    const ordersMsg  = document.getElementById('ordersMsg');
    const pointsLbl  = document.getElementById('pointsLbl');
    let ordersMap = {}; // id -> order

    /* =====================  èª¿ç†ã‚¹ãƒ­ãƒƒãƒˆ  ===================== */
    const SLOTS = 6;
    const slotsEl = document.getElementById('slots');
    const cookBtn = document.getElementById('cookBtn');
    const clearSlotsBtn = document.getElementById('clearSlotsBtn');
    const cookMsg = document.getElementById('cookMsg');
    const slots = new Array(SLOTS).fill(null); // ä¾‹: [{name:"é­š"} or null]

function initSlots(){
  slotsEl.innerHTML = '';
  for (let i=0;i<SLOTS;i++){
    const s = document.createElement('div');
    s.className = 'slot';
    s.dataset.idx = String(i);
    // ã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã™
    s.addEventListener('click', ()=>{
      if (slots[i]){
        addToInv(slots[i].name,1);
        slots[i] = null;
        renderSlots();
        showToast('ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰æˆ»ã—ã¾ã—ãŸ', 'ok', 900);
      }
    });
    slotsEl.appendChild(s);
  }
  renderSlots();
}
function renderSlots(){
  for (let i=0;i<SLOTS;i++){
    const s = slotsEl.children[i];
    s.classList.toggle('filled', !!slots[i]);
    s.innerHTML = '';
    if (slots[i]){
      const chip = document.createElement('span');
      chip.className = 'chip';
      // åå‰ã‚’åŒ…ã‚€spanã‚’ç”¨æ„ï¼ˆè¨ˆæ¸¬ã®ãŸã‚ï¼‰
      const label = document.createElement('span');
      label.textContent = slots[i].name;
      chip.appendChild(label);

      // Ã—ãƒœã‚¿ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æˆ»ã™ï¼‰
      const x = document.createElement('span');
      x.className='x'; x.textContent='âœ•'; x.title='æ‰‹æŒã¡ã«æˆ»ã™';
      x.addEventListener('click', (e)=>{ 
        e.stopPropagation();
        addToInv(slots[i].name,1); slots[i]=null; renderSlots();
      });
      chip.appendChild(x);

      s.appendChild(chip);

      // æ–‡å­—ãƒ•ã‚£ãƒƒãƒˆï¼ˆæ”¹è¡Œãªã—ã§åã¾ã‚‹ã¾ã§ç¸®å°ï¼‰
      // chip ãŒã‚¹ãƒ­ãƒƒãƒˆå†…ã§å®Ÿã‚µã‚¤ã‚ºã«ãªã£ãŸå¾Œã«å®Ÿè¡Œ
      requestAnimationFrame(()=> fitNoWrapText(label, s, {maxPx:16, minPx:10}));
    }else{
      s.textContent = 'ç´ æ';
    }
  }
}

    function clearSlots(){
      // ã‚¹ãƒ­ãƒƒãƒˆã®ä¸­èº«ã‚’ã™ã¹ã¦æ‰‹æŒã¡ã«è¿”ã™
      for (let i=0;i<SLOTS;i++){
        if (slots[i]) addToInv(slots[i].name,1);
        slots[i]=null;
      }
      renderSlots();
      cookMsg.textContent = '';
    }
    clearSlotsBtn.addEventListener('click', clearSlots);



    /* =====================  èª¿ç†ãƒ­ã‚¸ãƒƒã‚¯  ===================== */
    // ä¸€ç¬ã ã‘å‡ºã™ãƒˆãƒ¼ã‚¹ãƒˆ
let __toastTimer = null;
function showToast(message, type='warn', duration=1400){
  const el = document.getElementById('toast');
  if (!el) return;
  el.textContent = message;
  el.className = `toast ${type} show`;
  if (__toastTimer) clearTimeout(__toastTimer);
  __toastTimer = setTimeout(()=>{ el.classList.remove('show'); }, duration);
}

    function normalize(arr){ return (arr||[]).slice().sort(); }
    function matchDish(materialsArr){
      const use = normalize(materialsArr);
      for (const [dish, def] of Object.entries(DISH_MASTER)){
        const need = normalize(def.materials||[]);
        if (need.length === use.length && need.every((v,i)=> v===use[i])){
          return dish;
        }
      }
      return null;
    }

    cookBtn.addEventListener('click', ()=>{
      try{ assertNotPaused(); }catch(_){ return; }
      cookMsg.textContent = '';
      const mats = slots.filter(Boolean).map(x => x.name);
      if (mats.length === 0){ cookMsg.textContent='ç´ æã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚'; cookMsg.className='msg warn'; return; }

      const dish = matchDish(mats);
if (!dish){
  showToast('ãã®çµ„ã¿åˆã‚ã›ã§ã¯ä½œã‚Œã¾ã›ã‚“', 'warn');
  clearSlots();
  return;
}

      // æˆåŠŸï¼šç´ æã¯æ¶ˆè²»æ¸ˆã¿ï¼ˆã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰å–ã‚Šå‡ºã—ã¦ã„ã‚‹ãŸã‚ï¼‰ã€ã‚¹ãƒ­ãƒƒãƒˆã¯ç©ºã«
      for (let i=0;i<SLOTS;i++) slots[i] = null;
      renderSlots();
      addToInv(dish, 1);
      cookMsg.textContent = `ã€Œ${dish}ã€ã‚’ä½œã‚Šã¾ã—ãŸï¼`; cookMsg.className='msg ok';
    });

    /* =====================  UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæŒã¡ç‰© / å€‰åº« / æ³¨æ–‡ / ãƒã‚¤ãƒ³ãƒˆï¼‰ ===================== */
    const invList = document.getElementById('invList');

    function renderInv(){
  invList.innerHTML = '';
  const entries = Object.entries(inv.byItem).sort((a,b)=> a[0].localeCompare(b[0],'ja'));

  for (const [name, qty] of entries){
    const row  = document.createElement('div'); row.className='row';
    row.setAttribute('tabindex','0'); // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œç”¨ï¼ˆEnter/Spaceï¼‰

    const left = document.createElement('div'); left.className='kv';
    const n    = document.createElement('span'); n.className='name'; n.textContent = name; // â† draggableå‰Šé™¤
    const q    = document.createElement('span'); q.className='qty';  q.textContent = `Ã— ${qty}`;
    left.appendChild(n); left.appendChild(q);

    const right = document.createElement('div'); right.className='kv';
    const isDish = !!DISH_MASTER[name];

    if (isDish){
      const serve = document.createElement('button'); serve.textContent = 'å‡ºã™';
      serve.addEventListener('click', (e)=>{ e.stopPropagation(); serveDish(name); });
      right.appendChild(serve);
    }else{
      const back = document.createElement('button'); back.textContent = 'å€‰åº«ã¸æˆ»ã™';
      back.addEventListener('click', (e)=>{ e.stopPropagation(); moveToWarehouse(name, 1); });
      right.appendChild(back);
    }

    row.appendChild(left); row.appendChild(right);

    // è¡Œã‚¯ãƒªãƒƒã‚¯ã§æœ€åˆã®ç©ºãã‚¹ãƒ­ãƒƒãƒˆã¸æŠ•å…¥
    row.addEventListener('click', ()=> quickPutFromInv(name));
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼ˆEnter/Spaceï¼‰ã§ã‚‚æŠ•å…¥
    row.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); quickPutFromInv(name); }
    });

    invList.appendChild(row);
  }

  if (entries.length === 0){
    const empty = document.createElement('div'); empty.className='sub'; empty.textContent='ï¼ˆä½•ã‚‚æŒã£ã¦ã„ã¾ã›ã‚“ï¼‰';
    invList.appendChild(empty);
  }
}


function renderWarehouse(){
  warehouseList.innerHTML = '';
  const entries = Object.entries(warehouseAgg||{}).sort((a,b)=> a[0].localeCompare(b[0],'ja'));
  for (const [name, qty] of entries){
    const row = document.createElement('div'); row.className='row';
    const left = document.createElement('div'); left.className='kv';
    const n = document.createElement('span'); n.className='name'; n.textContent = name;
    const q = document.createElement('span'); q.className='qty'; q.textContent = `Ã— ${qty}`;
    left.appendChild(n); left.appendChild(q);

    const right = document.createElement('div'); right.className='kv';
    const take = document.createElement('button'); take.textContent='å–ã‚Šå‡ºã™';
    take.disabled = qty <= 0;
    take.addEventListener('click', ()=> takeFromWarehouse(name, 1));
    right.appendChild(take);

    row.appendChild(left); row.appendChild(right);
    warehouseList.appendChild(row);
  }
  if (entries.length === 0){
    const empty = document.createElement('div'); empty.className='sub'; empty.textContent='ï¼ˆå€‰åº«ã¯ç©ºã§ã™ï¼‰';
    warehouseList.appendChild(empty);
  }
}


    function renderOrders(){
      ordersList.innerHTML = '';
      const entries = Object.entries(ordersMap).sort((a,b)=> (b[1]?.createdAt||0) - (a[1]?.createdAt||0));
      if (entries.length === 0){
        ordersMsg.textContent = 'ã“ã®ãƒãƒ¼ãƒ ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'; return;
      }
      ordersMsg.textContent = '';
      for (const [id, o] of entries){
        const row = document.createElement('div'); row.className='orders-row';
        const idEl = document.createElement('div'); idEl.textContent = id.slice(-6);
        const st  = document.createElement('div');
        const nm  = document.createElement('div'); nm.innerHTML = `<b>${o?.status?.dish || 'â€”'}</b>`;
        const mats= document.createElement('div'); mats.className='muted'; mats.textContent = (o?.status?.materials||[]).join('ã€') || 'â€”';
        st.appendChild(nm); st.appendChild(mats);
        const ts  = document.createElement('div'); ts.className='muted'; ts.textContent = fmt(o.createdAt||0);
        row.appendChild(idEl); row.appendChild(st); row.appendChild(ts);
        ordersList.appendChild(row);
      }
    }

    /* =====================  å€‰åº«â‡„æŒã¡ç‰©ã®ç§»å‹•  ===================== */
function warehouseRef(){ return ref(db, `warehouse/${TEAM}/byItem`); }


async function takeFromWarehouse(name, qty){
  try{ assertNotPaused(); }catch(_){ return; }
  const res = await runTransaction(ref(db, `warehouse/${TEAM}/byItem/${name}`), (cur)=>{
    cur = cur || 0;
    if (cur < qty) return;      // åœ¨åº«ä¸è¶³ â†’ æœªã‚³ãƒŸãƒƒãƒˆ
    return cur - qty;           // åŸå­çš„ã«æ¸›ç®—
  });
  if (res.committed && res.snapshot.exists()){
    addToInv(name, qty);
  }else{
    showToast('åœ¨åº«ãŒè¶³ã‚Šã¾ã›ã‚“', 'warn');
  }
}

async function moveToWarehouse(name, qty){
  try{ assertNotPaused(); }catch(_){ return; }
  if (!removeFromInv(name, qty)) return; // æ‰‹æŒã¡å´å…ˆè¡Œ
  const res = await runTransaction(ref(db, `warehouse/${TEAM}/byItem/${name}`), (cur)=>{
    cur = cur || 0;
    return cur + qty;           // åŸå­çš„ã«åŠ ç®—
  });
  if (!(res.committed && res.snapshot.exists())){
    // å¤±æ•—ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    addToInv(name, qty);
    showToast('å€‰åº«ã«æˆ»ã›ã¾ã›ã‚“ã§ã—ãŸ', 'err');
  }
}


    /* =====================  æ–™ç†ã®æå‡ºï¼ˆå‡ºã™ï¼‰  ===================== */
    async function serveDish(dish){
      try{ assertNotPaused(); }catch(_){ return; }
      // å¯¾è±¡æ³¨æ–‡ã‚’æ¤œç´¢ï¼ˆæœ€ã‚‚å¤ã„ã‚‚ã®ã‹ã‚‰æ¶ˆã™ï¼‰
      const match = Object.entries(ordersMap).find(([id, o]) => o?.status?.dish === dish);
      if (!match){ alert('ãã®æ–™ç†ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }

      const [orderId] = match;

      // æ‰‹æŒã¡ã«æ–™ç†ãŒã‚ã‚‹ã‹
      if (!inv.byItem[dish] || inv.byItem[dish] <= 0){ alert('æ‰‹æŒã¡ã«ãã®æ–™ç†ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

      try{
        // æ–™ç†ã‚’1ã¤æ¶ˆè²»
        removeFromInv(dish, 1);

        // æ³¨æ–‡ã‚’å‰Šé™¤
        await remove(ref(db, `game/orders/${TEAM}/${orderId}`));

        // ãƒã‚¤ãƒ³ãƒˆ+1ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
        await runTransaction(ref(db, `game/points/${TEAM}`), (cur)=> (cur||0)+1);

        alert('æ³¨æ–‡ã«ã“ãŸãˆã¾ã—ãŸï¼ ãƒã‚¤ãƒ³ãƒˆ+1');
      }catch(e){
        console.error(e);
        alert('æå‡ºã«å¤±æ•—ã—ã¾ã—ãŸ');
        // å¤±æ•—æ™‚ã¯å¿µã®ãŸã‚æˆ»ã™
        addToInv(dish, 1);
      }
    }

    /* =====================  ãƒ‡ãƒ¼ã‚¿è³¼èª­ã®ä»˜ã‘æ›¿ãˆ  ===================== */
    let unsubOrders = null, unsubWarehouse = null, unsubPoints = null;
    function attachDataBindings(){
      // æ—¢å­˜ã®è³¼èª­ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆonValueã¯è§£é™¤APIãŒãªã„ã®ã§äºŒé‡ç™»éŒ²ã‚’é¿ã‘ã‚‹ãŸã‚DOMå´ã®TEAMåˆ‡æ›¿ã§å†æç”»ï¼‰
      // æ³¨æ–‡
      onValue(ref(db, `game/orders/${TEAM}`), (snap)=>{
        ordersMap = snap.exists()? snap.val(): {};
        renderOrders();
      });
      // å€‰åº«
// å€‰åº«
onValue(warehouseRef(), (snap)=>{
  warehouseAgg = snap.exists()? snap.val(): {};
  renderWarehouse();
});

      // ãƒã‚¤ãƒ³ãƒˆ
      onValue(ref(db, `game/points/${TEAM}`), (snap)=>{
        pointsLbl.textContent = String(snap.exists()? snap.val(): 0);
      });
    }

/* =====================  èµ·å‹•  ===================== */
initSlots();
renderInv();
attachDataBindings(); // â† ã“ã‚Œä¸€å›ã ã‘ã§OKã€‚ä»¥é™ TEAM ã¯å›ºå®šã€‚


    // util
    function fmt(ts){ try{ const d=new Date(ts); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}` }catch{ return 'â€”' } }
  </script>
</body>
</html>








