<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>辞書</title>
<style>
  :root{ --bg1:#0f172a; --bg2:#1e293b; --text:#e5e7eb; --muted:#cbd5e1; --btn-bg:#111827; --btn-br:#334155; --btn-hov:#0b1220; --accent:#60a5fa; }
  html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
  header,footer{padding:10px 14px;opacity:.9;text-align:center}
  .stage{display:grid;place-items:center;padding:10px}
  .page{width:100%;max-width:1000px;max-height:80vh;display:grid;place-items:center;border-radius:12px;overflow:hidden;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
  .page img{max-width:100%;max-height:100%;object-fit:contain}
  .controls{display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap;padding:12px;background:rgba(0,0,0,.3)}
  .btn{border:1px solid var(--btn-br);background:var(--btn-bg);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn:hover{background:var(--btn-hov)}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .page-indicator{display:flex;align-items:center;gap:6px;border:1px dashed var(--btn-br);padding:6px 10px;border-radius:10px;cursor:pointer}
  .page-number{font-weight:700;color:var(--accent)}
  .total{opacity:.8}
  .input{width:70px;padding:6px 8px;border-radius:8px;border:1px solid var(--btn-br);background:#0b1220;color:var(--text);text-align:center}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>📘 辞書ビューア</h1>
    <div class="hint">←/→キーで移動・数字クリックでジャンプ・Home/Endで最初/最後・?p=12で直開き</div>
  </header>

  <main class="stage">
    <div class="page"><img id="img" alt="辞書ページ"></div>
  </main>

  <div class="controls">
    <button class="btn" id="firstBtn">«</button>
    <button class="btn" id="prevBtn">‹</button>
    <div class="page-indicator" id="indicator">
      <span id="currentNumber" class="page-number">0</span>/<span id="totalNumber" class="total">...</span>
    </div>
    <button class="btn" id="nextBtn">›</button>
    <button class="btn" id="lastBtn">»</button>
  </div>

  <footer>
    <div class="hint">ファイル名: <code>assets/jisyo/page0.png</code>, <code>page1.png</code>, …</div>
  </footer>
</div>

<script>
const BASE_DIR = "assets/jisyo";
const EXT = "png";
const MAX_DISCOVER = 999;
const PRELOAD_RANGE = 2;

let pages = [];
let current = 0; // page0から
const imgEl = document.getElementById("img");
const currentNumEl = document.getElementById("currentNumber");
const totalNumEl = document.getElementById("totalNumber");

function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function getStartFromURL(){
  const u = new URL(location.href);
  return parseInt(u.searchParams.get("p") || (u.hash.match(/p=(\d+)/)?.[1] ?? "0"), 10) || 0;
}
function setURL(p){
  const u = new URL(location.href);
  u.searchParams.set("p", p);
  history.replaceState(null,"",u);
}
function preloadAround(p){
  for(let d=1; d<=PRELOAD_RANGE; d++){
    [p+d, p-d].forEach(n=>{
      if(n>=0 && n<pages.length){
        const im = new Image();
        im.src = pages[n];
      }
    });
  }
}
function exists(url){
  return new Promise(res=>{
    const t = new Image();
    t.onload=()=>res(true);
    t.onerror=()=>res(false);
    t.src=url+"?v="+Math.random().toString(16).slice(2);
  });
}
async function discover(){
  pages=[];
  for(let i=0;i<=MAX_DISCOVER;i++){
    const url=`${BASE_DIR}/page${i}.${EXT}`;
    const ok=await exists(url);
    if(!ok){ if(pages.length) break; else if(i>0) break; continue; }
    pages.push(url);
  }
  totalNumEl.textContent=String(pages.length?pages.length-1:0);
}
function show(n){
  if(!pages.length)return;
  current=clamp(n,0,pages.length-1);
  imgEl.src=pages[current];
  currentNumEl.textContent=String(current);
  setURL(current);
  updateButtons();
  preloadAround(current);
}
function updateButtons(){
  const atFirst=current===0;
  const atLast=current===pages.length-1;
  document.getElementById("firstBtn").disabled=atFirst;
  document.getElementById("prevBtn").disabled=atFirst;
  document.getElementById("nextBtn").disabled=atLast;
  document.getElementById("lastBtn").disabled=atLast;
}
function enableNumberEdit(){
  const indicator=document.getElementById("indicator");
  indicator.addEventListener("click",()=>{
    if(indicator.querySelector("input"))return;
    const input=document.createElement("input");
    input.type="number";
    input.className="input";
    input.min="0";
    input.max=String(pages.length-1);
    input.value=String(current);
    const curSpan=document.getElementById("currentNumber");
    curSpan.replaceWith(input);
    input.focus();input.select();
    const finalize=(commit)=>{
      const span=document.createElement("span");
      span.id="currentNumber";span.className="page-number";
      let val=current;
      if(commit){
        val=clamp(parseInt(input.value,10)||current,0,pages.length-1);
        span.textContent=String(val);
        input.replaceWith(span);
        show(val);
      }else{span.textContent=String(current);input.replaceWith(span);}
    };
    input.addEventListener("keydown",e=>{
      if(e.key==="Enter"){e.preventDefault();finalize(true);}
      if(e.key==="Escape"){e.preventDefault();finalize(false);}
    });
    input.addEventListener("blur",()=>finalize(true),{once:true});
  });
}
function wireControls(){
  document.getElementById("firstBtn").addEventListener("click",()=>show(0));
  document.getElementById("prevBtn").addEventListener("click",()=>show(current-1));
  document.getElementById("nextBtn").addEventListener("click",()=>show(current+1));
  document.getElementById("lastBtn").addEventListener("click",()=>show(pages.length-1));
  window.addEventListener("keydown",e=>{
    const tag=(e.target&&e.target.tagName)||"";
    if(tag==="INPUT"||tag==="TEXTAREA")return;
    if(e.key==="ArrowLeft"){e.preventDefault();show(current-1);}
    if(e.key==="ArrowRight"){e.preventDefault();show(current+1);}
    if(e.key==="Home"){e.preventDefault();show(0);}
    if(e.key==="End"){e.preventDefault();show(pages.length-1);}
  });
}
(async function init(){
  await discover();
  if(!pages.length){
    document.querySelector(".page").innerHTML='<div style="padding:22px;text-align:center;opacity:.85">画像が見つかりません。<br><code>assets/jisyo/page0.png</code> からの連番を置いてください。</div>';
    return;
  }
  enableNumberEdit();
  wireControls();
  show(getStartFromURL());
})();
</script>
</body>
</html>
