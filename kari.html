<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>最初から6体いるキャラクター</title>
  <style>
    html, body { margin:0; height:100%; }
    .stage{
      position:relative; width:100vw; height:100vh; overflow:hidden;
      background: url("assets/sougen.png") center/cover no-repeat;
    }

    /* 透明な下エリア */
    .bottom-rect{
      position:absolute; left:0; right:0; bottom:0;
      height:44.44vh; background: transparent;
      pointer-events:none; z-index:10;
    }

    /* キャラクターを置くレイヤー */
    .actors-layer{
      position:absolute; left:0; right:0; bottom:0; height:44.44vh;
      pointer-events:none; z-index:20;
    }

    .actor{
      position:absolute; width:144px; height:auto;
      pointer-events:auto; user-select:none; -webkit-user-drag:none;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.35));
      transition: transform 120ms ease;
    }
    .actor:active{ transform:scale(0.96); }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bottom-rect"></div>
    <div class="actors-layer" id="actorsLayer"></div>
  </div>

  <script>
    const FRAME1_SRC = "assets/suraimu1frame.png";
    const FRAME2_SRC = "assets/suraimu2frame.png";

    const MAX_ACTORS = 6;
    const ACTOR_WIDTH = 144;
    const ACTOR_HEIGHT = 144;

    const SPAWN_MIN_MS = 900;
    const SPAWN_MAX_MS = 3000;
    const WALK_FRAME_MS = 200;  // 歩行アニメ切替間隔
    const WALK_SPEED = 60;      // px/s

    const actorsLayer = document.getElementById("actorsLayer");

    let spawnTimerId = null;
    let spawnPaused = false;

    function countActors(){ return actorsLayer.querySelectorAll(".actor").length; }
    function rand(min,max){ return Math.random()*(max-min)+min; }

    function scheduleNextSpawn(){
      if (spawnTimerId !== null || spawnPaused) return;
      const delay = rand(SPAWN_MIN_MS, SPAWN_MAX_MS);
      spawnTimerId = setTimeout(()=>{
        spawnTimerId = null;
        trySpawnAndReschedule();
      }, delay);
    }

    function trySpawnAndReschedule(){
      if (countActors() >= MAX_ACTORS){ spawnPaused=true; return; }
      spawnActor();
      scheduleNextSpawn();
    }

    function spawnActor(){
      if (countActors() >= MAX_ACTORS) return;

      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const x = rand(0,maxX);
      const y = rand(0,maxY);

      const img = document.createElement("img");
      img.src = FRAME1_SRC;
      img.className="actor";
      img.style.left=`${x}px`;
      img.style.top =`${y}px`;

      actorsLayer.appendChild(img);

      // 歩行ループ開始
      scheduleWalk(img);

      // クリックで消す
      img.addEventListener("click", ()=>{
        img.remove();
        if (spawnPaused && countActors()<MAX_ACTORS){
          spawnPaused=false;
          scheduleNextSpawn();
        }
      });

      if (countActors() >= MAX_ACTORS){ spawnPaused=true; }
    }

    function scheduleWalk(img){
      setTimeout(()=>{
        if (!img.isConnected) return;
        walkToRandom(img, ()=>{ scheduleWalk(img); });
      }, rand(1000,4000)); // 1〜4秒休憩後に移動
    }

    function walkToRandom(img, onFinish){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const targetX = rand(0,maxX);
      const targetY = rand(0,maxY);

      const startX = parseFloat(img.style.left);
      const startY = parseFloat(img.style.top);
      const dx = targetX - startX;
      const dy = targetY - startY;
      const distance = Math.hypot(dx,dy);
      const duration = distance / WALK_SPEED * 1000;

      let startTime=null;
      let toggle=false;
      const frameTimer=setInterval(()=>{
        toggle=!toggle;
        img.src = toggle ? FRAME2_SRC : FRAME1_SRC;
      },WALK_FRAME_MS);

      function step(ts){
        if (!startTime) startTime=ts;
        const t=(ts-startTime)/duration;
        if (t>=1){
          img.style.left=`${targetX}px`;
          img.style.top =`${targetY}px`;
          clearInterval(frameTimer);
          img.src=FRAME1_SRC;
          if(onFinish) onFinish();
          return;
        }
        img.style.left=`${startX+dx*t}px`;
        img.style.top =`${startY+dy*t}px`;
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // --- 初期処理 ---
    // 最初から6体スポーン
    for (let i=0;i<MAX_ACTORS;i++){
      spawnActor();
    }
  </script>
</body>
</html>
