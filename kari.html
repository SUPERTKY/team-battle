<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç‹©ã‚Š</title>
  <style>
    /* === Inventory UIï¼ˆTURIã¨åŒã˜è¦‹ãŸç›®ï¼‰ === */
/* === Inventory UIï¼ˆTURIè¦‹ãŸç›®ãƒ»å°‚ç”¨ã‚¯ãƒ©ã‚¹ï¼‰ === */
.inv-hud{
  position:fixed; right:12px; top:12px; z-index:1300; display:flex; gap:8px;
}
.inv-btn{
  background:#0b1c26aa; border:1px solid #7ee0ff66; color:#dff7ff;
  padding:8px 12px; border-radius:10px; backdrop-filter: blur(4px);
  font-weight:600; cursor:pointer;
}
.inv-btn:hover{ background:#0f2a36cc; }

.inv-panel{
  position:fixed; right:12px; top:56px; width:min(420px, calc(100vw - 24px));
  max-height:min(70vh, 520px); overflow:auto; z-index:1250;
  background:#06131bdf; border:1px solid #7ee0ff33; border-radius:12px;
  backdrop-filter: blur(6px); color:#e8fbff; padding:10px 10px 12px;
}
.inv-panel h3{ margin:6px 8px 8px; font-size:16px }
.inv-meta{ margin:0 8px 8px; font-size:12px; opacity:.8 }
.inv-list{ display:grid; grid-template-columns: 1fr auto; gap:6px 10px; padding:6px 8px; }

.inv-row{ display:contents }
.inv-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.inv-qty{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ffffff22 }
.inv-actions{ display:flex; gap:6px; }
.inv-action{
  background:#0b1c26aa; border:1px solid #7ee0ff44; color:#dff7ff;
  padding:4px 8px; border-radius:8px; cursor:pointer;
}
.inv-action:hover{ background:#0f2a36cc; }
.hidden{ display:none !important; }


    /* ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªUI ===== */
.top-controls{
  position:fixed; top:12px; right:12px; z-index:1300; display:flex; gap:8px;
}
.top-controls .btn{
  padding:10px 14px; border-radius:12px; border:1px solid rgba(0,0,0,0.15);
  background:#ffffffcc; backdrop-filter: blur(6px);
  font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  cursor:pointer;
}
.top-controls .btn:active{ transform: translateY(1px); }

.inventory{
  position:fixed; top:60px; right:12px; width:min(90vw, 320px);
  max-height:70vh; overflow:auto; z-index:1250;
  background:#0b1020ee; color:#e5e7eb; border:1px solid rgba(255,255,255,0.12);
  border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,0.45);
  transform: translateX(120%); transition: transform 220ms ease;
}
.inventory.open{ transform: translateX(0); }
.inv-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.08);
  position:sticky; top:0; background:inherit; z-index:1;
}
.inv-list{ padding:10px 12px 14px; }
.inv-item{
  display:grid; grid-template-columns: 1fr auto; align-items:center;
  gap:8px; padding:8px 10px; border-radius:10px;
  background:#0f172ae6; border:1px solid rgba(255,255,255,0.06);
  margin-bottom:8px;
}
.inv-name{ font-weight:700; }
.inv-qty{ font-weight:800; }
.inv-total.pulse{ animation: invpulse 420ms ease; }
@keyframes invpulse{
  0%{ transform:scale(1); }
  40%{ transform:scale(1.15); }
  100%{ transform:scale(1); }
}

    html, body { margin:0; height:100%; }
    .stage{
      position:relative; width:100vw; height:100vh; overflow:hidden;
      background: url("assets/sougen.png") center/cover no-repeat;
    }

    /* é€æ˜ã®ç§»å‹•ç¯„å›²ï¼ˆä¸‹ 9åˆ†ã®4ï¼‰ */
    .bottom-rect{
      position:absolute; left:0; right:0; bottom:0;
      height:44.44vh; background: transparent;
      pointer-events:none; z-index:10;
    }

    /* ã‚­ãƒ£ãƒ©ãƒ¬ã‚¤ãƒ¤ï¼ˆç§»å‹•ç¯„å›²ã¨åŒã‚µã‚¤ã‚ºï¼‰ */
    .actors-layer{
      position:absolute; left:0; right:0; bottom:0; height:44.44vh;
      pointer-events:none; z-index:20;
    }

    .actor{
      position:absolute; width:144px; height:auto;
      pointer-events:auto; user-select:none; -webkit-user-drag:none;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.35));
      transition: transform 120ms ease, filter 80ms ease;
      will-change: left, top, transform, filter;
    }
    .actor:active{ transform:scale(0.96); }

    /* ä¸‹ã«ã„ã‚‹ã»ã©æ‰‹å‰ï¼ˆz-index ã¯JSã§æ›´æ–°ï¼‰ */

    /* æ¶ˆãˆæ–¹ï¼šè‡ªç„¶ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‹ç¸®å° */
    @keyframes vanish {
      0%   { opacity:1; transform: translateY(0)   scale(1)    }
      60%  { opacity:.6; transform: translateY(6px) scale(.9)  }
      100% { opacity:0; transform: translateY(12px) scale(.75) }
    }
    .vanish { animation: vanish 380ms ease forwards; }

    /* è¢«å¼¾ï¼ˆèµ¤ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ */
    .actor.hurt{
      filter:
        drop-shadow(0 4px 8px rgba(0,0,0,0.35))
        grayscale(1) sepia(1) saturate(8000%) hue-rotate(-8deg)
        brightness(1.15) contrast(1.1);
    }

    /* ===== ãƒãƒˆãƒ«HUDï¼ˆæŠ¼ã—åˆã„ã‚²ãƒ¼ã‚¸ï¼šé’vsèµ¤ï¼‰ ===== */
    .hud-mask{
      position:fixed; inset:0; background: rgba(0,0,0,0.3);
      display:none; align-items:center; justify-content:center;
      z-index:1000; backdrop-filter: blur(2px);
    }
    .hud{
      width:min(92vw, 720px); background:#0b1020ee; color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.12); border-radius:14px;
      box-shadow:0 20px 50px rgba(0,0,0,0.45);
      padding:16px 18px 20px; user-select:none;
      font:600 14px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    .hud-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; font-weight:700; }
    .vs-row{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; opacity:.9; }

    .gauge{ position:relative; height:28px; border-radius:999px; overflow:hidden;
      background:#0a0f1a; border:1px solid #ffffff14; }

    .gauge .divider{
      position:absolute; top:0; bottom:0; width:2px; left:50%;
      background: #ffffff33; box-shadow: 0 0 10px #ffffff55;
      transition: left 40ms linear;
    }
    .tap-hint{ margin-top:8px; text-align:center; font-size:12px; opacity:.85; }
    .enemy-throb{ animation: throb 140ms ease; }
    @keyframes throb{
      0%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
      50%{ box-shadow: inset 0 0 28px 0 rgba(255,255,255,0.15);}
      100%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
    }

    /* ===== ãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤ºï¼ˆé£Ÿæï¼‰ ===== */
    .loot{
      position:absolute; padding:6px 10px; border-radius:12px;
      background:#111827e6; color:#fff; font:700 12px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      border:1px solid rgba(255,255,255,0.1); pointer-events:none;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,0.45));
      animation: loot-pop 1100ms ease forwards;
      z-index: 2000;
    }
    @keyframes loot-pop{
      0%   { transform: translateY(0) scale(.9); opacity:0 }
      15%  { transform: translateY(-8px) scale(1.02); opacity:1 }
      70%  { transform: translateY(-16px) scale(1); opacity:1 }
      100% { transform: translateY(-26px) scale(.98); opacity:0 }
    }

    /* â€œã‚­ãƒ£ãƒ©ã‚’ã‚²ãƒƒãƒˆï¼â€ ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆéãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */
    .toast{
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      background:#111827e6; color:#fff; padding:10px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12); z-index:1200;
      font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      animation: toast-in 300ms ease, toast-out 300ms ease 1400ms forwards;
    }
    @keyframes toast-in{ from{opacity:0; transform:translate(-50%,-6px)} to{opacity:1; transform:translate(-50%,0)} }
    @keyframes toast-out{ to{ opacity:0; transform:translate(-50%,-8px) } }
    /* ===== ã‚²ãƒƒãƒˆå ±å‘Šãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆå·¦ä¸‹ã‚¹ã‚¿ãƒƒã‚¯ï¼‰ ===== */
.loot-feed{
  position:fixed; left:12px; bottom:12px; z-index:2400;
  display:flex; flex-direction:column-reverse; /* ä¸‹ã«è¿½åŠ â†’ä¸Šã«ç©ã‚€ */
  gap:8px; pointer-events:none; /* ã‚¯ãƒªãƒƒã‚¯è²«é€š */
}

/* å€‹åˆ¥ã‚«ãƒ¼ãƒ‰ */
.loot-card{
  min-width: 220px;
  max-width: min(60vw, 360px);
  padding:10px 12px; border-radius:12px;
  background:#0e1320f2; color:#eaf6ff;
  border:1px solid rgba(126,224,255,0.18);
  box-shadow: 0 10px 26px rgba(0,0,0,0.45);
  font:700 13px/1.25 system-ui,-apple-system,"Noto Sans JP",sans-serif;
  transform-origin: bottom left;
  animation: loot-in 220ms ease-out;
}

/* å°ã•ãªè£œåŠ©æƒ…å ±ï¼ˆæ™‚åˆ»ãªã©ï¼‰ */
.loot-meta{ font-weight:600; opacity:.7; font-size:11px; margin-top:4px }

/* è¡¨ç¤ºâ†’é€€å ´ */
@keyframes loot-in{
  from{ opacity:0; transform: translateY(6px) scale(.98) }
  to  { opacity:1; transform: translateY(0)   scale(1) }
}
.loot-card.fade-out{
  animation: loot-out 260ms ease forwards;
}
@keyframes loot-out{
  to{ opacity:0; transform: translateY(8px) scale(.98) }
}
/* æ—§ .gauge .blue / .gauge .red ã¯å‰Šé™¤OK */

.gauge{
  position:relative; height:28px; border-radius:999px; overflow:hidden;
  /* èµ¤å´ã‚’å¸¸ã«å…¨é¢ã«è¡¨ç¤ºï¼ˆæ®‹ã‚ŠãŒèµ¤ã«è¦‹ãˆã‚‹ï¼‰ */
  background: linear-gradient(90deg,#ef4444,#f97316);
  border:1px solid #ffffff14;
}


.gauge .bar{
  position:absolute; left:0; top:0; bottom:0; width:100%;
  transform-origin:left center;
  transform: scaleX(0.5);                 /* p=50% åˆæœŸ */
  background: linear-gradient(90deg,#38bdf8,#22c55e);
  will-change: transform;                  /* GPUã«å¯„ã›ã‚‹ */
}
.gauge .divider{
  position:absolute; top:0; bottom:0; width:2px; left:50%;
  transform: translateX(0);                /* rAFã§å‹•ã‹ã™ */
  background:#ffffff33;
  box-shadow:none;                         /* å½±é‡ã„ã®ã§è»½ã */
  will-change: transform;
}
/* é€ƒèµ°ï¼ˆè§¦ã‚Œãªããªã£ã¦ä¸€ç¬ã§ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³â†’æ¶ˆæ»…ï¼‰ */
@keyframes flee {
  0%   { opacity:0; transform: translateY(0)   scale(1) }
  40%  { opacity:1; transform: translateY(-4px) scale(1.02) }
  100% { opacity:0; transform: translateY(-10px) scale(.98) }
}
.escape { animation: flee 320ms ease forwards; pointer-events:none !important; }

  </style>
</head>
<body>
  <div class="stage">
    <div class="bottom-rect"></div>
    <div class="actors-layer" id="actorsLayer"></div>
  </div>

  <!-- ãƒãƒˆãƒ«HUD -->
  <div class="hud-mask" id="hudMask">
    <div class="hud" id="hud">
      <div class="hud-title">
        <span>ãƒãƒˆãƒ«ä¸­â€¦é€£æ‰“ã§å‰ç·šã‚’æŠ¼ã—ä¸Šã’ã‚ï¼</span>
        <span id="timerLbl"></span>
      </div>
      <div class="vs-row">
        <span>ã‚ãªãŸï¼ˆé’ï¼‰</span><span>VS</span><span id="enemyNameLbl">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼ˆèµ¤ï¼‰</span>
      </div>
<div class="gauge" id="gauge">
  <div class="bar" id="blueBar"></div>
  <div class="divider" id="divider"></div>
</div>
      <div class="tap-hint">ã“ã®ãƒ‘ãƒãƒ«ã‚’é€£æ‰“ï¼ æŠ¼ã—åˆ‡ã‚Œã°å‹ã¡ï¼ˆæ’ƒç ´ã¨åŒæ™‚ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰</div>
    </div>
  </div>
  <!-- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªé–‹é–‰ãƒœã‚¿ãƒ³ -->
<div id="invPanel" class="inv-panel hidden">
  <h3>ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3>
  <div class="meta" id="invMeta">åˆè¨ˆ 0 å€‹</div>
  <div class="list" id="invList"></div>
</div>
<div class="inv-hud">
   <button id="invBtn" class="inv-btn">ğŸº ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</button>
 </div>
<!-- ã‚²ãƒƒãƒˆå ±å‘Šãƒ•ã‚£ãƒ¼ãƒ‰ï¼ˆå·¦ä¸‹ï¼‰ -->
<div id="lootFeed" class="loot-feed" aria-live="polite"></div>

  <script>
    // === å…±é€š TEAM è§£æ±ºï¼ˆ?team=2 ãªã© â†’ localStorage â†’ æ—¢å®š 'team1'ï¼‰ ===
const TEAM = (() => {
  const m = location.search.match(/[?&]team=(\d+)/);
  const t = m ? `team${m[1]}` : (localStorage.getItem('selected_team') || 'team1');
  localStorage.setItem('selected_team', t); // ä»–ãƒšãƒ¼ã‚¸ï¼ˆèª¿ç†å ´ãªã©ï¼‰ã¨å…±æœ‰
  return t;
})();

    // ===== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å®šç¾©ï¼ˆã“ã“ã«ç¨®é¡ã‚’å¢—ã‚„ã›ã‚‹ï¼‰ =====
    const MONSTERS = [

        {
    id: "flame_wolf",
    name: "ãƒ•ãƒ¬ã‚¤ãƒ ã‚¦ãƒ«ãƒ•",
    strength: 3.0,
          frames: ["assets/teki/hureimuuruhu1frame.png", "assets/teki/hureimuuruhu2frame.png"],
    drops: ["ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹","ãƒ•ãƒ¬ã‚¤ãƒ ãƒ¡ãƒ³ãƒ–ãƒ¬ãƒ³"]
          
  },

 {
    id: "shadow_bat",
    name: "ã‚·ãƒ£ãƒ‰ã‚¦ãƒãƒƒãƒˆ",
    strength: 2.5,
   frames: ["assets/teki/syadoubatto1frame.png", "assets/teki/syadoubaddo2frame.png"],
    drops: ["ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ãƒ«ãƒ¼ãƒ„","ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼"]
   
  },
{
    id: "giant_beetle",
    name: "ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆãƒ“ãƒ¼ãƒˆãƒ«",
    strength: 3.5,
   frames: ["assets/teki/zyainantbi-toru1frame.png", "assets/teki/zyaiantbi-toru2frame.png"],
    drops: ["ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼","ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„"]
  },
{
    id: "moon_spirit",
    name: "ãƒ ãƒ¼ãƒ³ã‚¹ãƒ”ãƒªãƒƒãƒˆ",
    strength: 4.0,
   frames: ["assets/teki/mu-nsupiritto1frame.png", "assets/teki/mu-nsupiritto1frame.png"],
    drops: ["ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼","ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹"]
  },
{
    id: "glow_worm",
    name: "ã‚°ãƒ­ã‚¦ãƒ¯ãƒ¼ãƒ ",
    strength: 1.5,
   frames: ["assets/teki/gurouwa-mu1frame.png", "assets/teki/gurouwa-mu2frame.png"],
    drops: ["ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«","ãƒ©ã‚¤ãƒˆãƒ€ã‚¹ãƒˆ"]
  },
 {
    id: "abyss_dragon",
    name: "ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³",
    strength: 5.0,
    frames: ["assets/teki/abisudoragon1frame.png", "assets/teki/abisudoragon2frame.png"],
    drops: ["ãƒ‰ãƒ©ã‚´ãƒ³ãƒŸãƒ¼ãƒˆ","ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°"]
  }

    ];

    // ===== èª¿æ•´ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ =====
    const MAX_ACTORS = 6;
    const ACTOR_WIDTH = 144, ACTOR_HEIGHT = 144;
    const WALK_FRAME_MS = 200, WALK_SPEED = 60;

    // ãƒãƒˆãƒ«é›£æ˜“åº¦ï¼ˆåŸºæº–å€¤ãƒ»ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å¼·ã•ã§ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    const PLAYER_PUSH = 3.2;      // ã‚¯ãƒªãƒƒã‚¯1å›ã§å³ã¸ä½•ï¼…é€²ã‚€ã‹
    const ENEMY_BASE_PER_SEC = 0.35; // æ•µã®å¸¸æ™‚æŠ¼ã—ï¼ˆï¼…/ç§’ï¼‰
    const ENEMY_BURST_POW   = 1.2;   // æ•µã®ãƒãƒ¼ã‚¹ãƒˆ1å›ã®æŠ¼ã—é‡ï¼ˆï¼…ï¼‰
    const BURST_MIN_MS = 340, BURST_MAX_MS = 620;
// rAFç”¨ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
let rafId = null;
let enemyLastBurst = 0;

    // ===== è¦ç´  =====
    const actorsLayer = document.getElementById("actorsLayer");
    const hudMask = document.getElementById("hudMask");
    const hud = document.getElementById("hud");
// ç½®ãæ›ãˆï¼šblueFill / redFill ã¯ä½¿ã‚ãªã„
const gaugeEl  = document.getElementById("gauge");
const blueBar  = document.getElementById("blueBar");
const divider  = document.getElementById("divider");


 
    const enemyNameLbl = document.getElementById("enemyNameLbl");
// ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª =====
// ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªï¼ˆTURIè¦‹ãŸç›®ï¼‰ =====
// === Inventory v2: 24h expire / FIFO ===
const INV_KEY = 'inventory_hunt_v1';  // æ—¢å­˜ã‚­ãƒ¼ã‚’ç¶™ç¶šåˆ©ç”¨ï¼ˆä¸­èº«ã®ã¿é€²åŒ–ï¼‰
const EXPIRE_MS = 24 * 60 * 60 * 1000; // 24æ™‚é–“
const nowMs = () => Date.now();

// â€» åˆå›ãƒ‘ãƒ¼ã‚¸ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFFï¼ˆå¿…è¦ãªã‚‰ true ã«ï¼‰
const ENABLE_FIRST_PURGE = false;
const PURGE_FLAG_KEY = 'inventory_hunt_purge_2025_11_04';
if (ENABLE_FIRST_PURGE && !localStorage.getItem(PURGE_FLAG_KEY)) {
  try { localStorage.removeItem(INV_KEY); } catch {}
  localStorage.setItem(PURGE_FLAG_KEY, '1');
}

// ä¿æŒå½¢å¼ï¼š{ total:number, byItem:{ [name]: qty } }
let inv = loadInv();

const invPanel = document.getElementById('invPanel');
const invBtn   = document.getElementById('invBtn');
const invMeta  = document.getElementById('invMeta');
const invList  = document.getElementById('invList');
// ===== ã‚²ãƒƒãƒˆå ±å‘Šãƒ•ã‚£ãƒ¼ãƒ‰ =====
const lootFeedRoot = document.getElementById('lootFeed');
const LOOT_MAX = 8;          // æœ€å¤§è¡¨ç¤ºæ•°
const LOOT_LIFETIME = 5200;  // è‡ªå‹•æ¶ˆå»ã¾ã§ã®æ™‚é–“(ms)

function pushGetReport(text){
  if(!lootFeedRoot) return;

  // è¦ç´ ç”Ÿæˆ
  const card = document.createElement('div');
  card.className = 'loot-card';
  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');

  card.innerHTML = `
    <div class="loot-text">${text}</div>
    <div class="loot-meta">${hh}:${mm}</div>
  `;

  // è¿½åŠ ï¼ˆä¸‹å´ã«å·®ã—è¾¼ã¾ã‚Œã‚‹ï¼ä¸Šã«ç©ã¾ã‚Œã‚‹ï¼‰
  lootFeedRoot.appendChild(card);

  // ä¸Šé™è¶…é â†’ ã„ã¡ã°ã‚“ä¸‹ï¼ˆï¼æœ€å¤ï¼‰ã‚’å‰Šé™¤
  while(lootFeedRoot.children.length > LOOT_MAX){
    const oldest = lootFeedRoot.firstElementChild; // column-reverseãªã®ã§æœ€å¤ãŒ"first"
    if (oldest){
      oldest.classList.add('fade-out');
      setTimeout(()=> oldest.remove(), 260);
    }
  }

  // è‡ªå‹•æ¶ˆå»
  setTimeout(()=>{
    if (!card.isConnected) return;
    card.classList.add('fade-out');
    setTimeout(()=> card.remove(), 260);
  }, LOOT_LIFETIME);
}
    function pruneExpiredInv(){
  if (!inv || inv.version !== 2) return;
  const now = nowMs();
  inv.stamps = inv.stamps || {};

  for (const name of Object.keys(inv.byItem)){
    const qty = inv.byItem[name] | 0;
    let arr = Array.isArray(inv.stamps[name]) ? inv.stamps[name] : [];
    // stampsã¨æ•°é‡ã®æ•´åˆ
    if (arr.length < qty) arr = arr.concat(Array(qty - arr.length).fill(now));
    if (arr.length > qty) arr = arr.slice(0, qty);

    // 24hè¶…ã¯å‰Šé™¤
    const keep = arr.filter(t => (now - t) < EXPIRE_MS);
    const removed = arr.length - keep.length;
    if (removed > 0) inv.byItem[name] = Math.max(0, qty - removed);

    if ((inv.byItem[name] | 0) <= 0){
      delete inv.byItem[name];
      delete inv.stamps[name];
    }else{
      inv.stamps[name] = keep;
    }
  }

  inv.total = Object.values(inv.byItem).reduce((a,b)=>a+(b||0),0);
  saveInv();
}

// æ•µã®æŠ¼ã—ã‚’ rAF ã§å›ã™ï¼ˆæ–°è¦è¿½åŠ ï¼‰
function startEnemyLoop(enemyBasePerSec, burstPow){
  cancelAnimationFrame(rafId);
  let last = performance.now();
  enemyLastBurst = last;

  const loop = (now)=>{
    if (!battleActive) return;

    // çµŒéæ™‚é–“(ç§’)ã‚’ç®—å‡ºï¼ˆdtã«ä¸Šé™ã‚’ã‹ã‘ã¦æš´èµ°é˜²æ­¢ï¼‰
    const dt = Math.min(0.05, (now - last) / 1000);
    last = now;

    // å¸¸æ™‚æŠ¼ã—ï¼ˆç§’é–“ï¼… â†’ ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†ï¼‰
    p -= enemyBasePerSec * dt;

    // ãƒãƒ¼ã‚¹ãƒˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ é–“éš”ï¼‰
    if (now - enemyLastBurst > rand(BURST_MIN_MS, BURST_MAX_MS)){
      p -= burstPow;
      enemyLastBurst = now;

      // è»½é‡ãªæ¼”å‡ºãƒˆã‚°ãƒ«
      gaugeEl.classList.remove("enemy-throb");
      void gaugeEl.offsetWidth; // reflowã§å†é©ç”¨
      gaugeEl.classList.add("enemy-throb");
    }

    if (p <= 0){
      renderGauge();
      endBattle(false); // æ•—åŒ—
      return;
    }

    renderGauge();
    rafId = requestAnimationFrame(loop);
  };

  rafId = requestAnimationFrame(loop);
}

function loadInv(){
  try{
    const raw = localStorage.getItem(INV_KEY);
    const obj = raw ? JSON.parse(raw) : null;
    // v2 ã‚¹ã‚­ãƒ¼ãƒãªã‚‰ãã®ã¾ã¾
    if (obj && obj.version === 2 && obj.byItem && obj.stamps) return obj;

    // æ—§ã‚¹ã‚­ãƒ¼ãƒ { total, byItem } ã‚’è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    const old = obj && typeof obj === 'object' ? obj : { total:0, byItem:{} };
    const neo = { version:2, total:0, byItem:{}, stamps:{} };
    for (const [name, qty] of Object.entries(old.byItem || {})){
      if (!qty) continue;
      neo.byItem[name] = qty;
      neo.stamps[name] = Array(qty).fill(nowMs()); // å…¨ã¦â€œä»Šâ€å…¥æ‰‹ã—ãŸæ‰±ã„
      neo.total += qty;
    }
    localStorage.setItem(INV_KEY, JSON.stringify(neo));
    return neo;
  }catch(_){
    return { version:2, total:0, byItem:{}, stamps:{} };
  }
}
function saveInv(){
  try{ localStorage.setItem(INV_KEY, JSON.stringify(inv)); }catch{}
}

function saveInv(){ try{ localStorage.setItem(INV_KEY, JSON.stringify(inv)); }catch(_){} }

// æ—¢å­˜ã® dropLoot ã‹ã‚‰å‘¼ã°ã‚Œã‚‹æƒ³å®š
function addToInventory(name, qty=1){
  if (qty <= 0) return;
  inv.version = 2;
  inv.byItem[name] = (inv.byItem[name] || 0) + qty;

  inv.stamps = inv.stamps || {};
  const arr = inv.stamps[name] = inv.stamps[name] || [];
  const t = nowMs();
  for (let i=0;i<qty;i++) arr.push(t);

  inv.total = Object.values(inv.byItem).reduce((a,b)=>a+(b||0),0);

  pruneExpiredInv();
  renderInventory();
  pushGetReport?.(`+${qty} ${name}`);
}
function consumeFromInventory(name, qty=1){
  if (qty <= 0) return false;
  if (!inv.byItem[name] || inv.byItem[name] < qty) return false;

  inv.byItem[name] -= qty;

  // FIFOã§ã‚¹ã‚¿ãƒ³ãƒ—å‰Šé™¤
  inv.stamps = inv.stamps || {};
  const arr = inv.stamps[name] = inv.stamps[name] || [];
  arr.splice(0, Math.min(qty, arr.length));
  if (arr.length) inv.stamps[name] = arr; else delete inv.stamps[name];

  if (inv.byItem[name] <= 0) delete inv.byItem[name];

  inv.total = Object.values(inv.byItem).reduce((a,b)=>a+(b||0),0);
  saveInv();
  renderInventory();
  return true;
}

function renderInventory(){
  if(!invMeta || !invList) return;
  invMeta.textContent = `åˆè¨ˆ ${inv.total} å€‹`;

  const entries = Object.entries(inv.byItem).sort((a,b)=> a[0].localeCompare(b[0],'ja'));
  invList.innerHTML = '';

  for (const [name, count] of entries){
    // å·¦åˆ—ï¼šåå‰
    const nameCell = document.createElement('div');
    nameCell.className = 'inv-row inv-name';
    nameCell.textContent = name;

    // å³åˆ—ï¼šæ•°é‡ï¼‹æ“ä½œ
    const actionCell = document.createElement('div');
    actionCell.className = 'inv-row inv-actions';
    actionCell.innerHTML = `
   <span class="inv-qty">Ã— ${count}</span>
   <button class="btnStore inv-action">å€‰åº«</button>
   <button class="btnDrop inv-action">æ¨ã¦ã‚‹</button>
 `;

    // å€‰åº«ï¼ˆFirebase ãŒã‚ã‚Œã°ä¿å­˜ï¼‰
// å€‰åº«
const btnStore = actionCell.querySelector('.btnStore');
btnStore.addEventListener('click', async (e)=>{
  const btn = e.currentTarget;
  if (btn.dataset.busy === '1') return;
  btn.dataset.busy = '1';
  try{
    const api = window.firebaseDB;
    if(!api) throw new Error('no-firebase');
    try{ assertNotPaused(); }catch(_){ btn.dataset.busy=''; return; }
    const { db, ref, runTransaction } = api;
    const node = ref(db, `warehouse/${TEAM}/byItem/${name}`);
    await runTransaction(node, cur => (cur || 0) + 1);

    if (consumeFromInventory(name, 1)){
      showToast?.(`${name} ã‚’å€‰åº«ã«ã—ã¾ã„ã¾ã—ãŸ`);
    }
  }catch(_){
    showToast?.('å€‰åº«ã«ã—ã¾ã†ã«ã¯ Firebase ã®è¨­å®šãŒå¿…è¦ã§ã™');
  }finally{
    btn.dataset.busy = '';
  }
});

// æ¨ã¦ã‚‹
actionCell.querySelector('.btnDrop').addEventListener('click', ()=>{
  if (consumeFromInventory(name, 1)){
    showToast?.(`${name} ã‚’æ¨ã¦ã¾ã—ãŸ`);
  }
});


    invList.appendChild(nameCell);
    invList.appendChild(actionCell);
  }
}

// é–‹é–‰
invBtn?.addEventListener('click', ()=>{
  invPanel.classList.toggle('hidden');
});

// åˆæœŸæç”»
// åˆæœŸæç”»
renderInventory();
pruneExpiredInv(); // èµ·å‹•ç›´å¾Œã«æƒé™¤
setInterval(()=>{ pruneExpiredInv(); renderInventory(); }, 60 * 1000); // æ¯åˆ†


    // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function rand(min,max){ return Math.random()*(max-min)+min; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

    // ä¸‹ã«ã„ã‚‹ã»ã©å‰é¢
    function updateDepth(img){
      const y = parseFloat(img.style.top) || 0;
      img.style.zIndex = String(1000 + Math.floor(y));
    }

    function flashHurt(img){
      if (!img || !img.isConnected) return;
      img.classList.add("hurt");
      setTimeout(()=> img.classList.remove("hurt"), 120);
    }

    function showToast(text){
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1800);
    }

    // ===== ã‚¹ãƒãƒ¼ãƒ³ï¼†æ­©è¡Œ =====
    function spawnActor(){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);
      const x = rand(0,maxX), y = rand(0,maxY);

      const monster = pick(MONSTERS);
      const img = new Image();
      img.src = monster.frames[0];
      img.className="actor";
      img.style.left=`${x}px`; img.style.top =`${y}px`;
      img.style.transform = "scaleX(1)";
      // å‚ç…§ã‚’æŒãŸã›ã‚‹ï¼ˆç¨®é¡ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»å¼·ã•ãƒ»ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
      img.__mon = monster;

      actorsLayer.appendChild(img);
      updateDepth(img);

      // æ­©è¡Œãƒ«ãƒ¼ãƒ—é–‹å§‹
      scheduleWalk(img);
scheduleEscape(img);   // â† è¿½åŠ ï¼šå¯¿å‘½ãŒæ¥ãŸã‚‰é€ƒèµ°ã•ã›ã‚‹

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒˆãƒ«
img.addEventListener("click", (e)=>{
  e.stopPropagation();
  if (battleActive) return;
  cancelEscape(img);      // â† è¿½åŠ ï¼šæˆ¦é—˜ã«å…¥ã‚‹ã®ã§é€ƒèµ°ã‚«ã‚¦ãƒ³ãƒˆåœæ­¢
  startBattle(img);
});


      return img;
    }

    // ãƒãƒˆãƒ«ä¸­ã¯ä¼‘æ†©å¾Œã«çŸ­ã„é–“éš”ã§å†ãƒˆãƒ©ã‚¤ã—ã¦ã€çµ‚ã‚ã£ãŸã‚‰å¿…ãšæ­©ãå‡ºã™
    function scheduleWalk(img){
      const rest = rand(1000, 4000); // 1ã€œ4ç§’ä¼‘æ†©
      setTimeout(function tryStart(){
        if (!img.isConnected) return;
        if (battleActive){
          setTimeout(tryStart, 400); // ãƒãƒˆãƒ«ä¸­ã¯0.4ç§’ã”ã¨ã«å†è©¦è¡Œ
          return;
        }
        walkToRandom(img, ()=>{ scheduleWalk(img); });
      }, rest);
    }

    function walkToRandom(img, onFinish){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const targetX = rand(0,maxX), targetY = rand(0,maxY);
      const startX = parseFloat(img.style.left), startY = parseFloat(img.style.top);
      const dx = targetX - startX, dy = targetY - startY;
      const distance = Math.hypot(dx,dy);
      const duration = distance / WALK_SPEED * 1000;

      img.style.transform = (dx > 0) ? "scaleX(-1)" : "scaleX(1)";

      let startTime=null, toggle=false;
      const frameTimer=setInterval(()=>{
        if (!img.isConnected) { clearInterval(frameTimer); return; }
        toggle=!toggle; img.src = toggle ? img.__mon.frames[1] : img.__mon.frames[0];
      },WALK_FRAME_MS);

      function step(ts){
        if (!img.isConnected){ clearInterval(frameTimer); return; }
        if (!startTime) startTime=ts;
        const t=(ts-startTime)/duration;
        if (t>=1){
          img.style.left=`${targetX}px`; img.style.top =`${targetY}px`;
          updateDepth(img); clearInterval(frameTimer); img.src=img.__mon.frames[0];
          onFinish && onFinish(); return;
        }
        img.style.left=`${startX+dx*t}px`;
        img.style.top =`${startY+dy*t}px`;
        updateDepth(img);
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ===== è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå¸¸ã«6ä½“ã‚­ãƒ¼ãƒ—ï¼‰ =====
    function countActors(){ return actorsLayer.querySelectorAll(".actor").length; }
    function scheduleRespawn(){
      // å°‘ã—é–“ã‚’ãŠã„ã¦è£œå……ï¼ˆæ¼”å‡ºã®ãŸã‚ï¼‰
      setTimeout(()=>{
        if (!battleActive && countActors() < MAX_ACTORS) spawnActor();
        // ä¸‡ä¸€è¤‡æ•°æ¬ ã‘ãŸã‚‰åŸ‹ã¾ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—
        while (!battleActive && countActors() < MAX_ACTORS) spawnActor();
      }, rand(400,1200));
    }

    // ===== ãƒãƒˆãƒ«ï¼šæŠ¼ã—åˆã„ã‚²ãƒ¼ã‚¸ï¼ˆé’vsèµ¤ï¼‰ =====
    let battleActive = false, battleTarget = null, enemyTimer = null;
    let p = 50; // é’ã®å‰ç·šä½ç½®ï¼ˆ0ã€œ100ï¼‰

// p ã¯ 0ã€œ100ï¼ˆæ—¢å­˜ã¨åŒã˜ï¼‰
function renderGauge(){
  const clamped = Math.max(0, Math.min(100, p));
  // width ã‚’å¤‰ãˆãš transform ã ã‘æ›´æ–°ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå›é¿ï¼‰
  blueBar.style.transform = `scaleX(${clamped/100})`;
  divider.style.transform = `translateX(${clamped - 50}%)`;
}


    function startBattle(targetImg){
  battleActive = true;
  battleTarget = targetImg;
  cancelEscape(targetImg);  // â† è¿½åŠ ï¼ˆä¿é™ºï¼‰
  p = 50;
  renderGauge();

      enemyNameLbl.textContent = `${targetImg.__mon.name}ï¼ˆèµ¤ï¼‰`;
      hudMask.style.display = "flex";

      // æ•µã®å¼·ã•ã§é›£æ˜“åº¦ã‚¹ã‚±ãƒ¼ãƒ«
// æ–°ã‚³ãƒ¼ãƒ‰ï¼ˆrAFã‚’èµ·å‹•ï¼‰
const s = targetImg.__mon.strength || 1.0;
const enemyBasePerSec = ENEMY_BASE_PER_SEC * s; // ç§’é–“ï¼…ã®ã¾ã¾
const burstPow = ENEMY_BURST_POW * s;

startEnemyLoop(enemyBasePerSec, burstPow);


      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€£æ‰“ï¼ˆé’ã‚’å³ã¸ï¼‰
      hud.onclick = ()=>{
        if (!battleActive) return;
        flashHurt(battleTarget); // è¢«å¼¾ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        const push = PLAYER_PUSH * (0.9 + Math.random()*0.2);
        p += push;
        if (p >= 100){
          endBattle(true);  // å‹åˆ©
        }else{
          renderGauge();
        }
      };
    }

function dropLoot(mon, atX, atY){
  // mon.drops ã‹ã‚‰ 1ã€œ2å€‹ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒ‰ãƒ­ãƒƒãƒ—
  const count = Math.random() < 0.35 ? 2 : 1;
  for (let i=0;i<count;i++){
    const item = pick(mon.drops);
    // ã“ã“ã§åœ¨åº«è¿½åŠ  â†’ addToInventory å†…ã§ "+1 ã‚¢ã‚¤ãƒ†ãƒ å" ã‚’1å›ã ã‘å ±å‘Š
    addToInventory(item, 1);
  }
}



function endBattle(playerWon){
  cancelAnimationFrame(rafId);
  rafId = null;
  battleActive = false;
  clearInterval(enemyTimer); enemyTimer = null;
  hudMask.style.display = "none";

  if (!battleTarget || !battleTarget.isConnected){ battleTarget = null; return; }

  const target = battleTarget;
  battleTarget = null;

  cancelEscape(target);  // â† è¿½åŠ ï¼šç¢ºå®Ÿã«ã‚¿ã‚¤ãƒãƒ¼åœæ­¢

  if (playerWon){
    const atX = parseFloat(target.style.left) || 0;
    const atY = parseFloat(target.style.top)  || 0;
    dropLoot(target.__mon, atX, atY);
    target.classList.add("vanish");
    target.addEventListener("animationend", ()=>{ target.remove(); scheduleRespawn(); }, { once:true });
  }else{
    target.classList.add("vanish");
    target.addEventListener("animationend", ()=>{ target.remove(); scheduleRespawn(); }, { once:true });
  }
}


    // ===== åˆæœŸã‚¹ãƒãƒ¼ãƒ³ï¼ˆ6ä½“ï¼‰ =====
    for (let i=0;i<MAX_ACTORS;i++) spawnActor();

    // å¿µã®ãŸã‚ã€å®šæœŸçš„ã«æ¬ å“¡ãŒã‚ã‚Œã°è£œå……ï¼ˆä¿é™ºï¼‰
    setInterval(()=>{
      if (!battleActive && countActors() < MAX_ACTORS) scheduleRespawn();
    }, 3000);
    // === é€ƒèµ°ï¼ˆå¾ªç’°ï¼‰é–¢é€£ ===
function scheduleEscape(img){
  // å‡ºç¾ã‹ã‚‰ä¸€å®šæ™‚é–“å¾Œã«é€ƒèµ°ï¼ˆ12ã€œ20ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
  const life = rand(12000, 20000);
  clearTimeout(img.__escapeTimer);
  img.__escapeTimer = setTimeout(()=>{
    // ã¾ã å­˜åœ¨ & ãƒãƒˆãƒ«ä¸­ã§ãªã‘ã‚Œã°é€ƒèµ°
    if (!img.isConnected) return;
    if (battleActive && battleTarget === img){
      // ãƒãƒˆãƒ«ä¸­ãªã‚‰æˆ¦é—˜çµ‚äº†å¾Œã«æ”¹ã‚ã¦å¯¿å‘½ã‚’ã‚»ãƒƒãƒˆ
      scheduleEscape(img);
      return;
    }
    fleeActor(img);
  }, life);
}

function cancelEscape(img){
  if (img && img.__escapeTimer){
    clearTimeout(img.__escapeTimer);
    img.__escapeTimer = null;
  }
}

function fleeActor(img){
  if (!img || !img.isConnected) return;
  // è§¦ã‚Œãªã„çŠ¶æ…‹ã«ã—ã¦é€ƒèµ°æ¼”å‡º â†’ æ¶ˆæ»… â†’ è£œå……
  img.style.pointerEvents = 'none';
  img.classList.add('escape');
  img.addEventListener('animationend', ()=>{
    if (img.isConnected) img.remove();
    scheduleRespawn();
  }, { once:true });
}

  </script>
  <!-- Firebaseï¼ˆå€‰åº«ä¿å­˜ç”¨ï¼‰ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    initializeAuth,
    indexedDBLocalPersistence,
    browserLocalPersistence,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getDatabase, ref, set, onDisconnect, onValue, runTransaction
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // ã‚ãªãŸã®è¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDPe5cSCavq5gHopugdOfQ-9_50cTrqmyk",
    authDomain: "school-178c2.firebaseapp.com",
    databaseURL: "https://school-178c2-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "school-178c2",
    storageBucket: "school-178c2.firebasestorage.app",
    messagingSenderId: "409885673101",
    appId: "1:409885673101:web:25bf0483547e2d470304c4"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // ========= â‘  Authã‚’æ˜ç¤ºåˆæœŸåŒ–ï¼ˆIndexedDBâ†’localStorageã®é †ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ =========
  const auth = initializeAuth(app, {
    persistence: [indexedDBLocalPersistence, browserLocalPersistence]
  });

  // ========= â‘¡ ã‚¿ãƒ–é–“ãƒ­ãƒƒã‚¯ã§ã€Œã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¯å¿…ãš1ã‚¿ãƒ–ã ã‘ã€ã‚’ä¿è¨¼ =========
  const AUTH_LOCK_KEY = "auth_signin_lock_v1";
  const AUTH_BC_CH    = "auth_signin_bc_v1";
  const bc = ("BroadcastChannel" in window) ? new BroadcastChannel(AUTH_BC_CH) : null;

  bc?.addEventListener("message", (ev) => {
    if (ev?.data === "signed-in") {
      try { localStorage.removeItem(AUTH_LOCK_KEY); } catch {}
    }
  });

  function tryAcquireLock(){
    const now = Date.now();
    try{
      const raw = localStorage.getItem(AUTH_LOCK_KEY);
      const t = raw ? Number(raw) : 0;
      if (!raw || !t || (now - t) > 10000) {  // 10ç§’ã§æœŸé™åˆ‡ã‚Œ
        localStorage.setItem(AUTH_LOCK_KEY, String(now));
        return true;
      }
    }catch{}
    return false;
  }
  function releaseLock(){ try{ localStorage.removeItem(AUTH_LOCK_KEY); }catch{} }

  // ========= â‘¢ æ—¢å­˜å¾©å…ƒã‚’å¾…ã£ã¦ã€æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰â€œ1ã‚¿ãƒ–ã ã‘â€åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ =========
  await auth.authStateReady();

  if (!auth.currentUser) {
    const iAmLeader = tryAcquireLock();
    if (iAmLeader) {
      try {
        await signInAnonymously(auth);
        bc?.postMessage("signed-in");
      } finally {
        releaseLock();
      }
    } else {
      // ãƒªãƒ¼ãƒ€ãƒ¼ã‚¿ãƒ–ãŒå®Ÿè¡Œã™ã‚‹ã®ã‚’æœ€å¤§12ç§’å¾…ã¤
      const until = Date.now() + 12000;
      while (!auth.currentUser && Date.now() < until) {
        await new Promise(r => setTimeout(r, 200));
      }
      // ãã‚Œã§ã‚‚æœªã‚µã‚¤ãƒ³ã‚¤ãƒ³ãªã‚‰è‡ªåˆ†ãŒå®Ÿè¡Œï¼ˆä¿é™ºï¼‰
      if (!auth.currentUser) {
        const got = tryAcquireLock();
        if (got) {
          try {
            await signInAnonymously(auth);
            bc?.postMessage("signed-in");
          } finally {
            releaseLock();
          }
        }
      }
    }
  }

  // ========= â‘£ presenceï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼Ã—ã‚¿ãƒ–ï¼‰ç™»éŒ² =========
  const EVENT_ID = "your-event-id";
  const TAB_ID   = (crypto?.randomUUID?.() ?? String(Math.random()).slice(2));

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    const myRef = ref(db, `rooms/${EVENT_ID}/presence/${user.uid}/${TAB_ID}`);
    await set(myRef, true);
    onDisconnect(myRef).remove();
    window.CURRENT_UID = user.uid; // å¿…è¦ãªã‚‰ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‚ç…§
  });

  // ========= ä¸€æ™‚åœæ­¢ãƒ•ãƒƒã‚¯ï¼ˆæ—¢å­˜UIã«åˆã‚ã›ã¦æ®ãˆç½®ãï¼‰ =========
  (function installGlobalPause(db){
    let paused = false;
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position:fixed; inset:0; display:none; z-index:99999;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      background: rgba(0,0,0,.65); color:#fff;
      font:600 18px/1.4 system-ui,-apple-system,"Noto Sans JP",sans-serif;
      align-items:center; justify-content:center; text-align:center; padding:24px;`;
    overlay.innerHTML = `
      <div style="max-width:740px;">
        <div style="font-size:22px; margin-bottom:8px;">ä¸€æ™‚åœæ­¢ä¸­</div>
        <div id="__pauseMsg" style="opacity:.9;"></div>
      </div>`;
    document.body.appendChild(overlay);
    const msgEl = overlay.querySelector('#__pauseMsg');

    onValue(ref(db, 'game/control/state'), (snap)=>{
      const s = snap.exists()? snap.val(): null;
      paused = !!(s && s.paused);
      overlay.style.display = paused ? 'flex' : 'none';
      if (paused) msgEl.textContent = s?.message || 'ã‚ªãƒ¼ãƒŠãƒ¼ãŒä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ';
    });

    const block = (e)=>{ if (paused){ e.stopPropagation(); e.preventDefault(); } };
    ['click','mousedown','mouseup','touchstart','touchend','keydown','keyup','pointerdown','pointerup']
      .forEach(t=> document.addEventListener(t, block, true));

    window.assertNotPaused = function(){
      if (paused) throw new Error('PAUSED');
    };
  })(db);

  // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã®ã€Œå€‰åº«ã€ãƒœã‚¿ãƒ³ãªã©ã‹ã‚‰ä½¿ã†ãŸã‚ã«å…¬é–‹
  window.firebaseDB = { db, ref, onValue, runTransaction };
</script>


</body>
</html>

























