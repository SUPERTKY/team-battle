<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>透明パネル＋自動スポーン（2フレーム歩き）</title>
  <style>
    html, body { margin:0; height:100%; }
    .stage{
      position:relative; width:100vw; height:100vh; overflow:hidden;
      background: url("assets/sougen.png") center/cover no-repeat;
    }

    /* 透明＆クリック不可の下パネル（9分の4） */
    .bottom-rect{
      position:absolute; left:0; right:0; bottom:0;
      height:44.44vh; background: transparent;
      pointer-events: none; z-index: 10;
    }

    /* 役者レイヤ（自体はクリック拾わず、中の画像のみ拾う） */
    .actors-layer{
      position:absolute; left:0; right:0; bottom:0; height:44.44vh;
      pointer-events: none; z-index: 20;
    }

    /* キャラクター（少し大型化） */
    .actor{
      position:absolute; width:144px; height:auto;
      pointer-events: auto; user-select: none; -webkit-user-drag: none;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.35));
      transition: transform 120ms ease;
      image-rendering: auto;
    }
    .actor:active{ transform: scale(0.96); }

    /* UI */
    .controls{
      position:absolute; top:12px; right:12px; z-index:30; display:flex; gap:8px;
    }
    .btn{
      padding:10px 14px; border-radius:10px; border:1px solid rgba(0,0,0,0.15);
      background:#ffffffcc; backdrop-filter: blur(6px);
      font:600 14px/1 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="bottom-rect" id="panel"></div>
    <div class="actors-layer" id="actorsLayer"></div>

    <div class="controls">
      <button class="btn" id="clearBtn">Clear（全消し）</button>
    </div>
  </div>

  <script>
    // ===== 設定 =====
    // 2フレーム画像のパス（必要に応じて変更）
    const FRAME1_SRC = "assets/suraimu1frame.png";
    const FRAME2_SRC = "assets/suraimu2frame.png";

    const MAX_ACTORS = 6;
    const ACTOR_WIDTH = 144;  // CSS と合わせる
    const ACTOR_HEIGHT = 144; // 目安（縦横比により上下に余裕を持つ）

    // スポーン間隔（ランダム）[ms]
    const SPAWN_MIN_MS = 900;   // 最短 0.9 秒
    const SPAWN_MAX_MS = 3000;  // 最長 3.0 秒

    // 歩行アニメの切替間隔（2フレーム）
    const WALK_FRAME_MS = 180;  // 0.18秒ごとに切替

    // ===== 参照 =====
    const actorsLayer = document.getElementById("actorsLayer");
    const clearBtn = document.getElementById("clearBtn");

    let spawnTimerId = null;     // setTimeout のID
    let spawnPaused = false;     // 上限に達して一時停止中か

    function countActors(){
      return actorsLayer.querySelectorAll(".actor").length;
    }

    function rand(min, max){ return Math.random() * (max - min) + min; }
    function randInt(min, max){ return Math.floor(rand(min, max + 1)); }

    function scheduleNextSpawn(){
      // 既にスケジュールがあれば何もしない
      if (spawnTimerId !== null || spawnPaused) return;
      const delay = Math.floor(rand(SPAWN_MIN_MS, SPAWN_MAX_MS));
      spawnTimerId = setTimeout(() => {
        spawnTimerId = null;
        trySpawnAndReschedule();
      }, delay);
    }

    function trySpawnAndReschedule(){
      if (countActors() >= MAX_ACTORS){
        spawnPaused = true; // 満杯なので一時停止
        return;
      }
      spawnActor();
      scheduleNextSpawn();
    }

    function startSpawningIfNeeded(){
      if (countActors() < MAX_ACTORS){
        spawnPaused = false;     // 再開可能
        scheduleNextSpawn();
      }
    }

    function spawnActor(){
      if (countActors() >= MAX_ACTORS) return;

      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const x = rand(0, maxX);
      const y = rand(0, maxY);

      const img = document.createElement("img");
      img.src = FRAME1_SRC;
      img.className = "actor";
      img.style.left = `${x}px`;
      img.style.top  = `${y}px`;
      img.alt = "character";

      // 2フレーム歩き（交互表示）
      let toggle = false;
      const walkTimer = setInterval(()=>{
        toggle = !toggle;
        img.src = toggle ? FRAME2_SRC : FRAME1_SRC;
      }, WALK_FRAME_MS);
      // 後から消すために保持
      img.dataset.walkTimer = String(walkTimer);

      // クリックで消す
      img.addEventListener("click", (e)=>{
        e.stopPropagation();
        removeActor(img);
      });

      actorsLayer.appendChild(img);

      // 上限到達したら一時停止（次のスケジュールは立てない）
      if (countActors() >= MAX_ACTORS){
        spawnPaused = true;
        if (spawnTimerId !== null){
          clearTimeout(spawnTimerId);
          spawnTimerId = null;
        }
      }
    }

    function removeActor(img){
      // 歩行タイマー停止
      const id = Number(img.dataset.walkTimer);
      if (!Number.isNaN(id)) clearInterval(id);
      img.remove();

      // 空きができたら自動スポーン再開
      if (spawnPaused && countActors() < MAX_ACTORS){
        spawnPaused = false;
        scheduleNextSpawn();
      }
    }

    function clearActors(){
      actorsLayer.querySelectorAll(".actor").forEach(img=>{
        const id = Number(img.dataset.walkTimer);
        if (!Number.isNaN(id)) clearInterval(id);
        img.remove();
      });
      spawnPaused = false;
      if (spawnTimerId !== null){
        clearTimeout(spawnTimerId);
        spawnTimerId = null;
      }
      // すぐ次のスポーンを予約
      scheduleNextSpawn();
    }

    clearBtn.addEventListener("click", clearActors);

    // 初期起動：自動スポーン開始
    scheduleNextSpawn();

    // リサイズしても配置は維持。必要なら再配置ロジックを入れてください。
    window.addEventListener("resize", ()=>{ /* no-op */ });
  </script>
</body>
</html>
