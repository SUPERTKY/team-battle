<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ’ƒç ´ãƒ‰ãƒ­ãƒƒãƒ—ï¼†è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼†å¤šã‚­ãƒ£ãƒ©å¯¾å¿œ</title>
  <style>
    /* === Inventory UIï¼ˆTURIã¨åŒã˜è¦‹ãŸç›®ï¼‰ === */
/* === Inventory UIï¼ˆTURIè¦‹ãŸç›®ãƒ»å°‚ç”¨ã‚¯ãƒ©ã‚¹ï¼‰ === */
.inv-hud{
  position:fixed; right:12px; top:12px; z-index:1300; display:flex; gap:8px;
}
.inv-btn{
  background:#0b1c26aa; border:1px solid #7ee0ff66; color:#dff7ff;
  padding:8px 12px; border-radius:10px; backdrop-filter: blur(4px);
  font-weight:600; cursor:pointer;
}
.inv-btn:hover{ background:#0f2a36cc; }

.inv-panel{
  position:fixed; right:12px; top:56px; width:min(420px, calc(100vw - 24px));
  max-height:min(70vh, 520px); overflow:auto; z-index:1250;
  background:#06131bdf; border:1px solid #7ee0ff33; border-radius:12px;
  backdrop-filter: blur(6px); color:#e8fbff; padding:10px 10px 12px;
}
.inv-panel h3{ margin:6px 8px 8px; font-size:16px }
.inv-meta{ margin:0 8px 8px; font-size:12px; opacity:.8 }
.inv-list{ display:grid; grid-template-columns: 1fr auto; gap:6px 10px; padding:6px 8px; }

.inv-row{ display:contents }
.inv-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.inv-qty{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ffffff22 }
.inv-actions{ display:flex; gap:6px; }
.inv-action{
  background:#0b1c26aa; border:1px solid #7ee0ff44; color:#dff7ff;
  padding:4px 8px; border-radius:8px; cursor:pointer;
}
.inv-action:hover{ background:#0f2a36cc; }
.hidden{ display:none !important; }


    /* ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªUI ===== */
.top-controls{
  position:fixed; top:12px; right:12px; z-index:1300; display:flex; gap:8px;
}
.top-controls .btn{
  padding:10px 14px; border-radius:12px; border:1px solid rgba(0,0,0,0.15);
  background:#ffffffcc; backdrop-filter: blur(6px);
  font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  cursor:pointer;
}
..top-controls .btn:active{ transform: translateY(1px); }

.inventory{
  position:fixed; top:60px; right:12px; width:min(90vw, 320px);
  max-height:70vh; overflow:auto; z-index:1250;
  background:#0b1020ee; color:#e5e7eb; border:1px solid rgba(255,255,255,0.12);
  border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,0.45);
  transform: translateX(120%); transition: transform 220ms ease;
}
.inventory.open{ transform: translateX(0); }
.inv-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.08);
  position:sticky; top:0; background:inherit; z-index:1;
}
.inv-list{ padding:10px 12px 14px; }
.inv-item{
  display:grid; grid-template-columns: 1fr auto; align-items:center;
  gap:8px; padding:8px 10px; border-radius:10px;
  background:#0f172ae6; border:1px solid rgba(255,255,255,0.06);
  margin-bottom:8px;
}
.inv-name{ font-weight:700; }
.inv-qty{ font-weight:800; }
.inv-total.pulse{ animation: invpulse 420ms ease; }
@keyframes invpulse{
  0%{ transform:scale(1); }
  40%{ transform:scale(1.15); }
  100%{ transform:scale(1); }
}

    html, body { margin:0; height:100%; }
    .stage{
      position:relative; width:100vw; height:100vh; overflow:hidden;
      background: url("assets/sougen.png") center/cover no-repeat;
    }

    /* é€æ˜ã®ç§»å‹•ç¯„å›²ï¼ˆä¸‹ 9åˆ†ã®4ï¼‰ */
    .bottom-rect{
      position:absolute; left:0; right:0; bottom:0;
      height:44.44vh; background: transparent;
      pointer-events:none; z-index:10;
    }

    /* ã‚­ãƒ£ãƒ©ãƒ¬ã‚¤ãƒ¤ï¼ˆç§»å‹•ç¯„å›²ã¨åŒã‚µã‚¤ã‚ºï¼‰ */
    .actors-layer{
      position:absolute; left:0; right:0; bottom:0; height:44.44vh;
      pointer-events:none; z-index:20;
    }

    .actor{
      position:absolute; width:144px; height:auto;
      pointer-events:auto; user-select:none; -webkit-user-drag:none;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.35));
      transition: transform 120ms ease, filter 80ms ease;
      will-change: left, top, transform, filter;
    }
    .actor:active{ transform:scale(0.96); }

    /* ä¸‹ã«ã„ã‚‹ã»ã©æ‰‹å‰ï¼ˆz-index ã¯JSã§æ›´æ–°ï¼‰ */

    /* æ¶ˆãˆæ–¹ï¼šè‡ªç„¶ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‹ç¸®å° */
    @keyframes vanish {
      0%   { opacity:1; transform: translateY(0)   scale(1)    }
      60%  { opacity:.6; transform: translateY(6px) scale(.9)  }
      100% { opacity:0; transform: translateY(12px) scale(.75) }
    }
    .vanish { animation: vanish 380ms ease forwards; }

    /* è¢«å¼¾ï¼ˆèµ¤ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ */
    .actor.hurt{
      filter:
        drop-shadow(0 4px 8px rgba(0,0,0,0.35))
        grayscale(1) sepia(1) saturate(8000%) hue-rotate(-8deg)
        brightness(1.15) contrast(1.1);
    }

    /* ===== ãƒãƒˆãƒ«HUDï¼ˆæŠ¼ã—åˆã„ã‚²ãƒ¼ã‚¸ï¼šé’vsèµ¤ï¼‰ ===== */
    .hud-mask{
      position:fixed; inset:0; background: rgba(0,0,0,0.3);
      display:none; align-items:center; justify-content:center;
      z-index:1000; backdrop-filter: blur(2px);
    }
    .hud{
      width:min(92vw, 720px); background:#0b1020ee; color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.12); border-radius:14px;
      box-shadow:0 20px 50px rgba(0,0,0,0.45);
      padding:16px 18px 20px; user-select:none;
      font:600 14px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    .hud-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; font-weight:700; }
    .vs-row{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; opacity:.9; }

    .gauge{ position:relative; height:28px; border-radius:999px; overflow:hidden;
      background:#0a0f1a; border:1px solid #ffffff14; }
    .gauge .blue{
      position:absolute; left:0; top:0; bottom:0; width:50%;
      background: linear-gradient(90deg,#38bdf8,#22c55e);
      transition: width 40ms linear;
    }
    .gauge .red{
      position:absolute; right:0; top:0; bottom:0; width:50%;
      background: linear-gradient(90deg,#ef4444,#f97316);
      transition: width 40ms linear;
    }
    .gauge .divider{
      position:absolute; top:0; bottom:0; width:2px; left:50%;
      background: #ffffff33; box-shadow: 0 0 10px #ffffff55;
      transition: left 40ms linear;
    }
    .tap-hint{ margin-top:8px; text-align:center; font-size:12px; opacity:.85; }
    .enemy-throb{ animation: throb 140ms ease; }
    @keyframes throb{
      0%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
      50%{ box-shadow: inset 0 0 28px 0 rgba(255,255,255,0.15);}
      100%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
    }

    /* ===== ãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤ºï¼ˆé£Ÿæï¼‰ ===== */
    .loot{
      position:absolute; padding:6px 10px; border-radius:12px;
      background:#111827e6; color:#fff; font:700 12px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      border:1px solid rgba(255,255,255,0.1); pointer-events:none;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,0.45));
      animation: loot-pop 1100ms ease forwards;
      z-index: 2000;
    }
    @keyframes loot-pop{
      0%   { transform: translateY(0) scale(.9); opacity:0 }
      15%  { transform: translateY(-8px) scale(1.02); opacity:1 }
      70%  { transform: translateY(-16px) scale(1); opacity:1 }
      100% { transform: translateY(-26px) scale(.98); opacity:0 }
    }

    /* â€œã‚­ãƒ£ãƒ©ã‚’ã‚²ãƒƒãƒˆï¼â€ ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆéãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */
    .toast{
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      background:#111827e6; color:#fff; padding:10px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12); z-index:1200;
      font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      animation: toast-in 300ms ease, toast-out 300ms ease 1400ms forwards;
    }
    @keyframes toast-in{ from{opacity:0; transform:translate(-50%,-6px)} to{opacity:1; transform:translate(-50%,0)} }
    @keyframes toast-out{ to{ opacity:0; transform:translate(-50%,-8px) } }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bottom-rect"></div>
    <div class="actors-layer" id="actorsLayer"></div>
  </div>

  <!-- ãƒãƒˆãƒ«HUD -->
  <div class="hud-mask" id="hudMask">
    <div class="hud" id="hud">
      <div class="hud-title">
        <span>ãƒãƒˆãƒ«ä¸­â€¦é€£æ‰“ã§å‰ç·šã‚’æŠ¼ã—ä¸Šã’ã‚ï¼</span>
        <span id="timerLbl"></span>
      </div>
      <div class="vs-row">
        <span>ã‚ãªãŸï¼ˆé’ï¼‰</span><span>VS</span><span id="enemyNameLbl">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼ˆèµ¤ï¼‰</span>
      </div>
      <div class="gauge" id="gauge">
        <div class="blue" id="blueFill"></div>
        <div class="red"  id="redFill"></div>
        <div class="divider" id="divider"></div>
      </div>
      <div class="tap-hint">ã“ã®ãƒ‘ãƒãƒ«ã‚’é€£æ‰“ï¼ æŠ¼ã—åˆ‡ã‚Œã°å‹ã¡ï¼ˆæ’ƒç ´ã¨åŒæ™‚ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰</div>
    </div>
  </div>
  <!-- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªé–‹é–‰ãƒœã‚¿ãƒ³ -->
<div id="invPanel" class="inv-panel hidden">
  <h3>ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3>
  <div class="meta" id="invMeta">åˆè¨ˆ 0 å€‹</div>
  <div class="list" id="invList"></div>
</div>
<div class="inv-hud">
   <button id="invBtn" class="inv-btn">ğŸ£ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</button>
 </div>

  <script>
    // === å…±é€š TEAM è§£æ±ºï¼ˆ?team=2 ãªã© â†’ localStorage â†’ æ—¢å®š 'team1'ï¼‰ ===
const TEAM = (() => {
  const m = location.search.match(/[?&]team=(\d+)/);
  const t = m ? `team${m[1]}` : (localStorage.getItem('selected_team') || 'team1');
  localStorage.setItem('selected_team', t); // ä»–ãƒšãƒ¼ã‚¸ï¼ˆèª¿ç†å ´ãªã©ï¼‰ã¨å…±æœ‰
  return t;
})();

    // ===== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å®šç¾©ï¼ˆã“ã“ã«ç¨®é¡ã‚’å¢—ã‚„ã›ã‚‹ï¼‰ =====
    const MONSTERS = [

        {
    id: "flame_wolf",
    name: "ãƒ•ãƒ¬ã‚¤ãƒ ã‚¦ãƒ«ãƒ•",
    strength: 3.0,
          frames: ["assets/hureimuuruhu1frame.png", "assets/hureimuuruhu2frame.png"],
    drops: ["ãƒ•ãƒ¬ã‚¤ãƒ ã‚°ãƒªãƒ¼ã‚¹","ãƒ•ãƒ¬ã‚¤ãƒ ãƒ¡ãƒ³ãƒ–ãƒ¬ãƒ³"]
          
  },

 {
    id: "shadow_bat",
    name: "ã‚·ãƒ£ãƒ‰ã‚¦ãƒãƒƒãƒˆ",
    strength: 2.5,
   frames: ["assets/teki/syadoubatto1frame.png", "assets/teki/syadoubaddo2frame.png"],
    drops: ["ã‚·ãƒ£ãƒ‰ã‚¦ãƒ•ãƒ«ãƒ¼ãƒ„","ãƒŠã‚¤ãƒˆãƒãƒ‹ãƒ¼"]
   
  },
{
    id: "giant_beetle",
    name: "ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆãƒ“ãƒ¼ãƒˆãƒ«",
    strength: 3.5,
   frames: ["assets/teki/zyainantbi-toru1frame.png", "assets/teki/zyaiantbi-toru2frame.png"],
    drops: ["ãƒ“ãƒ¼ãƒˆãƒ«ãƒãƒ‹ãƒ¼","ãƒ“ãƒ¼ãƒˆãƒ«ãƒŠãƒƒãƒ„"]
  },
{
    id: "moon_spirit",
    name: "ãƒ ãƒ¼ãƒ³ã‚¹ãƒ”ãƒªãƒƒãƒˆ",
    strength: 4.0,
   frames: ["assets/teki/mu-nsupiritto1frame.png", "assets/teki/mu-nsupiritto1frame.png"],
    drops: ["ãƒ ãƒ¼ãƒ³ãƒ‘ã‚¦ãƒ€ãƒ¼","ã‚¹ãƒ”ãƒªãƒƒãƒˆã‚¨ã‚­ã‚¹"]
  },
{
    id: "glow_worm",
    name: "ã‚°ãƒ­ã‚¦ãƒ¯ãƒ¼ãƒ ",
    strength: 1.5,
   frames: ["assets/teki/gurouwa-mu1frame.png", "assets/teki/gurouwa-mu2frame.png"],
    drops: ["ã‚°ãƒ­ã‚¦ã‚¸ã‚§ãƒ«","ãƒ©ã‚¤ãƒˆãƒ€ã‚¹ãƒˆ"]
  },
 {
    id: "abyss_dragon",
    name: "ã‚¢ãƒ“ã‚¹ãƒ‰ãƒ©ã‚´ãƒ³",
    strength: 5.0,
    frames: ["assets/teki/abisudoragon1frame.png", "assets/teki/abisudoragon2frame.png"],
    drops: ["ãƒ‰ãƒ©ã‚´ãƒ³ãƒŸãƒ¼ãƒˆ","ãƒ‰ãƒ©ã‚´ãƒ³ã‚¨ãƒƒã‚°"]
  }

    ];

    // ===== èª¿æ•´ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ =====
    const MAX_ACTORS = 6;
    const ACTOR_WIDTH = 144, ACTOR_HEIGHT = 144;
    const WALK_FRAME_MS = 200, WALK_SPEED = 60;

    // ãƒãƒˆãƒ«é›£æ˜“åº¦ï¼ˆåŸºæº–å€¤ãƒ»ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å¼·ã•ã§ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    const PLAYER_PUSH = 3.2;      // ã‚¯ãƒªãƒƒã‚¯1å›ã§å³ã¸ä½•ï¼…é€²ã‚€ã‹
    const ENEMY_BASE_PER_SEC = 0.35; // æ•µã®å¸¸æ™‚æŠ¼ã—ï¼ˆï¼…/ç§’ï¼‰
    const ENEMY_BURST_POW   = 1.2;   // æ•µã®ãƒãƒ¼ã‚¹ãƒˆ1å›ã®æŠ¼ã—é‡ï¼ˆï¼…ï¼‰
    const BURST_MIN_MS = 340, BURST_MAX_MS = 620;

    // ===== è¦ç´  =====
    const actorsLayer = document.getElementById("actorsLayer");
    const hudMask = document.getElementById("hudMask");
    const hud = document.getElementById("hud");
    const blueFill = document.getElementById("blueFill");
    const redFill  = document.getElementById("redFill");
    const divider  = document.getElementById("divider");
    const gaugeEl  = document.getElementById("gauge");
    const enemyNameLbl = document.getElementById("enemyNameLbl");
// ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª =====
// ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªï¼ˆTURIè¦‹ãŸç›®ï¼‰ =====
const INV_KEY = 'inventory_v1';
// ä¿æŒå½¢å¼ï¼š{ total:number, byItem:{ [name]: qty } }
let inv = loadInv();

const invPanel = document.getElementById('invPanel');
const invBtn   = document.getElementById('invBtn');
const invMeta  = document.getElementById('invMeta');
const invList  = document.getElementById('invList');

function loadInv(){
  try{
    const raw = localStorage.getItem(INV_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    // æ—§å½¢å¼ï¼ˆ{åå‰:å€‹æ•°}ï¼‰â†’ æ–°å½¢å¼ã«è‡ªå‹•å¤‰æ›
    if (!('total' in obj) || !('byItem' in obj)){
      const byItem = obj && typeof obj === 'object' ? obj : {};
      const total = Object.values(byItem).reduce((a,b)=> a+(b||0), 0);
      const neo = { total, byItem };
      localStorage.setItem(INV_KEY, JSON.stringify(neo));
      return neo;
    }
    return obj;
  }catch(_){
    return { total:0, byItem:{} };
  }
}
function saveInv(){ try{ localStorage.setItem(INV_KEY, JSON.stringify(inv)); }catch(_){} }

// æ—¢å­˜ã® dropLoot ã‹ã‚‰å‘¼ã°ã‚Œã‚‹æƒ³å®š
function addToInventory(name, qty=1){
  inv.total += qty;
  inv.byItem[name] = (inv.byItem[name]||0) + qty;
  saveInv();
  renderInventory();
  if (typeof showToast === 'function'){
    showToast(`+${qty} ${name} ã‚’å…¥æ‰‹ï¼ˆåˆè¨ˆ ${inv.byItem[name]}ï¼‰`);
  }
}

function renderInventory(){
  if(!invMeta || !invList) return;
  invMeta.textContent = `åˆè¨ˆ ${inv.total} å€‹`;

  const entries = Object.entries(inv.byItem).sort((a,b)=> a[0].localeCompare(b[0],'ja'));
  invList.innerHTML = '';

  for (const [name, count] of entries){
    // å·¦åˆ—ï¼šåå‰
    const nameCell = document.createElement('div');
    nameCell.className = 'inv-row inv-name';
    nameCell.textContent = name;

    // å³åˆ—ï¼šæ•°é‡ï¼‹æ“ä½œ
    const actionCell = document.createElement('div');
    actionCell.className = 'inv-row inv-actions';
    actionCell.innerHTML = `
   <span class="inv-qty">Ã— ${count}</span>
   <button class="btnStore inv-action">å€‰åº«</button>
   <button class="btnDrop inv-action">æ¨ã¦ã‚‹</button>
 `;

    // å€‰åº«ï¼ˆFirebase ãŒã‚ã‚Œã°ä¿å­˜ï¼‰
    actionCell.querySelector('.btnStore').addEventListener('click', async ()=>{
      try{
const api = window.firebaseDB;
   if(!api) throw new Error('no-firebase');
   const { db, ref, runTransaction, push } = api;
   // ä¸€æ™‚åœæ­¢ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆä»»æ„ï¼‰
   try{ assertNotPaused(); }catch(_){ return; }
   // â‘  é›†è¨ˆãƒãƒ¼ãƒ‰ã¸åŸå­çš„ã« +1
  const node = ref(db, `warehouse/${TEAM}/byItem/${name}`);
   await runTransaction(node, cur => (cur || 0) + 1);
   // â‘¡ï¼ˆä»»æ„ï¼‰ãƒ­ã‚°ã‚’æ®‹ã™
   await push(ref(db, `warehouse/${TEAM}/logs`), {
     item: name, delta: +1, ts: Date.now(), src: 'battle'
  });

        // åœ¨åº«ã‚’1ã¤æ¸›ã‚‰ã™
        if (inv.byItem[name]){
          inv.total--;
          if (--inv.byItem[name] <= 0) delete inv.byItem[name];
          saveInv(); renderInventory();
          showToast?.(`${name} ã‚’å€‰åº«ã«ã—ã¾ã„ã¾ã—ãŸ`);
        }
      }catch(e){
        showToast?.('å€‰åº«ã«ã—ã¾ã†ã«ã¯ Firebase ã®è¨­å®šãŒå¿…è¦ã§ã™');
      }
    });

    // æ¨ã¦ã‚‹
    actionCell.querySelector('.btnDrop').addEventListener('click', ()=>{
      if (inv.byItem[name]){
        inv.total--;
        if (--inv.byItem[name] <= 0) delete inv.byItem[name];
        saveInv(); renderInventory();
        showToast?.(`${name} ã‚’æ¨ã¦ã¾ã—ãŸ`);
      }
    });

    invList.appendChild(nameCell);
    invList.appendChild(actionCell);
  }
}

// é–‹é–‰
invBtn?.addEventListener('click', ()=>{
  invPanel.classList.toggle('hidden');
});

// åˆæœŸæç”»
renderInventory();


    // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function rand(min,max){ return Math.random()*(max-min)+min; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

    // ä¸‹ã«ã„ã‚‹ã»ã©å‰é¢
    function updateDepth(img){
      const y = parseFloat(img.style.top) || 0;
      img.style.zIndex = String(1000 + Math.floor(y));
    }

    function flashHurt(img){
      if (!img || !img.isConnected) return;
      img.classList.add("hurt");
      setTimeout(()=> img.classList.remove("hurt"), 120);
    }

    function showToast(text){
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1800);
    }

    // ===== ã‚¹ãƒãƒ¼ãƒ³ï¼†æ­©è¡Œ =====
    function spawnActor(){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);
      const x = rand(0,maxX), y = rand(0,maxY);

      const monster = pick(MONSTERS);
      const img = new Image();
      img.src = monster.frames[0];
      img.className="actor";
      img.style.left=`${x}px`; img.style.top =`${y}px`;
      img.style.transform = "scaleX(1)";
      // å‚ç…§ã‚’æŒãŸã›ã‚‹ï¼ˆç¨®é¡ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»å¼·ã•ãƒ»ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
      img.__mon = monster;

      actorsLayer.appendChild(img);
      updateDepth(img);

      // æ­©è¡Œãƒ«ãƒ¼ãƒ—é–‹å§‹
      scheduleWalk(img);

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒˆãƒ«
      img.addEventListener("click", (e)=>{
        e.stopPropagation();
        if (battleActive) return;
        startBattle(img);
      });

      return img;
    }

    // ãƒãƒˆãƒ«ä¸­ã¯ä¼‘æ†©å¾Œã«çŸ­ã„é–“éš”ã§å†ãƒˆãƒ©ã‚¤ã—ã¦ã€çµ‚ã‚ã£ãŸã‚‰å¿…ãšæ­©ãå‡ºã™
    function scheduleWalk(img){
      const rest = rand(1000, 4000); // 1ã€œ4ç§’ä¼‘æ†©
      setTimeout(function tryStart(){
        if (!img.isConnected) return;
        if (battleActive){
          setTimeout(tryStart, 400); // ãƒãƒˆãƒ«ä¸­ã¯0.4ç§’ã”ã¨ã«å†è©¦è¡Œ
          return;
        }
        walkToRandom(img, ()=>{ scheduleWalk(img); });
      }, rest);
    }

    function walkToRandom(img, onFinish){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const targetX = rand(0,maxX), targetY = rand(0,maxY);
      const startX = parseFloat(img.style.left), startY = parseFloat(img.style.top);
      const dx = targetX - startX, dy = targetY - startY;
      const distance = Math.hypot(dx,dy);
      const duration = distance / WALK_SPEED * 1000;

      img.style.transform = (dx > 0) ? "scaleX(-1)" : "scaleX(1)";

      let startTime=null, toggle=false;
      const frameTimer=setInterval(()=>{
        if (!img.isConnected) { clearInterval(frameTimer); return; }
        toggle=!toggle; img.src = toggle ? img.__mon.frames[1] : img.__mon.frames[0];
      },WALK_FRAME_MS);

      function step(ts){
        if (!img.isConnected){ clearInterval(frameTimer); return; }
        if (!startTime) startTime=ts;
        const t=(ts-startTime)/duration;
        if (t>=1){
          img.style.left=`${targetX}px`; img.style.top =`${targetY}px`;
          updateDepth(img); clearInterval(frameTimer); img.src=img.__mon.frames[0];
          onFinish && onFinish(); return;
        }
        img.style.left=`${startX+dx*t}px`;
        img.style.top =`${startY+dy*t}px`;
        updateDepth(img);
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ===== è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå¸¸ã«6ä½“ã‚­ãƒ¼ãƒ—ï¼‰ =====
    function countActors(){ return actorsLayer.querySelectorAll(".actor").length; }
    function scheduleRespawn(){
      // å°‘ã—é–“ã‚’ãŠã„ã¦è£œå……ï¼ˆæ¼”å‡ºã®ãŸã‚ï¼‰
      setTimeout(()=>{
        if (!battleActive && countActors() < MAX_ACTORS) spawnActor();
        // ä¸‡ä¸€è¤‡æ•°æ¬ ã‘ãŸã‚‰åŸ‹ã¾ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—
        while (!battleActive && countActors() < MAX_ACTORS) spawnActor();
      }, rand(400,1200));
    }

    // ===== ãƒãƒˆãƒ«ï¼šæŠ¼ã—åˆã„ã‚²ãƒ¼ã‚¸ï¼ˆé’vsèµ¤ï¼‰ =====
    let battleActive = false, battleTarget = null, enemyTimer = null;
    let p = 50; // é’ã®å‰ç·šä½ç½®ï¼ˆ0ã€œ100ï¼‰

    function renderGauge(){
      const clamped = Math.max(0, Math.min(100, p));
      blueFill.style.width = clamped + "%";
      redFill.style.width  = (100 - clamped) + "%";
      divider.style.left   = clamped + "%";
    }

    function startBattle(targetImg){
      battleActive = true;
      battleTarget = targetImg;
      p = 50;
      renderGauge();

      enemyNameLbl.textContent = `${targetImg.__mon.name}ï¼ˆèµ¤ï¼‰`;
      hudMask.style.display = "flex";

      // æ•µã®å¼·ã•ã§é›£æ˜“åº¦ã‚¹ã‚±ãƒ¼ãƒ«
      const s = targetImg.__mon.strength || 1.0;
      const enemyBasePerFrame = (ENEMY_BASE_PER_SEC * s) / 60;
      const burstPow = ENEMY_BURST_POW * s;

      // æ•µã®æŠ¼ã—ï¼ˆ60fpsç›¸å½“ï¼‰
      let lastBurstAt = performance.now();
      enemyTimer = setInterval(()=>{
        if (!battleActive) return;
        p -= enemyBasePerFrame; // æ•µãŒæŠ¼ã™ï¼å·¦ã¸

        const now = performance.now();
        if (now - lastBurstAt > rand(BURST_MIN_MS, BURST_MAX_MS)){
          p -= burstPow;
          lastBurstAt = now;
          // ãƒãƒãƒãƒæ¼”å‡º
          gaugeEl.classList.remove("enemy-throb");
          void gaugeEl.offsetWidth;
          gaugeEl.classList.add("enemy-throb");
        }

        if (p <= 0){
          endBattle(false); // æ•—åŒ—
        }else{
          renderGauge();
        }
      }, 16);

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€£æ‰“ï¼ˆé’ã‚’å³ã¸ï¼‰
      hud.onclick = ()=>{
        if (!battleActive) return;
        flashHurt(battleTarget); // è¢«å¼¾ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        const push = PLAYER_PUSH * (0.9 + Math.random()*0.2);
        p += push;
        if (p >= 100){
          endBattle(true);  // å‹åˆ©
        }else{
          renderGauge();
        }
      };
    }

    function dropLoot(mon, atX, atY){
      // mon.drops ã‹ã‚‰ 1ã€œ2å€‹ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒ‰ãƒ­ãƒƒãƒ—
      const count = Math.random() < 0.35 ? 2 : 1;
      for (let i=0;i<count;i++){
        const item = pick(mon.drops);
        const el = document.createElement("div");
        // æ—¢å­˜ã® for ãƒ«ãƒ¼ãƒ—å†…ã€item ã‚’æ±ºã‚ãŸç›´å¾Œã«è¿½åŠ 
addToInventory(item, 1);

        el.className = "loot";
        el.textContent = `å…¥æ‰‹ï¼š${item}`;
        // è¡¨ç¤ºä½ç½®ï¼ˆæ’ƒç ´ä½ç½®ã®ã¡ã‚‡ã„ä¸Šï¼‰
        const x = atX + ACTOR_WIDTH/2 - 36 + rand(-14,14);
        const y = atY - 6 + rand(-6,6);
        el.style.left = `${x}px`;
        el.style.top  = `${y}px`;
        actorsLayer.appendChild(el);
        setTimeout(()=> el.remove(), 1100);
      }
    }

    function endBattle(playerWon){
      battleActive = false;
      clearInterval(enemyTimer); enemyTimer = null;
      hudMask.style.display = "none";

      if (!battleTarget || !battleTarget.isConnected){ battleTarget = null; return; }

      const target = battleTarget;
      battleTarget = null;

      // å‹æ•—ã§å‡¦ç†
      if (playerWon){
        // ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆæ’ƒç ´åº§æ¨™ãƒ™ãƒ¼ã‚¹ï¼‰
        const atX = parseFloat(target.style.left) || 0;
        const atY = parseFloat(target.style.top)  || 0;
        dropLoot(target.__mon, atX, atY);


        // ãã®å ´ã§è‡ªç„¶æ¶ˆæ»… â†’ è£œå……
        target.classList.add("vanish");
        target.addEventListener("animationend", ()=>{
          target.remove();
          scheduleRespawn();
        }, { once:true });
      }else{
        // æ•—åŒ—ï¼šè‡ªç„¶æ¶ˆæ»… â†’ è£œå……
        target.classList.add("vanish");
        target.addEventListener("animationend", ()=>{
          target.remove();
          scheduleRespawn();
        }, { once:true });
      }
    }

    // ===== åˆæœŸã‚¹ãƒãƒ¼ãƒ³ï¼ˆ6ä½“ï¼‰ =====
    for (let i=0;i<MAX_ACTORS;i++) spawnActor();

    // å¿µã®ãŸã‚ã€å®šæœŸçš„ã«æ¬ å“¡ãŒã‚ã‚Œã°è£œå……ï¼ˆä¿é™ºï¼‰
    setInterval(()=>{
      if (!battleActive && countActors() < MAX_ACTORS) scheduleRespawn();
    }, 3000);
  </script>
  <!-- Firebaseï¼ˆå€‰åº«ä¿å­˜ç”¨ï¼‰ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
 import { getDatabase, ref, push, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // â˜…ã‚ãªãŸãŒä½¿ã£ã¦ã„ãŸè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDPe5cSCavq5gHopugdOfQ-9_50cTrqmyk",
    authDomain: "school-178c2.firebaseapp.com",
    databaseURL: "https://school-178c2-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "school-178c2",
    storageBucket: "school-178c2.firebasestorage.app",
    messagingSenderId: "409885673101",
    appId: "1:409885673101:web:25bf0483547e2d470304c4"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
// === ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€æ™‚åœæ­¢ãƒ•ãƒƒã‚¯ ===
(function installGlobalPause(db){
  let paused = false;

  // ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆç”Ÿæˆï¼‰
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed; inset:0; display:none; z-index:99999;
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    background: rgba(0,0,0,.65); color:#fff;
    font:600 18px/1.4 system-ui, -apple-system, "Noto Sans JP", sans-serif;
    align-items:center; justify-content:center; text-align:center; padding:24px;
  `;
  overlay.innerHTML = `
    <div style="max-width:740px;">
      <div style="font-size:22px; margin-bottom:8px;">ä¸€æ™‚åœæ­¢ä¸­</div>
      <div id="__pauseMsg" style="opacity:.9;"></div>
    </div>`;
  document.body.appendChild(overlay);
  const msgEl = overlay.querySelector('#__pauseMsg');

  // çŠ¶æ…‹è³¼èª­
  onValue(ref(db, 'game/control/state'), (snap)=>{
    const s = snap.exists()? snap.val(): null;
    paused = !!(s && s.paused);
    if (paused){
      msgEl.textContent = s?.message || 'ã‚ªãƒ¼ãƒŠãƒ¼ãŒä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ';
      overlay.style.display = 'flex';
    }else{
      overlay.style.display = 'none';
    }
  });

  // å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£æ®µéšã§æ­¢ã‚ã‚‹ï¼‰
  const block = (e)=>{ if (paused){ e.stopPropagation(); e.preventDefault(); } };
  ['click','mousedown','mouseup','touchstart','touchend','keydown','keyup','pointerdown','pointerup'].forEach(type=>{
    document.addEventListener(type, block, true);
  });

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢æ•°ç”¨ã‚¬ãƒ¼ãƒ‰ï¼ˆå¿…è¦ãªç®‡æ‰€ã§å‘¼ã¹ã‚‹ã‚ˆã†ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–ï¼‰
  window.assertNotPaused = function(){
    if (paused) throw new Error('PAUSED');
  };
})(db);

  // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã®ã€Œå€‰åº«ã€ãƒœã‚¿ãƒ³ï¼‰ã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«export
  window.firebaseDB = { db, ref, push, runTransaction };
</script>

</body>
</html>











