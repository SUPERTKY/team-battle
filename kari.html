<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>撃破ドロップ＆自動リロード＆多キャラ対応</title>
  <style>
    /* === Inventory UI（TURIと同じ見た目） === */
/* === Inventory UI（TURI見た目・専用クラス） === */
.inv-hud{
  position:fixed; right:12px; top:12px; z-index:1300; display:flex; gap:8px;
}
.inv-btn{
  background:#0b1c26aa; border:1px solid #7ee0ff66; color:#dff7ff;
  padding:8px 12px; border-radius:10px; backdrop-filter: blur(4px);
  font-weight:600; cursor:pointer;
}
.inv-btn:hover{ background:#0f2a36cc; }

.inv-panel{
  position:fixed; right:12px; top:56px; width:min(420px, calc(100vw - 24px));
  max-height:min(70vh, 520px); overflow:auto; z-index:1250;
  background:#06131bdf; border:1px solid #7ee0ff33; border-radius:12px;
  backdrop-filter: blur(6px); color:#e8fbff; padding:10px 10px 12px;
}
.inv-panel h3{ margin:6px 8px 8px; font-size:16px }
.inv-meta{ margin:0 8px 8px; font-size:12px; opacity:.8 }
.inv-list{ display:grid; grid-template-columns: 1fr auto; gap:6px 10px; padding:6px 8px; }

.inv-row{ display:contents }
.inv-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.inv-qty{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ffffff22 }
.inv-actions{ display:flex; gap:6px; }
.inv-action{
  background:#0b1c26aa; border:1px solid #7ee0ff44; color:#dff7ff;
  padding:4px 8px; border-radius:8px; cursor:pointer;
}
.inv-action:hover{ background:#0f2a36cc; }
.hidden{ display:none !important; }


    /* ===== インベントリUI ===== */
.top-controls{
  position:fixed; top:12px; right:12px; z-index:1300; display:flex; gap:8px;
}
.top-controls .btn{
  padding:10px 14px; border-radius:12px; border:1px solid rgba(0,0,0,0.15);
  background:#ffffffcc; backdrop-filter: blur(6px);
  font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  cursor:pointer;
}
..top-controls .btn:active{ transform: translateY(1px); }

.inventory{
  position:fixed; top:60px; right:12px; width:min(90vw, 320px);
  max-height:70vh; overflow:auto; z-index:1250;
  background:#0b1020ee; color:#e5e7eb; border:1px solid rgba(255,255,255,0.12);
  border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,0.45);
  transform: translateX(120%); transition: transform 220ms ease;
}
.inventory.open{ transform: translateX(0); }
.inv-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.08);
  position:sticky; top:0; background:inherit; z-index:1;
}
.inv-list{ padding:10px 12px 14px; }
.inv-item{
  display:grid; grid-template-columns: 1fr auto; align-items:center;
  gap:8px; padding:8px 10px; border-radius:10px;
  background:#0f172ae6; border:1px solid rgba(255,255,255,0.06);
  margin-bottom:8px;
}
.inv-name{ font-weight:700; }
.inv-qty{ font-weight:800; }
.inv-total.pulse{ animation: invpulse 420ms ease; }
@keyframes invpulse{
  0%{ transform:scale(1); }
  40%{ transform:scale(1.15); }
  100%{ transform:scale(1); }
}

    html, body { margin:0; height:100%; }
    .stage{
      position:relative; width:100vw; height:100vh; overflow:hidden;
      background: url("assets/sougen.png") center/cover no-repeat;
    }

    /* 透明の移動範囲（下 9分の4） */
    .bottom-rect{
      position:absolute; left:0; right:0; bottom:0;
      height:44.44vh; background: transparent;
      pointer-events:none; z-index:10;
    }

    /* キャラレイヤ（移動範囲と同サイズ） */
    .actors-layer{
      position:absolute; left:0; right:0; bottom:0; height:44.44vh;
      pointer-events:none; z-index:20;
    }

    .actor{
      position:absolute; width:144px; height:auto;
      pointer-events:auto; user-select:none; -webkit-user-drag:none;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.35));
      transition: transform 120ms ease, filter 80ms ease;
      will-change: left, top, transform, filter;
    }
    .actor:active{ transform:scale(0.96); }

    /* 下にいるほど手前（z-index はJSで更新） */

    /* 消え方：自然フェード＋縮小 */
    @keyframes vanish {
      0%   { opacity:1; transform: translateY(0)   scale(1)    }
      60%  { opacity:.6; transform: translateY(6px) scale(.9)  }
      100% { opacity:0; transform: translateY(12px) scale(.75) }
    }
    .vanish { animation: vanish 380ms ease forwards; }

    /* 被弾（赤フラッシュ） */
    .actor.hurt{
      filter:
        drop-shadow(0 4px 8px rgba(0,0,0,0.35))
        grayscale(1) sepia(1) saturate(8000%) hue-rotate(-8deg)
        brightness(1.15) contrast(1.1);
    }

    /* ===== バトルHUD（押し合いゲージ：青vs赤） ===== */
    .hud-mask{
      position:fixed; inset:0; background: rgba(0,0,0,0.3);
      display:none; align-items:center; justify-content:center;
      z-index:1000; backdrop-filter: blur(2px);
    }
    .hud{
      width:min(92vw, 720px); background:#0b1020ee; color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.12); border-radius:14px;
      box-shadow:0 20px 50px rgba(0,0,0,0.45);
      padding:16px 18px 20px; user-select:none;
      font:600 14px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    .hud-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; font-weight:700; }
    .vs-row{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; opacity:.9; }

    .gauge{ position:relative; height:28px; border-radius:999px; overflow:hidden;
      background:#0a0f1a; border:1px solid #ffffff14; }
    .gauge .blue{
      position:absolute; left:0; top:0; bottom:0; width:50%;
      background: linear-gradient(90deg,#38bdf8,#22c55e);
      transition: width 40ms linear;
    }
    .gauge .red{
      position:absolute; right:0; top:0; bottom:0; width:50%;
      background: linear-gradient(90deg,#ef4444,#f97316);
      transition: width 40ms linear;
    }
    .gauge .divider{
      position:absolute; top:0; bottom:0; width:2px; left:50%;
      background: #ffffff33; box-shadow: 0 0 10px #ffffff55;
      transition: left 40ms linear;
    }
    .tap-hint{ margin-top:8px; text-align:center; font-size:12px; opacity:.85; }
    .enemy-throb{ animation: throb 140ms ease; }
    @keyframes throb{
      0%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
      50%{ box-shadow: inset 0 0 28px 0 rgba(255,255,255,0.15);}
      100%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
    }

    /* ===== ドロップ表示（食材） ===== */
    .loot{
      position:absolute; padding:6px 10px; border-radius:12px;
      background:#111827e6; color:#fff; font:700 12px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      border:1px solid rgba(255,255,255,0.1); pointer-events:none;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,0.45));
      animation: loot-pop 1100ms ease forwards;
      z-index: 2000;
    }
    @keyframes loot-pop{
      0%   { transform: translateY(0) scale(.9); opacity:0 }
      15%  { transform: translateY(-8px) scale(1.02); opacity:1 }
      70%  { transform: translateY(-16px) scale(1); opacity:1 }
      100% { transform: translateY(-26px) scale(.98); opacity:0 }
    }

    /* “キャラをゲット！” トースト（非モーダル） */
    .toast{
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      background:#111827e6; color:#fff; padding:10px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12); z-index:1200;
      font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      animation: toast-in 300ms ease, toast-out 300ms ease 1400ms forwards;
    }
    @keyframes toast-in{ from{opacity:0; transform:translate(-50%,-6px)} to{opacity:1; transform:translate(-50%,0)} }
    @keyframes toast-out{ to{ opacity:0; transform:translate(-50%,-8px) } }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bottom-rect"></div>
    <div class="actors-layer" id="actorsLayer"></div>
  </div>

  <!-- バトルHUD -->
  <div class="hud-mask" id="hudMask">
    <div class="hud" id="hud">
      <div class="hud-title">
        <span>バトル中…連打で前線を押し上げろ！</span>
        <span id="timerLbl"></span>
      </div>
      <div class="vs-row">
        <span>あなた（青）</span><span>VS</span><span id="enemyNameLbl">モンスター（赤）</span>
      </div>
      <div class="gauge" id="gauge">
        <div class="blue" id="blueFill"></div>
        <div class="red"  id="redFill"></div>
        <div class="divider" id="divider"></div>
      </div>
      <div class="tap-hint">このパネルを連打！ 押し切れば勝ち（撃破と同時にドロップ）</div>
    </div>
  </div>
  <!-- インベントリ開閉ボタン -->
<div id="invPanel" class="inv-panel hidden">
  <h3>インベントリ</h3>
  <div class="meta" id="invMeta">合計 0 個</div>
  <div class="list" id="invList"></div>
</div>
<div class="inv-hud">
   <button id="invBtn" class="inv-btn">🎣 インベントリ</button>
 </div>

  <script>
    // === 共通 TEAM 解決（?team=2 など → localStorage → 既定 'team1'） ===
const TEAM = (() => {
  const m = location.search.match(/[?&]team=(\d+)/);
  const t = m ? `team${m[1]}` : (localStorage.getItem('selected_team') || 'team1');
  localStorage.setItem('selected_team', t); // 他ページ（調理場など）と共有
  return t;
})();

    // ===== モンスター定義（ここに種類を増やせる） =====
    const MONSTERS = [

        {
    id: "flame_wolf",
    name: "フレイムウルフ",
    strength: 3.0,
          frames: ["assets/hureimuuruhu1frame.png", "assets/hureimuuruhu2frame.png"],
    drops: ["フレイムグリース","フレイムメンブレン"]
          
  },

 {
    id: "shadow_bat",
    name: "シャドウバット",
    strength: 2.5,
   frames: ["assets/teki/syadoubatto1frame.png", "assets/teki/syadoubaddo2frame.png"],
    drops: ["シャドウフルーツ","ナイトハニー"]
   
  },
{
    id: "giant_beetle",
    name: "ジャイアントビートル",
    strength: 3.5,
   frames: ["assets/teki/zyainantbi-toru1frame.png", "assets/teki/zyaiantbi-toru2frame.png"],
    drops: ["ビートルハニー","ビートルナッツ"]
  },
{
    id: "moon_spirit",
    name: "ムーンスピリット",
    strength: 4.0,
   frames: ["assets/teki/mu-nsupiritto1frame.png", "assets/teki/mu-nsupiritto1frame.png"],
    drops: ["ムーンパウダー","スピリットエキス"]
  },
{
    id: "glow_worm",
    name: "グロウワーム",
    strength: 1.5,
   frames: ["assets/teki/gurouwa-mu1frame.png", "assets/teki/gurouwa-mu2frame.png"],
    drops: ["グロウジェル","ライトダスト"]
  },
 {
    id: "abyss_dragon",
    name: "アビスドラゴン",
    strength: 5.0,
    frames: ["assets/teki/abisudoragon1frame.png", "assets/teki/abisudoragon2frame.png"],
    drops: ["ドラゴンミート","ドラゴンエッグ"]
  }

    ];

    // ===== 調整用パラメータ =====
    const MAX_ACTORS = 6;
    const ACTOR_WIDTH = 144, ACTOR_HEIGHT = 144;
    const WALK_FRAME_MS = 200, WALK_SPEED = 60;

    // バトル難易度（基準値・モンスター強さでスケール）
    const PLAYER_PUSH = 3.2;      // クリック1回で右へ何％進むか
    const ENEMY_BASE_PER_SEC = 0.35; // 敵の常時押し（％/秒）
    const ENEMY_BURST_POW   = 1.2;   // 敵のバースト1回の押し量（％）
    const BURST_MIN_MS = 340, BURST_MAX_MS = 620;

    // ===== 要素 =====
    const actorsLayer = document.getElementById("actorsLayer");
    const hudMask = document.getElementById("hudMask");
    const hud = document.getElementById("hud");
    const blueFill = document.getElementById("blueFill");
    const redFill  = document.getElementById("redFill");
    const divider  = document.getElementById("divider");
    const gaugeEl  = document.getElementById("gauge");
    const enemyNameLbl = document.getElementById("enemyNameLbl");
// ===== インベントリ =====
// ===== インベントリ（TURI見た目） =====
const INV_KEY = 'inventory_v1';
// 保持形式：{ total:number, byItem:{ [name]: qty } }
let inv = loadInv();

const invPanel = document.getElementById('invPanel');
const invBtn   = document.getElementById('invBtn');
const invMeta  = document.getElementById('invMeta');
const invList  = document.getElementById('invList');

function loadInv(){
  try{
    const raw = localStorage.getItem(INV_KEY);
    const obj = raw ? JSON.parse(raw) : {};
    // 旧形式（{名前:個数}）→ 新形式に自動変換
    if (!('total' in obj) || !('byItem' in obj)){
      const byItem = obj && typeof obj === 'object' ? obj : {};
      const total = Object.values(byItem).reduce((a,b)=> a+(b||0), 0);
      const neo = { total, byItem };
      localStorage.setItem(INV_KEY, JSON.stringify(neo));
      return neo;
    }
    return obj;
  }catch(_){
    return { total:0, byItem:{} };
  }
}
function saveInv(){ try{ localStorage.setItem(INV_KEY, JSON.stringify(inv)); }catch(_){} }

// 既存の dropLoot から呼ばれる想定
function addToInventory(name, qty=1){
  inv.total += qty;
  inv.byItem[name] = (inv.byItem[name]||0) + qty;
  saveInv();
  renderInventory();
  if (typeof showToast === 'function'){
    showToast(`+${qty} ${name} を入手（合計 ${inv.byItem[name]}）`);
  }
}

function renderInventory(){
  if(!invMeta || !invList) return;
  invMeta.textContent = `合計 ${inv.total} 個`;

  const entries = Object.entries(inv.byItem).sort((a,b)=> a[0].localeCompare(b[0],'ja'));
  invList.innerHTML = '';

  for (const [name, count] of entries){
    // 左列：名前
    const nameCell = document.createElement('div');
    nameCell.className = 'inv-row inv-name';
    nameCell.textContent = name;

    // 右列：数量＋操作
    const actionCell = document.createElement('div');
    actionCell.className = 'inv-row inv-actions';
    actionCell.innerHTML = `
   <span class="inv-qty">× ${count}</span>
   <button class="btnStore inv-action">倉庫</button>
   <button class="btnDrop inv-action">捨てる</button>
 `;

    // 倉庫（Firebase があれば保存）
    actionCell.querySelector('.btnStore').addEventListener('click', async ()=>{
      try{
const api = window.firebaseDB;
   if(!api) throw new Error('no-firebase');
   const { db, ref, runTransaction, push } = api;
   // 一時停止中なら何もしない（任意）
   try{ assertNotPaused(); }catch(_){ return; }
   // ① 集計ノードへ原子的に +1
  const node = ref(db, `warehouse/${TEAM}/byItem/${name}`);
   await runTransaction(node, cur => (cur || 0) + 1);
   // ②（任意）ログを残す
   await push(ref(db, `warehouse/${TEAM}/logs`), {
     item: name, delta: +1, ts: Date.now(), src: 'battle'
  });

        // 在庫を1つ減らす
        if (inv.byItem[name]){
          inv.total--;
          if (--inv.byItem[name] <= 0) delete inv.byItem[name];
          saveInv(); renderInventory();
          showToast?.(`${name} を倉庫にしまいました`);
        }
      }catch(e){
        showToast?.('倉庫にしまうには Firebase の設定が必要です');
      }
    });

    // 捨てる
    actionCell.querySelector('.btnDrop').addEventListener('click', ()=>{
      if (inv.byItem[name]){
        inv.total--;
        if (--inv.byItem[name] <= 0) delete inv.byItem[name];
        saveInv(); renderInventory();
        showToast?.(`${name} を捨てました`);
      }
    });

    invList.appendChild(nameCell);
    invList.appendChild(actionCell);
  }
}

// 開閉
invBtn?.addEventListener('click', ()=>{
  invPanel.classList.toggle('hidden');
});

// 初期描画
renderInventory();


    // ===== 共通ユーティリティ =====
    function rand(min,max){ return Math.random()*(max-min)+min; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

    // 下にいるほど前面
    function updateDepth(img){
      const y = parseFloat(img.style.top) || 0;
      img.style.zIndex = String(1000 + Math.floor(y));
    }

    function flashHurt(img){
      if (!img || !img.isConnected) return;
      img.classList.add("hurt");
      setTimeout(()=> img.classList.remove("hurt"), 120);
    }

    function showToast(text){
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1800);
    }

    // ===== スポーン＆歩行 =====
    function spawnActor(){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);
      const x = rand(0,maxX), y = rand(0,maxY);

      const monster = pick(MONSTERS);
      const img = new Image();
      img.src = monster.frames[0];
      img.className="actor";
      img.style.left=`${x}px`; img.style.top =`${y}px`;
      img.style.transform = "scaleX(1)";
      // 参照を持たせる（種類・フレーム・強さ・ドロップ）
      img.__mon = monster;

      actorsLayer.appendChild(img);
      updateDepth(img);

      // 歩行ループ開始
      scheduleWalk(img);

      // クリックでバトル
      img.addEventListener("click", (e)=>{
        e.stopPropagation();
        if (battleActive) return;
        startBattle(img);
      });

      return img;
    }

    // バトル中は休憩後に短い間隔で再トライして、終わったら必ず歩き出す
    function scheduleWalk(img){
      const rest = rand(1000, 4000); // 1〜4秒休憩
      setTimeout(function tryStart(){
        if (!img.isConnected) return;
        if (battleActive){
          setTimeout(tryStart, 400); // バトル中は0.4秒ごとに再試行
          return;
        }
        walkToRandom(img, ()=>{ scheduleWalk(img); });
      }, rest);
    }

    function walkToRandom(img, onFinish){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const targetX = rand(0,maxX), targetY = rand(0,maxY);
      const startX = parseFloat(img.style.left), startY = parseFloat(img.style.top);
      const dx = targetX - startX, dy = targetY - startY;
      const distance = Math.hypot(dx,dy);
      const duration = distance / WALK_SPEED * 1000;

      img.style.transform = (dx > 0) ? "scaleX(-1)" : "scaleX(1)";

      let startTime=null, toggle=false;
      const frameTimer=setInterval(()=>{
        if (!img.isConnected) { clearInterval(frameTimer); return; }
        toggle=!toggle; img.src = toggle ? img.__mon.frames[1] : img.__mon.frames[0];
      },WALK_FRAME_MS);

      function step(ts){
        if (!img.isConnected){ clearInterval(frameTimer); return; }
        if (!startTime) startTime=ts;
        const t=(ts-startTime)/duration;
        if (t>=1){
          img.style.left=`${targetX}px`; img.style.top =`${targetY}px`;
          updateDepth(img); clearInterval(frameTimer); img.src=img.__mon.frames[0];
          onFinish && onFinish(); return;
        }
        img.style.left=`${startX+dx*t}px`;
        img.style.top =`${startY+dy*t}px`;
        updateDepth(img);
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ===== 自動リロード（常に6体キープ） =====
    function countActors(){ return actorsLayer.querySelectorAll(".actor").length; }
    function scheduleRespawn(){
      // 少し間をおいて補充（演出のため）
      setTimeout(()=>{
        if (!battleActive && countActors() < MAX_ACTORS) spawnActor();
        // 万一複数欠けたら埋まるまで繰り返し
        while (!battleActive && countActors() < MAX_ACTORS) spawnActor();
      }, rand(400,1200));
    }

    // ===== バトル：押し合いゲージ（青vs赤） =====
    let battleActive = false, battleTarget = null, enemyTimer = null;
    let p = 50; // 青の前線位置（0〜100）

    function renderGauge(){
      const clamped = Math.max(0, Math.min(100, p));
      blueFill.style.width = clamped + "%";
      redFill.style.width  = (100 - clamped) + "%";
      divider.style.left   = clamped + "%";
    }

    function startBattle(targetImg){
      battleActive = true;
      battleTarget = targetImg;
      p = 50;
      renderGauge();

      enemyNameLbl.textContent = `${targetImg.__mon.name}（赤）`;
      hudMask.style.display = "flex";

      // 敵の強さで難易度スケール
      const s = targetImg.__mon.strength || 1.0;
      const enemyBasePerFrame = (ENEMY_BASE_PER_SEC * s) / 60;
      const burstPow = ENEMY_BURST_POW * s;

      // 敵の押し（60fps相当）
      let lastBurstAt = performance.now();
      enemyTimer = setInterval(()=>{
        if (!battleActive) return;
        p -= enemyBasePerFrame; // 敵が押す＝左へ

        const now = performance.now();
        if (now - lastBurstAt > rand(BURST_MIN_MS, BURST_MAX_MS)){
          p -= burstPow;
          lastBurstAt = now;
          // バチバチ演出
          gaugeEl.classList.remove("enemy-throb");
          void gaugeEl.offsetWidth;
          gaugeEl.classList.add("enemy-throb");
        }

        if (p <= 0){
          endBattle(false); // 敗北
        }else{
          renderGauge();
        }
      }, 16);

      // プレイヤーの連打（青を右へ）
      hud.onclick = ()=>{
        if (!battleActive) return;
        flashHurt(battleTarget); // 被弾フラッシュ
        const push = PLAYER_PUSH * (0.9 + Math.random()*0.2);
        p += push;
        if (p >= 100){
          endBattle(true);  // 勝利
        }else{
          renderGauge();
        }
      };
    }

    function dropLoot(mon, atX, atY){
      // mon.drops から 1〜2個ランダムでドロップ
      const count = Math.random() < 0.35 ? 2 : 1;
      for (let i=0;i<count;i++){
        const item = pick(mon.drops);
        const el = document.createElement("div");
        // 既存の for ループ内、item を決めた直後に追加
addToInventory(item, 1);

        el.className = "loot";
        el.textContent = `入手：${item}`;
        // 表示位置（撃破位置のちょい上）
        const x = atX + ACTOR_WIDTH/2 - 36 + rand(-14,14);
        const y = atY - 6 + rand(-6,6);
        el.style.left = `${x}px`;
        el.style.top  = `${y}px`;
        actorsLayer.appendChild(el);
        setTimeout(()=> el.remove(), 1100);
      }
    }

    function endBattle(playerWon){
      battleActive = false;
      clearInterval(enemyTimer); enemyTimer = null;
      hudMask.style.display = "none";

      if (!battleTarget || !battleTarget.isConnected){ battleTarget = null; return; }

      const target = battleTarget;
      battleTarget = null;

      // 勝敗で処理
      if (playerWon){
        // ドロップ（撃破座標ベース）
        const atX = parseFloat(target.style.left) || 0;
        const atY = parseFloat(target.style.top)  || 0;
        dropLoot(target.__mon, atX, atY);


        // その場で自然消滅 → 補充
        target.classList.add("vanish");
        target.addEventListener("animationend", ()=>{
          target.remove();
          scheduleRespawn();
        }, { once:true });
      }else{
        // 敗北：自然消滅 → 補充
        target.classList.add("vanish");
        target.addEventListener("animationend", ()=>{
          target.remove();
          scheduleRespawn();
        }, { once:true });
      }
    }

    // ===== 初期スポーン（6体） =====
    for (let i=0;i<MAX_ACTORS;i++) spawnActor();

    // 念のため、定期的に欠員があれば補充（保険）
    setInterval(()=>{
      if (!battleActive && countActors() < MAX_ACTORS) scheduleRespawn();
    }, 3000);
  </script>
  <!-- Firebase（倉庫保存用） -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
 import { getDatabase, ref, push, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // ★あなたが使っていた設定
  const firebaseConfig = {
    apiKey: "AIzaSyDPe5cSCavq5gHopugdOfQ-9_50cTrqmyk",
    authDomain: "school-178c2.firebaseapp.com",
    databaseURL: "https://school-178c2-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "school-178c2",
    storageBucket: "school-178c2.firebasestorage.app",
    messagingSenderId: "409885673101",
    appId: "1:409885673101:web:25bf0483547e2d470304c4"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
// === グローバル一時停止フック ===
(function installGlobalPause(db){
  let paused = false;

  // 画面オーバーレイ（生成）
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position:fixed; inset:0; display:none; z-index:99999;
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    background: rgba(0,0,0,.65); color:#fff;
    font:600 18px/1.4 system-ui, -apple-system, "Noto Sans JP", sans-serif;
    align-items:center; justify-content:center; text-align:center; padding:24px;
  `;
  overlay.innerHTML = `
    <div style="max-width:740px;">
      <div style="font-size:22px; margin-bottom:8px;">一時停止中</div>
      <div id="__pauseMsg" style="opacity:.9;"></div>
    </div>`;
  document.body.appendChild(overlay);
  const msgEl = overlay.querySelector('#__pauseMsg');

  // 状態購読
  onValue(ref(db, 'game/control/state'), (snap)=>{
    const s = snap.exists()? snap.val(): null;
    paused = !!(s && s.paused);
    if (paused){
      msgEl.textContent = s?.message || 'オーナーが一時停止しました';
      overlay.style.display = 'flex';
    }else{
      overlay.style.display = 'none';
    }
  });

  // 入力ブロック（キャプチャ段階で止める）
  const block = (e)=>{ if (paused){ e.stopPropagation(); e.preventDefault(); } };
  ['click','mousedown','mouseup','touchstart','touchend','keydown','keyup','pointerdown','pointerup'].forEach(type=>{
    document.addEventListener(type, block, true);
  });

  // アクション関数用ガード（必要な箇所で呼べるようにグローバル化）
  window.assertNotPaused = function(){
    if (paused) throw new Error('PAUSED');
  };
})(db);

  // 他のスクリプト（インベントリの「倉庫」ボタン）から使えるようにexport
  window.firebaseDB = { db, ref, push, runTransaction };
</script>

</body>
</html>











