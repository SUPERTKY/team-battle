<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>キャラの向きを移動方向に合わせる</title>
  <style>
    html, body { margin:0; height:100%; }
    .stage{
      position:relative; width:100vw; height:100vh; overflow:hidden;
      background: url("assets/sougen.png") center/cover no-repeat;
    }

    .bottom-rect{
      position:absolute; left:0; right:0; bottom:0;
      height:44.44vh; background: transparent;
      pointer-events:none; z-index:10;
    }

    .actors-layer{
      position:absolute; left:0; right:0; bottom:0; height:44.44vh;
      pointer-events:none; z-index:20;
    }

    .actor{
      position:absolute; width:144px; height:auto;
      pointer-events:auto; user-select:none; -webkit-user-drag:none;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.35));
      transition: transform 120ms ease;
    }
    .actor:active{ transform:scale(0.96); }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bottom-rect"></div>
    <div class="actors-layer" id="actorsLayer"></div>
  </div>

  <script>
    const FRAME1_SRC = "assets/suraimu1frame.png";
    const FRAME2_SRC = "assets/suraimu2frame.png";

    const MAX_ACTORS = 6;
    const ACTOR_WIDTH = 144;
    const ACTOR_HEIGHT = 144;

    const WALK_FRAME_MS = 200;
    const WALK_SPEED = 60;

    const actorsLayer = document.getElementById("actorsLayer");

    function rand(min,max){ return Math.random()*(max-min)+min; }

    function spawnActor(){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const x = rand(0,maxX);
      const y = rand(0,maxY);

      const img = document.createElement("img");
      img.src = FRAME1_SRC;
      img.className="actor";
      img.style.left=`${x}px`;
      img.style.top =`${y}px`;
      img.style.transform = "scaleX(1)"; // デフォルトは左向き

      actorsLayer.appendChild(img);

      // 歩行ループ開始
      scheduleWalk(img);

      // クリックで削除
      img.addEventListener("click", ()=> img.remove());
    }

    function scheduleWalk(img){
      setTimeout(()=>{
        if (!img.isConnected) return;
        walkToRandom(img, ()=> scheduleWalk(img));
      }, rand(1000,4000));
    }

    function walkToRandom(img, onFinish){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const targetX = rand(0,maxX);
      const targetY = rand(0,maxY);

      const startX = parseFloat(img.style.left);
      const startY = parseFloat(img.style.top);
      const dx = targetX - startX;
      const dy = targetY - startY;
      const distance = Math.hypot(dx,dy);
      const duration = distance / WALK_SPEED * 1000;

      // 向きを決定
      if (dx > 0){
        img.style.transform = "scaleX(-1)"; // 右向き
      } else {
        img.style.transform = "scaleX(1)";  // 左向き
      }

      let startTime=null;
      let toggle=false;
      const frameTimer=setInterval(()=>{
        toggle=!toggle;
        img.src = toggle ? FRAME2_SRC : FRAME1_SRC;
      },WALK_FRAME_MS);

      function step(ts){
        if (!startTime) startTime=ts;
        const t=(ts-startTime)/duration;
        if (t>=1){
          img.style.left=`${targetX}px`;
          img.style.top =`${targetY}px`;
          clearInterval(frameTimer);
          img.src=FRAME1_SRC; // 静止
          if(onFinish) onFinish();
          return;
        }
        img.style.left=`${startX+dx*t}px`;
        img.style.top =`${startY+dy*t}px`;
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // --- 初期スポーン ---
    for (let i=0;i<MAX_ACTORS;i++){
      spawnActor();
    }
  </script>
</body>
</html>
