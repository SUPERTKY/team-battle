<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ’ƒç ´ãƒ‰ãƒ­ãƒƒãƒ—ï¼†è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼†å¤šã‚­ãƒ£ãƒ©å¯¾å¿œ</title>
  <style>
    /* ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªUI ===== */
.top-controls{
  position:fixed; top:12px; right:12px; z-index:1300; display:flex; gap:8px;
}
.btn{
  padding:10px 14px; border-radius:12px; border:1px solid rgba(0,0,0,0.15);
  background:#ffffffcc; backdrop-filter: blur(6px);
  font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  cursor:pointer;
}
.btn:active{ transform: translateY(1px); }

.inventory{
  position:fixed; top:60px; right:12px; width:min(90vw, 320px);
  max-height:70vh; overflow:auto; z-index:1250;
  background:#0b1020ee; color:#e5e7eb; border:1px solid rgba(255,255,255,0.12);
  border-radius:14px; box-shadow:0 16px 40px rgba(0,0,0,0.45);
  transform: translateX(120%); transition: transform 220ms ease;
}
.inventory.open{ transform: translateX(0); }
.inv-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; border-bottom:1px solid rgba(255,255,255,0.08);
  position:sticky; top:0; background:inherit; z-index:1;
}
.inv-list{ padding:10px 12px 14px; }
.inv-item{
  display:grid; grid-template-columns: 1fr auto; align-items:center;
  gap:8px; padding:8px 10px; border-radius:10px;
  background:#0f172ae6; border:1px solid rgba(255,255,255,0.06);
  margin-bottom:8px;
}
.inv-name{ font-weight:700; }
.inv-qty{ font-weight:800; }
.inv-total.pulse{ animation: invpulse 420ms ease; }
@keyframes invpulse{
  0%{ transform:scale(1); }
  40%{ transform:scale(1.15); }
  100%{ transform:scale(1); }
}

    html, body { margin:0; height:100%; }
    .stage{
      position:relative; width:100vw; height:100vh; overflow:hidden;
      background: url("assets/sougen.png") center/cover no-repeat;
    }

    /* é€æ˜ã®ç§»å‹•ç¯„å›²ï¼ˆä¸‹ 9åˆ†ã®4ï¼‰ */
    .bottom-rect{
      position:absolute; left:0; right:0; bottom:0;
      height:44.44vh; background: transparent;
      pointer-events:none; z-index:10;
    }

    /* ã‚­ãƒ£ãƒ©ãƒ¬ã‚¤ãƒ¤ï¼ˆç§»å‹•ç¯„å›²ã¨åŒã‚µã‚¤ã‚ºï¼‰ */
    .actors-layer{
      position:absolute; left:0; right:0; bottom:0; height:44.44vh;
      pointer-events:none; z-index:20;
    }

    .actor{
      position:absolute; width:144px; height:auto;
      pointer-events:auto; user-select:none; -webkit-user-drag:none;
      filter:drop-shadow(0 4px 8px rgba(0,0,0,0.35));
      transition: transform 120ms ease, filter 80ms ease;
      will-change: left, top, transform, filter;
    }
    .actor:active{ transform:scale(0.96); }

    /* ä¸‹ã«ã„ã‚‹ã»ã©æ‰‹å‰ï¼ˆz-index ã¯JSã§æ›´æ–°ï¼‰ */

    /* æ¶ˆãˆæ–¹ï¼šè‡ªç„¶ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‹ç¸®å° */
    @keyframes vanish {
      0%   { opacity:1; transform: translateY(0)   scale(1)    }
      60%  { opacity:.6; transform: translateY(6px) scale(.9)  }
      100% { opacity:0; transform: translateY(12px) scale(.75) }
    }
    .vanish { animation: vanish 380ms ease forwards; }

    /* è¢«å¼¾ï¼ˆèµ¤ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰ */
    .actor.hurt{
      filter:
        drop-shadow(0 4px 8px rgba(0,0,0,0.35))
        grayscale(1) sepia(1) saturate(8000%) hue-rotate(-8deg)
        brightness(1.15) contrast(1.1);
    }

    /* ===== ãƒãƒˆãƒ«HUDï¼ˆæŠ¼ã—åˆã„ã‚²ãƒ¼ã‚¸ï¼šé’vsèµ¤ï¼‰ ===== */
    .hud-mask{
      position:fixed; inset:0; background: rgba(0,0,0,0.3);
      display:none; align-items:center; justify-content:center;
      z-index:1000; backdrop-filter: blur(2px);
    }
    .hud{
      width:min(92vw, 720px); background:#0b1020ee; color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.12); border-radius:14px;
      box-shadow:0 20px 50px rgba(0,0,0,0.45);
      padding:16px 18px 20px; user-select:none;
      font:600 14px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    .hud-title{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; font-weight:700; }
    .vs-row{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; opacity:.9; }

    .gauge{ position:relative; height:28px; border-radius:999px; overflow:hidden;
      background:#0a0f1a; border:1px solid #ffffff14; }
    .gauge .blue{
      position:absolute; left:0; top:0; bottom:0; width:50%;
      background: linear-gradient(90deg,#38bdf8,#22c55e);
      transition: width 40ms linear;
    }
    .gauge .red{
      position:absolute; right:0; top:0; bottom:0; width:50%;
      background: linear-gradient(90deg,#ef4444,#f97316);
      transition: width 40ms linear;
    }
    .gauge .divider{
      position:absolute; top:0; bottom:0; width:2px; left:50%;
      background: #ffffff33; box-shadow: 0 0 10px #ffffff55;
      transition: left 40ms linear;
    }
    .tap-hint{ margin-top:8px; text-align:center; font-size:12px; opacity:.85; }
    .enemy-throb{ animation: throb 140ms ease; }
    @keyframes throb{
      0%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
      50%{ box-shadow: inset 0 0 28px 0 rgba(255,255,255,0.15);}
      100%{ box-shadow: inset 0 0 0 0 rgba(255,255,255,0.0);}
    }

    /* ===== ãƒ‰ãƒ­ãƒƒãƒ—è¡¨ç¤ºï¼ˆé£Ÿæï¼‰ ===== */
    .loot{
      position:absolute; padding:6px 10px; border-radius:12px;
      background:#111827e6; color:#fff; font:700 12px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      border:1px solid rgba(255,255,255,0.1); pointer-events:none;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,0.45));
      animation: loot-pop 1100ms ease forwards;
      z-index: 2000;
    }
    @keyframes loot-pop{
      0%   { transform: translateY(0) scale(.9); opacity:0 }
      15%  { transform: translateY(-8px) scale(1.02); opacity:1 }
      70%  { transform: translateY(-16px) scale(1); opacity:1 }
      100% { transform: translateY(-26px) scale(.98); opacity:0 }
    }

    /* â€œã‚­ãƒ£ãƒ©ã‚’ã‚²ãƒƒãƒˆï¼â€ ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆéãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */
    .toast{
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      background:#111827e6; color:#fff; padding:10px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.12); z-index:1200;
      font:700 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      animation: toast-in 300ms ease, toast-out 300ms ease 1400ms forwards;
    }
    @keyframes toast-in{ from{opacity:0; transform:translate(-50%,-6px)} to{opacity:1; transform:translate(-50%,0)} }
    @keyframes toast-out{ to{ opacity:0; transform:translate(-50%,-8px) } }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bottom-rect"></div>
    <div class="actors-layer" id="actorsLayer"></div>
  </div>

  <!-- ãƒãƒˆãƒ«HUD -->
  <div class="hud-mask" id="hudMask">
    <div class="hud" id="hud">
      <div class="hud-title">
        <span>ãƒãƒˆãƒ«ä¸­â€¦é€£æ‰“ã§å‰ç·šã‚’æŠ¼ã—ä¸Šã’ã‚ï¼</span>
        <span id="timerLbl"></span>
      </div>
      <div class="vs-row">
        <span>ã‚ãªãŸï¼ˆé’ï¼‰</span><span>VS</span><span id="enemyNameLbl">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ï¼ˆèµ¤ï¼‰</span>
      </div>
      <div class="gauge" id="gauge">
        <div class="blue" id="blueFill"></div>
        <div class="red"  id="redFill"></div>
        <div class="divider" id="divider"></div>
      </div>
      <div class="tap-hint">ã“ã®ãƒ‘ãƒãƒ«ã‚’é€£æ‰“ï¼ æŠ¼ã—åˆ‡ã‚Œã°å‹ã¡ï¼ˆæ’ƒç ´ã¨åŒæ™‚ã«ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰</div>
    </div>
  </div>
  <!-- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªé–‹é–‰ãƒœã‚¿ãƒ³ -->
<div class="top-controls">
  <button class="btn" id="invToggle">ğŸ’ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª <span class="inv-total" id="invTotal">(0)</span></button>
</div>

<!-- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ‘ãƒãƒ« -->
<div class="inventory" id="inventory">
  <div class="inv-header">
    <span style="font-weight:800">ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</span>
    <span class="inv-total" id="invTotal2">0å€‹</span>
  </div>
  <div class="inv-list" id="invList"></div>
</div>

  <script>
    // ===== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å®šç¾©ï¼ˆã“ã“ã«ç¨®é¡ã‚’å¢—ã‚„ã›ã‚‹ï¼‰ =====
    const MONSTERS = [
      {
        id: "slime",
        name: "ã‚¹ãƒ©ã‚¤ãƒ ",
        strength: 1.0, // å¼·ã•ï¼ˆå¤§ãã„ã»ã©æ•µãŒå¼·ã„ï¼‰
        frames: ["assets/suraimu1frame.png", "assets/suraimu2frame.png"],
        drops: ["ã‚¹ãƒ©ã‚¤ãƒ "], // â˜…åˆæœŸã¯ã€Œã‚¹ãƒ©ã‚¤ãƒ ã€é£Ÿæã€‚è¤‡æ•°OKï¼ˆä¾‹: ["ã‚¹ãƒ©ã‚¤ãƒ ","ã­ã°ã­ã°è‰"]ï¼‰
      },
      // è¿½åŠ ä¾‹ï¼š
      // {
      //   id: "goblin",
      //   name: "ã‚´ãƒ–ãƒªãƒ³",
      //   strength: 1.3,
      //   frames: ["assets/goblin1.png", "assets/goblin2.png"],
      //   drops: ["ç¡¬ã„è‚‰","éª¨"],
      // },
    ];

    // ===== èª¿æ•´ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ =====
    const MAX_ACTORS = 6;
    const ACTOR_WIDTH = 144, ACTOR_HEIGHT = 144;
    const WALK_FRAME_MS = 200, WALK_SPEED = 60;

    // ãƒãƒˆãƒ«é›£æ˜“åº¦ï¼ˆåŸºæº–å€¤ãƒ»ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å¼·ã•ã§ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    const PLAYER_PUSH = 3.2;      // ã‚¯ãƒªãƒƒã‚¯1å›ã§å³ã¸ä½•ï¼…é€²ã‚€ã‹
    const ENEMY_BASE_PER_SEC = 0.35; // æ•µã®å¸¸æ™‚æŠ¼ã—ï¼ˆï¼…/ç§’ï¼‰
    const ENEMY_BURST_POW   = 1.2;   // æ•µã®ãƒãƒ¼ã‚¹ãƒˆ1å›ã®æŠ¼ã—é‡ï¼ˆï¼…ï¼‰
    const BURST_MIN_MS = 340, BURST_MAX_MS = 620;

    // ===== è¦ç´  =====
    const actorsLayer = document.getElementById("actorsLayer");
    const hudMask = document.getElementById("hudMask");
    const hud = document.getElementById("hud");
    const blueFill = document.getElementById("blueFill");
    const redFill  = document.getElementById("redFill");
    const divider  = document.getElementById("divider");
    const gaugeEl  = document.getElementById("gauge");
    const enemyNameLbl = document.getElementById("enemyNameLbl");
// ===== ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª =====
const INV_KEY = "inventory_v1";
let inventory = {}; // { ã‚¢ã‚¤ãƒ†ãƒ å: å€‹æ•° }

const invToggle = document.getElementById("invToggle");
const invPanel  = document.getElementById("inventory");
const invList   = document.getElementById("invList");
const invTotal  = document.getElementById("invTotal");
const invTotal2 = document.getElementById("invTotal2");

function loadInventory(){
  try{
    const raw = localStorage.getItem(INV_KEY);
    inventory = raw ? JSON.parse(raw) : {};
  }catch(e){ inventory = {}; }
}
function saveInventory(){
  try{ localStorage.setItem(INV_KEY, JSON.stringify(inventory)); }catch(e){}
}
function getInvTotal(){
  return Object.values(inventory).reduce((a,b)=> a + (b||0), 0);
}
function renderInventory(){
  invList.innerHTML = "";
  Object.entries(inventory).forEach(([name, qty])=>{
    const row = document.createElement("div");
    row.className = "inv-item";
    row.innerHTML = `
      <div class="inv-name">${name}</div>
      <div class="inv-qty">Ã— ${qty}</div>
    `;
    invList.appendChild(row);
  });
  const total = getInvTotal();
  invTotal.textContent  = `(${total})`;
  invTotal2.textContent = `${total}å€‹`;
}
function bumpTotal(){
  invTotal.classList.add("pulse");
  invTotal2.classList.add("pulse");
  setTimeout(()=>{ invTotal.classList.remove("pulse"); invTotal2.classList.remove("pulse"); }, 420);
}
function addToInventory(name, qty=1){
  inventory[name] = (inventory[name]||0) + qty;
  saveInventory();
  renderInventory();
  bumpTotal();
}

// é–‹é–‰
invToggle?.addEventListener("click", ()=>{
  invPanel.classList.toggle("open");
});

// åˆæœŸãƒ­ãƒ¼ãƒ‰
loadInventory();
renderInventory();

    // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function rand(min,max){ return Math.random()*(max-min)+min; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }

    // ä¸‹ã«ã„ã‚‹ã»ã©å‰é¢
    function updateDepth(img){
      const y = parseFloat(img.style.top) || 0;
      img.style.zIndex = String(1000 + Math.floor(y));
    }

    function flashHurt(img){
      if (!img || !img.isConnected) return;
      img.classList.add("hurt");
      setTimeout(()=> img.classList.remove("hurt"), 120);
    }

    function showToast(text){
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1800);
    }

    // ===== ã‚¹ãƒãƒ¼ãƒ³ï¼†æ­©è¡Œ =====
    function spawnActor(){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);
      const x = rand(0,maxX), y = rand(0,maxY);

      const monster = pick(MONSTERS);
      const img = new Image();
      img.src = monster.frames[0];
      img.className="actor";
      img.style.left=`${x}px`; img.style.top =`${y}px`;
      img.style.transform = "scaleX(1)";
      // å‚ç…§ã‚’æŒãŸã›ã‚‹ï¼ˆç¨®é¡ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»å¼·ã•ãƒ»ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
      img.__mon = monster;

      actorsLayer.appendChild(img);
      updateDepth(img);

      // æ­©è¡Œãƒ«ãƒ¼ãƒ—é–‹å§‹
      scheduleWalk(img);

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒˆãƒ«
      img.addEventListener("click", (e)=>{
        e.stopPropagation();
        if (battleActive) return;
        startBattle(img);
      });

      return img;
    }

    // ãƒãƒˆãƒ«ä¸­ã¯ä¼‘æ†©å¾Œã«çŸ­ã„é–“éš”ã§å†ãƒˆãƒ©ã‚¤ã—ã¦ã€çµ‚ã‚ã£ãŸã‚‰å¿…ãšæ­©ãå‡ºã™
    function scheduleWalk(img){
      const rest = rand(1000, 4000); // 1ã€œ4ç§’ä¼‘æ†©
      setTimeout(function tryStart(){
        if (!img.isConnected) return;
        if (battleActive){
          setTimeout(tryStart, 400); // ãƒãƒˆãƒ«ä¸­ã¯0.4ç§’ã”ã¨ã«å†è©¦è¡Œ
          return;
        }
        walkToRandom(img, ()=>{ scheduleWalk(img); });
      }, rest);
    }

    function walkToRandom(img, onFinish){
      const rect = actorsLayer.getBoundingClientRect();
      const maxX = Math.max(0, rect.width - ACTOR_WIDTH);
      const maxY = Math.max(0, rect.height - ACTOR_HEIGHT);

      const targetX = rand(0,maxX), targetY = rand(0,maxY);
      const startX = parseFloat(img.style.left), startY = parseFloat(img.style.top);
      const dx = targetX - startX, dy = targetY - startY;
      const distance = Math.hypot(dx,dy);
      const duration = distance / WALK_SPEED * 1000;

      img.style.transform = (dx > 0) ? "scaleX(-1)" : "scaleX(1)";

      let startTime=null, toggle=false;
      const frameTimer=setInterval(()=>{
        if (!img.isConnected) { clearInterval(frameTimer); return; }
        toggle=!toggle; img.src = toggle ? img.__mon.frames[1] : img.__mon.frames[0];
      },WALK_FRAME_MS);

      function step(ts){
        if (!img.isConnected){ clearInterval(frameTimer); return; }
        if (!startTime) startTime=ts;
        const t=(ts-startTime)/duration;
        if (t>=1){
          img.style.left=`${targetX}px`; img.style.top =`${targetY}px`;
          updateDepth(img); clearInterval(frameTimer); img.src=img.__mon.frames[0];
          onFinish && onFinish(); return;
        }
        img.style.left=`${startX+dx*t}px`;
        img.style.top =`${startY+dy*t}px`;
        updateDepth(img);
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // ===== è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå¸¸ã«6ä½“ã‚­ãƒ¼ãƒ—ï¼‰ =====
    function countActors(){ return actorsLayer.querySelectorAll(".actor").length; }
    function scheduleRespawn(){
      // å°‘ã—é–“ã‚’ãŠã„ã¦è£œå……ï¼ˆæ¼”å‡ºã®ãŸã‚ï¼‰
      setTimeout(()=>{
        if (!battleActive && countActors() < MAX_ACTORS) spawnActor();
        // ä¸‡ä¸€è¤‡æ•°æ¬ ã‘ãŸã‚‰åŸ‹ã¾ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã—
        while (!battleActive && countActors() < MAX_ACTORS) spawnActor();
      }, rand(400,1200));
    }

    // ===== ãƒãƒˆãƒ«ï¼šæŠ¼ã—åˆã„ã‚²ãƒ¼ã‚¸ï¼ˆé’vsèµ¤ï¼‰ =====
    let battleActive = false, battleTarget = null, enemyTimer = null;
    let p = 50; // é’ã®å‰ç·šä½ç½®ï¼ˆ0ã€œ100ï¼‰

    function renderGauge(){
      const clamped = Math.max(0, Math.min(100, p));
      blueFill.style.width = clamped + "%";
      redFill.style.width  = (100 - clamped) + "%";
      divider.style.left   = clamped + "%";
    }

    function startBattle(targetImg){
      battleActive = true;
      battleTarget = targetImg;
      p = 50;
      renderGauge();

      enemyNameLbl.textContent = `${targetImg.__mon.name}ï¼ˆèµ¤ï¼‰`;
      hudMask.style.display = "flex";

      // æ•µã®å¼·ã•ã§é›£æ˜“åº¦ã‚¹ã‚±ãƒ¼ãƒ«
      const s = targetImg.__mon.strength || 1.0;
      const enemyBasePerFrame = (ENEMY_BASE_PER_SEC * s) / 60;
      const burstPow = ENEMY_BURST_POW * s;

      // æ•µã®æŠ¼ã—ï¼ˆ60fpsç›¸å½“ï¼‰
      let lastBurstAt = performance.now();
      enemyTimer = setInterval(()=>{
        if (!battleActive) return;
        p -= enemyBasePerFrame; // æ•µãŒæŠ¼ã™ï¼å·¦ã¸

        const now = performance.now();
        if (now - lastBurstAt > rand(BURST_MIN_MS, BURST_MAX_MS)){
          p -= burstPow;
          lastBurstAt = now;
          // ãƒãƒãƒãƒæ¼”å‡º
          gaugeEl.classList.remove("enemy-throb");
          void gaugeEl.offsetWidth;
          gaugeEl.classList.add("enemy-throb");
        }

        if (p <= 0){
          endBattle(false); // æ•—åŒ—
        }else{
          renderGauge();
        }
      }, 16);

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€£æ‰“ï¼ˆé’ã‚’å³ã¸ï¼‰
      hud.onclick = ()=>{
        if (!battleActive) return;
        flashHurt(battleTarget); // è¢«å¼¾ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
        const push = PLAYER_PUSH * (0.9 + Math.random()*0.2);
        p += push;
        if (p >= 100){
          endBattle(true);  // å‹åˆ©
        }else{
          renderGauge();
        }
      };
    }

    function dropLoot(mon, atX, atY){
      // mon.drops ã‹ã‚‰ 1ã€œ2å€‹ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒ‰ãƒ­ãƒƒãƒ—
      const count = Math.random() < 0.35 ? 2 : 1;
      for (let i=0;i<count;i++){
        const item = pick(mon.drops);
        const el = document.createElement("div");
        // æ—¢å­˜ã® for ãƒ«ãƒ¼ãƒ—å†…ã€item ã‚’æ±ºã‚ãŸç›´å¾Œã«è¿½åŠ 
addToInventory(item, 1);

        el.className = "loot";
        el.textContent = `å…¥æ‰‹ï¼š${item}`;
        // è¡¨ç¤ºä½ç½®ï¼ˆæ’ƒç ´ä½ç½®ã®ã¡ã‚‡ã„ä¸Šï¼‰
        const x = atX + ACTOR_WIDTH/2 - 36 + rand(-14,14);
        const y = atY - 6 + rand(-6,6);
        el.style.left = `${x}px`;
        el.style.top  = `${y}px`;
        actorsLayer.appendChild(el);
        setTimeout(()=> el.remove(), 1100);
      }
    }

    function endBattle(playerWon){
      battleActive = false;
      clearInterval(enemyTimer); enemyTimer = null;
      hudMask.style.display = "none";

      if (!battleTarget || !battleTarget.isConnected){ battleTarget = null; return; }

      const target = battleTarget;
      battleTarget = null;

      // å‹æ•—ã§å‡¦ç†
      if (playerWon){
        // ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆæ’ƒç ´åº§æ¨™ãƒ™ãƒ¼ã‚¹ï¼‰
        const atX = parseFloat(target.style.left) || 0;
        const atY = parseFloat(target.style.top)  || 0;
        dropLoot(target.__mon, atX, atY);
        showToast("ã‚­ãƒ£ãƒ©ã‚’ã‚²ãƒƒãƒˆï¼");

        // ãã®å ´ã§è‡ªç„¶æ¶ˆæ»… â†’ è£œå……
        target.classList.add("vanish");
        target.addEventListener("animationend", ()=>{
          target.remove();
          scheduleRespawn();
        }, { once:true });
      }else{
        // æ•—åŒ—ï¼šè‡ªç„¶æ¶ˆæ»… â†’ è£œå……
        target.classList.add("vanish");
        target.addEventListener("animationend", ()=>{
          target.remove();
          scheduleRespawn();
        }, { once:true });
      }
    }

    // ===== åˆæœŸã‚¹ãƒãƒ¼ãƒ³ï¼ˆ6ä½“ï¼‰ =====
    for (let i=0;i<MAX_ACTORS;i++) spawnActor();

    // å¿µã®ãŸã‚ã€å®šæœŸçš„ã«æ¬ å“¡ãŒã‚ã‚Œã°è£œå……ï¼ˆä¿é™ºï¼‰
    setInterval(()=>{
      if (!battleActive && countActors() < MAX_ACTORS) scheduleRespawn();
    }, 3000);
  </script>
</body>
</html>

