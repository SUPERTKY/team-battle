<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TURI â€“ è¶…ãƒ ã‚ºå®Œå…¨ç‰ˆï¼ˆé¸æŠç¦æ­¢ï¼‰</title>
<style>
  html,body{
    margin:0; height:100%; background:#05121a; overflow:hidden;
    user-select: none;           /* â˜…ãƒ†ã‚­ã‚¹ãƒˆé¸æŠç¦æ­¢ */
    -webkit-user-select: none;   /* Safariå¯¾å¿œ */
    -ms-user-select: none;       /* å¤ã„IEå¯¾å¿œ */
  }
  .stage{
    position:relative;
    width:100vw; height:100vh;
    overflow:hidden;
    background:#000;
    user-select: none;           /* â˜…ãƒ‰ãƒ©ãƒƒã‚°ç¯„å›²é¸æŠç¦æ­¢ */
  }

  /* èƒŒæ™¯ */
  .layer{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    pointer-events:none;
    user-select:none;            /* â˜…ç”»åƒã‚‚é¸æŠç¦æ­¢ */
    -webkit-user-drag: none;     /* â˜…ç”»åƒãƒ‰ãƒ©ãƒƒã‚°ç¦æ­¢ */
  }
  #sand{ z-index:1; }
  #waterBase{ z-index:2; opacity:.8; }
  .tint{ z-index:3; mix-blend-mode:multiply; background:rgba(25,181,193,.22); }
  .caustics{ z-index:4; opacity:.25; mix-blend-mode:screen; background:#000; filter:url(#causticsFilter); }

  /* é­š */
  #fishLayer{ position:absolute; inset:0; z-index:10; pointer-events:none; }
  .fish{
    position:absolute;
    transform-origin:center center;
    pointer-events:auto;
    user-select:none;
    -webkit-user-drag: none; /* â˜…é­šãƒ‰ãƒ©ãƒƒã‚°ç¦æ­¢ */
    will-change:left, top, transform;
  }

  .shake{ animation: shake .22s ease-out; }
  @keyframes shake{
    0%{   transform: var(--rot0) translate(0,0) }
    35%{  transform: var(--rot0) translate(3px,-2px) }
    70%{  transform: var(--rot0) translate(-2px,2px) }
    100%{ transform: var(--rot0) translate(0,0) }
  }

  .vanish{ animation: vanish .25s ease forwards; }
  @keyframes vanish{
    to{ opacity:0; transform: var(--rot0) scale(.65); filter:blur(2px); }
  }

  .splash{
    position:absolute; width:10px; height:10px; border-radius:50%;
    left:0; top:0; transform: translate(-50%,-50%);
    background: rgba(255,255,255,.9);
    mix-blend-mode:screen;
    filter: blur(.5px);
    pointer-events:none; z-index:11;
    animation: ripple .5s ease-out forwards;
  }
  @keyframes ripple{ to{ width:140px; height:140px; opacity:0; } }
  /* === Inventory UI === */
.hud{
  position:fixed; right:12px; top:12px; z-index:20; display:flex; gap:8px;
}
.btn{
  background:#0b1c26aa; border:1px solid #7ee0ff66; color:#dff7ff;
  padding:8px 12px; border-radius:10px; backdrop-filter: blur(4px);
  font-weight:600; cursor:pointer
}
.btn:hover{ background:#0f2a36cc; }
.inv{
  position:fixed; right:12px; top:56px; width:min(420px, calc(100vw - 24px));
  max-height:min(70vh, 520px); overflow:auto; z-index:20;
  background:#06131bdf; border:1px solid #7ee0ff33; border-radius:12px;
  backdrop-filter: blur(6px); color:#e8fbff; padding:10px 10px 12px;
}
.inv h3{ margin:6px 8px 8px; font-size:16px }
.inv .meta{ margin:0 8px 8px; font-size:12px; opacity:.8 }
.inv .list{ display:grid; grid-template-columns: 1fr auto; gap:6px 10px; padding:6px 8px }
.inv .pill{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #ffffff22 }
.inv .rank-COMMON{ background:#0f1b21; }
.inv .rank-UNCOMMON{ background:#10241d; }
.inv .rank-RARE{ background:#0f1e2c; }
.inv .rank-EPIC{ background:#1b0f26; }
.inv .rank-LEGENDARY{ background:#291f0a; }
.inv .row{ display:contents }
.inv .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.hidden{ display:none !important; }

/* Toast */
.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:18px; z-index:30; background:#0b1c26f0; color:#e8fbff;
  border:1px solid #7ee0ff55; border-radius:10px; padding:10px 14px;
  backdrop-filter: blur(6px); font-size:14px; pointer-events:none; opacity:0;
  transition: opacity .2s ease, transform .2s ease;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

</style>
</head>
<body>
  <section class="stage" id="stage">
    <img id="sand" class="layer" src="assets/sand.png" alt="ç ‚" draggable="false">
    <img id="waterBase" class="layer" src="assets/water_background_80percent.png" alt="æ°´" draggable="false">
    <div class="layer tint"></div>
    <div class="layer caustics"></div>
    <div id="fishLayer"></div>
  </section>
  <!-- HUD: ãƒœã‚¿ãƒ³ -->


<!-- Inventory ãƒ‘ãƒãƒ« -->
<div id="invPanel" class="inv hidden">
  <h3>ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</h3>
  <div class="meta" id="invMeta">åˆè¨ˆ 0 åŒ¹</div>
  <div class="list" id="invList"></div>
</div>
<div class="hud">
  <button id="invBtn" class="btn">ğŸ£ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª</button>
</div>

<!-- Toast -->
<div id="toast" class="toast" aria-live="polite"></div>


  <svg width="0" height="0" style="position:absolute">
    <filter id="causticsFilter">
      <feTurbulence type="fractalNoise" baseFrequency="0.005 0.02"
        numOctaves="2" seed="5" result="noise">
        <animateTransform attributeName="patternTransform"
          type="translate" from="0 0" to="200 0"
          dur="30s" repeatCount="indefinite"/>
      </feTurbulence>
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        0 0 0 6 -3" result="contrast"/>
      <feGaussianBlur stdDeviation="1.2"/>
    </filter>
  </svg>

<script>
const CONFIG = {
  FISH_MIN_SIZE: 100,
  FISH_MAX_SIZE: 220,
  FISH_MAX_COUNT: 4, 

  BASE_SPEED: 300,       // â˜… åˆé€Ÿã‚’2å€ï¼ˆ280â†’560ï¼‰
  SPEED_BOOST: 2,      // â˜… åŠ é€Ÿå€ç‡ã‚‚UPï¼ˆ1.45â†’1.5ï¼‰
  SPEED_MAX: 3,        // â˜… æœ€å¤§8å€é€Ÿã¾ã§è¨±å¯
  TURN_RATE: 240,
  RETARGET_SEC: [0.8, 1.6], // â˜…é€²è·¯å¤‰æ›´ã‚‚ã•ã‚‰ã«é »ç¹ã«
  EDGE_MARGIN: 48,
  GOAL_RADIUS: 14,

  HP_MIN: 3,
  HP_MAX: 6,
  VANISH_TIME_RANGE: [1000, 5000], // â˜…æ¶ˆæ»…ã¾ã§ã®çŒ¶äºˆã‚‚çŸ­ç¸®ï¼ˆ0.45ã€œ1.0ç§’ï¼‰

  DASH_DIST: 240,
  DASH_TIME: 240
};
  
  const INV_LIMIT = 10;

  // ===== Catch Roll (sizeãŒå¤§ãã„ã»ã©ä¸Šä½ãŒå‡ºã‚„ã™ã„) =====
const CATCH = {
  ranks: ["COMMON","UNCOMMON","RARE","EPIC","LEGENDARY"],
  // å„ãƒ©ãƒ³ã‚¯ã§å‡ºã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é­šåï¼ˆé©å½“ã§OKï¼å¾Œã§å·®ã—æ›¿ãˆå¯ï¼‰
  speciesByRank: {
    COMMON:    ["ãƒ¯ã‚«ã‚µã‚®","ã‚­ãƒ³ã‚®ãƒ§","ã‚«ãƒ€ãƒ¤ã‚·"],
    UNCOMMON:  ["ãƒ–ãƒ«ãƒ¼ã‚®ãƒ«","ãƒ•ãƒŠ","ã‚ªã‚¤ã‚«ãƒ¯"],
    RARE:      ["ãƒ‹ã‚¸ãƒã‚¹","ãƒ–ãƒ©ãƒƒã‚¯ãƒã‚¹","ã‚³ã‚¤"],
    EPIC:      ["ã‚¤ãƒˆã‚¦","ã‚¢ã‚«ãƒ¡","ã‚µã‚¯ãƒ©ãƒã‚¹"],
    LEGENDARY: ["ã‚·ãƒ¼ãƒ©ã‚«ãƒ³ã‚¹","ãƒ‰ãƒ©ã‚´ãƒ³ãƒ•ã‚£ãƒƒã‚·ãƒ¥","ãƒ¡ã‚¬ã‚µãƒ¼ãƒ¢ãƒ³"]
  }
};

// sizeâ†’[0,1]ã«æ­£è¦åŒ–
function normSize(px){
  return clamp((px - CONFIG.FISH_MIN_SIZE) / (CONFIG.FISH_MAX_SIZE - CONFIG.FISH_MIN_SIZE), 0, 1);
}

// ãƒ©ãƒ³ã‚¯ã‚’ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ™ãƒ¼ã‚¹ç¢ºç‡ï¼‹ã‚µã‚¤ã‚ºè£œæ­£ï¼‰
// ãƒ™ãƒ¼ã‚¹: C 60%, U 25%, R 10%, E 4%, L 1%
// è£œæ­£: å¤§ãã„ã»ã©ä¸Šä½ã« +t*ä¿‚æ•° ã§å¯„ã›ã‚‹ï¼ˆåˆè¨ˆ1ã«å†æ­£è¦åŒ–ï¼‰
function rollRank(sizePx){
  const t = normSize(sizePx); // 0(å°)ã€œ1(å¤§)
  let pCommon    = 0.60 - 0.30*t;           // å°ã•ã„ã¨Cå¯„ã‚Š
  let pUncommon  = 0.25 - 0.05*t;
  let pRare      = 0.10 + 0.15*t;
  let pEpic      = 0.04 + 0.12*t;
  let pLegendary = 0.01 + 0.08*t;           // å¤§ãã„ã¨ä¼èª¬å¯„ã‚Š

  // ãƒã‚¤ãƒŠã‚¹å›é¿ï¼†æ­£è¦åŒ–
  pCommon    = Math.max(0, pCommon);
  pUncommon  = Math.max(0, pUncommon);
  pRare      = Math.max(0, pRare);
  pEpic      = Math.max(0, pEpic);
  pLegendary = Math.max(0, pLegendary);
  const S = pCommon+pUncommon+pRare+pEpic+pLegendary || 1;
  pCommon/=S; pUncommon/=S; pRare/=S; pEpic/=S; pLegendary/=S;

  const r=Math.random();
  if(r < pLegendary) return "LEGENDARY";
  if(r < pLegendary+pEpic) return "EPIC";
  if(r < pLegendary+pEpic+pRare) return "RARE";
  if(r < pLegendary+pEpic+pRare+pUncommon) return "UNCOMMON";
  return "COMMON";
}
// è§’åº¦è£œé–“ï¼ˆçŸ­ã„å›è»¢ï¼‰
function lerpAngle(a, b, t){
  const diff = ((b - a + 540) % 360) - 180;
  return a + diff * t;
}

// ç«¯ã¸ã®æ¥è¿‘åº¦ï¼ˆäºˆæ¸¬å›é¿ã§ä½¿ç”¨ï¼šæ—¢ã«å…¥ã‚Œã¦ãªã‘ã‚Œã°è¿½åŠ ï¼‰
function edgeProximity(x, y, w, h, margin = CONFIG.EDGE_MARGIN) {
  const dx = Math.min(x - margin, (w - margin) - x);
  const dy = Math.min(y - margin, (h - margin) - y);
  const nx = clamp(1 - (dx / margin), 0, 1);
  const ny = clamp(1 - (dy / margin), 0, 1);
  return Math.max(nx, ny);
}

function pickSpecies(rank){
  const arr = CATCH.speciesByRank[rank] || ["???"];
  return arr[(Math.random()*arr.length)|0];
}

// æ•ç²æ™‚ã®ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
function debugCatchLog({rank,species,sizePx,hpLeft}){
  console.log(
    `[CATCH] rank=${rank} species=${species} size=${Math.round(sizePx)}px hpLeft=${hpLeft}`
  );
}
// ç«¯ã¸ã®æ¥è¿‘åº¦ï¼ˆ0ã€œ1ï¼‰ã€‚1ã«è¿‘ã„ã»ã©ç«¯ã‚®ãƒªã‚®ãƒª
function edgeProximity(x, y, w, h, margin = CONFIG.EDGE_MARGIN) {
  const dx = Math.min(x - margin, (w - margin) - x);
  const dy = Math.min(y - margin, (h - margin) - y);
  const nx = clamp(1 - (dx / margin), 0, 1);
  const ny = clamp(1 - (dy / margin), 0, 1);
  return Math.max(nx, ny);
}

// è§’åº¦è£œé–“ï¼ˆçŸ­ã„å›è»¢æ–¹å‘ã§è£œé–“ï¼‰
function lerpAngle(a, b, t){
  const diff = ((b - a + 540) % 360) - 180;
  return a + diff * t;
}


const stage = document.getElementById('stage');
const fishLayer = document.getElementById('fishLayer');
const fishImgSrc = 'assets/fish.png';
const FISHES = [];
// spawnFish å†…ã® f ã‚’ä½œã‚‹ç›´å‰ã‚ãŸã‚Š


const DEG2RAD = Math.PI/180;
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const rand=(a,b)=>Math.random()*(b-a)+a;

function insideBox(w,h){
  return {x:rand(CONFIG.EDGE_MARGIN,w-CONFIG.EDGE_MARGIN),
          y:rand(CONFIG.EDGE_MARGIN,h-CONFIG.EDGE_MARGIN)};
}
function stepAngle(cur,target,maxStep){
  let diff=((target-cur+540)%360)-180;
  return cur+clamp(diff,-maxStep,maxStep);
}
function makeSplash(x,y){
  const sp=document.createElement('div');
  sp.className='splash';
  sp.style.left=x+'px';
  sp.style.top=y+'px';
  stage.appendChild(sp);
  sp.addEventListener('animationend',()=>sp.remove());
}

function spawnFish(){
  if(FISHES.length>=CONFIG.FISH_MAX_COUNT) return;

  const el=document.createElement('img');
  el.src=fishImgSrc;
  el.className='fish';
  el.draggable=false;

  const w=stage.clientWidth, h=stage.clientHeight;
  const pos=insideBox(w,h);

  // ã“ã“ã§ size ã‚’ä½œã‚‹ï¼ˆã“ã®é–¢æ•°ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ï¼‰
  const size = rand(CONFIG.FISH_MIN_SIZE, CONFIG.FISH_MAX_SIZE);

  // â˜…ã‚µã‚¤ã‚ºâ†’é€Ÿåº¦ï¼šæœ€å°ã‚µã‚¤ã‚º=BASE_SPEEDã€æœ€å¤§ã‚µã‚¤ã‚º=BASE_SPEED*2
  const t = (size - CONFIG.FISH_MIN_SIZE) / (CONFIG.FISH_MAX_SIZE - CONFIG.FISH_MIN_SIZE);
  const initSpeed = CONFIG.BASE_SPEED * (1 + clamp(t,0,1)); // 1ï½2å€

  el.style.width = size + 'px';
  el.style.left  = pos.x + 'px';
  el.style.top   = pos.y + 'px';
  fishLayer.appendChild(el);

  const hp = Math.round(lerp(
    CONFIG.HP_MIN, CONFIG.HP_MAX,
    (size - CONFIG.FISH_MIN_SIZE) / (CONFIG.FISH_MAX_SIZE - CONFIG.FISH_MIN_SIZE)
  ));

  const cx=w/2, cy=h/2;
  let angle = Math.atan2(cy-pos.y, cx-pos.x)*180/Math.PI + rand(-35,35);
  el.style.setProperty('--rot0',`rotate(${angle+90}deg)`);
  el.style.transform = `rotate(${angle+90}deg)`;

const f = {
  el,x:pos.x,y:pos.y,angle,width:size,
  speed: initSpeed,
  target: insideBox(w,h),
  nextRetarget: performance.now()+rand(...CONFIG.RETARGET_SEC)*1000,
  hp,alive:true,vanishAt:null,dashUntil:0,

  // â˜… è¿½åŠ ï¼šæ›²ç‡ãƒã‚¤ã‚ºï¼ˆå¸¸æ™‚ã†ã­ã‚Šï¼‰
  curvePhase: rand(0, Math.PI*2),
  curveSpeed: rand(0.8, 1.6),     // ã†ã­ã‚Šã®é€Ÿã•
  curveMag:   rand(6, 22),        // è§’åº¦ã†ã­ã‚Šã®æŒ¯å¹…[deg]

  // â˜… è¿½åŠ ï¼šä¸€æ™‚çš„ãªå††é‹å‹•ï¼ˆæ—‹å›ï¼‰
  orbitUntil: 0,
  orbitCenter: null,
  orbitRadius: 0,
  orbitDir: (Math.random()<0.5? -1: 1),
  orbitAng: 0
};

  FISHES.push(f);

  el.addEventListener('pointerdown',(ev)=>{
    if(!f.alive) return;
    f.hp--;
    const rect=stage.getBoundingClientRect();
    makeSplash(ev.clientX-rect.left, ev.clientY-rect.top);

    el.classList.remove('shake');
    requestAnimationFrame(()=> el.classList.add('shake'));

    f.speed = Math.min(f.speed * CONFIG.SPEED_BOOST,
                       CONFIG.BASE_SPEED * CONFIG.SPEED_MAX);

    if(!f.vanishAt){
      f.vanishAt = performance.now() + rand(...CONFIG.VANISH_TIME_RANGE);
    }

    const px=ev.clientX-rect.left, py=ev.clientY-rect.top;
    const away=Math.atan2(f.y-py,f.x-px);
    f.target = {
      x:clamp(f.x+Math.cos(away)*CONFIG.DASH_DIST,CONFIG.EDGE_MARGIN,w-CONFIG.EDGE_MARGIN),
      y:clamp(f.y+Math.sin(away)*CONFIG.DASH_DIST,CONFIG.EDGE_MARGIN,h-CONFIG.EDGE_MARGIN)
    };
    f.dashUntil = performance.now()+CONFIG.DASH_TIME;

    if(f.hp<=0){
      f.alive=false;
      vanishFish(f,true);
    }
  },{passive:true});
  function startOrbit(f, w, h, now){
  // ç”»é¢å†…ã§å®‰å…¨ã«å›ã‚Œã‚‹ä¸­å¿ƒã¨åŠå¾„ã‚’æ±ºå®š
  const r = rand(80, 220);
  const cx = clamp(f.x, CONFIG.EDGE_MARGIN + r, w - CONFIG.EDGE_MARGIN - r);
  const cy = clamp(f.y, CONFIG.EDGE_MARGIN + r, h - CONFIG.EDGE_MARGIN - r);

  f.orbitCenter = {x: cx, y: cy};
  f.orbitRadius = r;
  f.orbitAng    = Math.atan2(f.y - cy, f.x - cx) * 180/Math.PI;
  f.orbitDir    = (Math.random()<0.5? -1: 1);
  f.orbitUntil  = now + rand(900, 1800); // 0.9ã€œ1.8ç§’ã ã‘æ—‹å›
}

}

function vanishFish(f,caught=false){
  // â˜… caughtæ™‚ã«ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
  if (caught) {
    const rank = rollRank(f.width);
    const species = pickSpecies(rank);
    debugCatchLog({rank, species, sizePx: f.width, hpLeft: f.hp});

    // â–¼ è¿½è¨˜ï¼šã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªç™»éŒ²
    addCatchToInv({ rank, species, sizePx: f.width });
  }

  f.el.classList.add('vanish');
  setTimeout(()=>{
    const idx=FISHES.indexOf(f);
    if(idx!==-1)FISHES.splice(idx,1);
    f.el.remove();
    spawnFish();
  },250);
}

let last=performance.now();
function tick(now){
  const dt=(now-last)/1000; last=now;
  const w=stage.clientWidth,h=stage.clientHeight;
  for(const f of FISHES){
    if(!f.alive) continue;
    if(f.vanishAt && now>=f.vanishAt){
      f.alive=false; vanishFish(f,false); continue;
    }
    if(now>=f.nextRetarget){
      f.target=insideBox(w,h);
      f.nextRetarget=now+rand(...CONFIG.RETARGET_SEC)*1000;
    }
    const desired = Math.atan2(f.target.y - f.y, f.target.x - f.x) * 180/Math.PI;

// ç«¯ã«è¿‘ã„ã»ã© desired ã‚’ç”»é¢ä¸­å¿ƒæ–¹å‘ã¸å°‘ã—ã ã‘å¯„ã›ã‚‹ï¼ˆé€Ÿåº¦ã¯è§¦ã‚‰ãªã„ï¼‰
const prox = edgeProximity(f.x, f.y, w, h, CONFIG.EDGE_MARGIN); // 0ã€œ1
if (prox > 0) {
  const centerAngle = Math.atan2((h*0.5) - f.y, (w*0.5) - f.x) * 180/Math.PI;
  const blended = lerpAngle(desired, centerAngle, Math.min(0.8, prox)); // æœ€å¤§80%ã ã‘ä¸­å¿ƒå¯„ã‚Š
  f.angle = stepAngle(f.angle, blended, CONFIG.TURN_RATE * dt);
} else {
  f.angle = stepAngle(f.angle, desired, CONFIG.TURN_RATE * dt);
}

    const rad=f.angle*DEG2RAD;
    f.x+=Math.cos(rad)*f.speed*dt;
    f.y+=Math.sin(rad)*f.speed*dt;
    f.x=clamp(f.x,CONFIG.EDGE_MARGIN,w-CONFIG.EDGE_MARGIN);
    f.y=clamp(f.y,CONFIG.EDGE_MARGIN,h-CONFIG.EDGE_MARGIN);
    const visualRot=f.angle+90;
    f.el.style.setProperty('--rot0',`rotate(${visualRot}deg)`);
    f.el.style.left=f.x+'px';
    f.el.style.top=f.y+'px';
    f.el.style.transform=`rotate(${visualRot}deg)`;
  }
  requestAnimationFrame(tick);
}

function init(){
  for(let i=0;i<CONFIG.FISH_MAX_COUNT;i++) spawnFish();
  requestAnimationFrame(tick);
}
  // === Inventory åˆæœŸåŒ–/UIã‚¤ãƒ™ãƒ³ãƒˆ ===
addEventListener('load', () => {
  renderInventory();

  const btn = document.getElementById('invBtn');
  const clr = document.getElementById('invClearBtn');
  btn && btn.addEventListener('click', toggleInventory);
  clr && clr.addEventListener('click', clearInventory);

  // ã‚­ãƒ¼æ“ä½œ: Iã§é–‹é–‰ / Cã§å…¨æ¶ˆå»
  addEventListener('keydown', (e)=>{
    if(e.key==='i' || e.key==='I'){ toggleInventory(); }
    if(e.key==='c' || e.key==='C'){ clearInventory(); }
  });
});

addEventListener('load',init);
  // === Inventory ===
const INV_KEY = 'turi_inventory_v1';
const RANKS = CATCH.ranks; // ["COMMON","UNCOMMON",...]
let inventory = loadInv();

function loadInv(){
  try{
    const j = localStorage.getItem(INV_KEY);
    return j ? JSON.parse(j) : { total:0, bySpecies:{} };
  }catch(_){ return { total:0, bySpecies:{} }; }
}

function saveInv(){ localStorage.setItem(INV_KEY, JSON.stringify(inventory)); }

function addCatchToInv({rank, species, sizePx}){
  if (inventory.total >= INV_LIMIT){
    showToast("ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãŒã„ã£ã±ã„ã§ã™");
    return; // è¿½åŠ ã—ãªã„
  }

  inventory.total++;
  inventory.bySpecies[species] = (inventory.bySpecies[species]||0)+1;
  saveInv();
  renderInventory();
  showToast(`+1 ${species} ã‚’é‡£ã£ãŸï¼ï¼ˆåˆè¨ˆ ${inventory.bySpecies[species]}ï¼‰`);
}





function renderInventory(){
  const meta = document.getElementById('invMeta');
  const list = document.getElementById('invList');
  if(!meta || !list) return;

  meta.textContent = `åˆè¨ˆ ${inventory.total} åŒ¹`;

  const entries = Object.entries(inventory.bySpecies)
    .sort((a,b)=>a[0].localeCompare(b[0],'ja'));

  list.innerHTML = '';
  for(const [name,count] of entries){
    const rowName = document.createElement('div');
    rowName.className = 'row name';
    rowName.textContent = name;

    const rowCount = document.createElement('div');
    rowCount.className = 'row';
    rowCount.innerHTML = `
      <span class="pill">${count}</span>
      <button class="btnStore">å€‰åº«</button>
      <button class="btnDrop">æ¨ã¦ã‚‹</button>
    `;

    // å€‰åº«ã«ã—ã¾ã†
    rowCount.querySelector('.btnStore').addEventListener('click', async ()=>{
      // Firebase ãƒãƒ¼ãƒ 1å€‰åº«ã«è¿½åŠ 
      const dbRef = ref(window.db, "warehouse/team1");
      await push(dbRef, { species:name, count:1, ts:Date.now() });

      // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤
      inventory.total--;
      inventory.bySpecies[name]--;
      if(inventory.bySpecies[name] <= 0) delete inventory.bySpecies[name];
      saveInv();
      renderInventory();
      showToast(`${name} ã‚’å€‰åº«ã«ã—ã¾ã„ã¾ã—ãŸ`);
    });

    // æ¨ã¦ã‚‹
    rowCount.querySelector('.btnDrop').addEventListener('click', ()=>{
      inventory.total--;
      inventory.bySpecies[name]--;
      if(inventory.bySpecies[name] <= 0) delete inventory.bySpecies[name];
      saveInv();
      renderInventory();
      showToast(`${name} ã‚’æ¨ã¦ã¾ã—ãŸ`);
    });

    list.appendChild(rowName);
    list.appendChild(rowCount);
  }
}



function toggleInventory(){
  const p = document.getElementById('invPanel');
  if(p) p.classList.toggle('hidden');
}
function showToast(html){
  const t = document.getElementById('toast');
  if(!t) return;
  t.innerHTML = html;
  t.classList.add('show');
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=> t.classList.remove('show'), 1600);
}

</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";


const firebaseConfig = {
  apiKey: "AIzaSyDPe5cSCavq5gHopugdOfQ-9_50cTrqmyk",
  authDomain: "school-178c2.firebaseapp.com",
  databaseURL: "https://school-178c2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "school-178c2",
  storageBucket: "school-178c2.firebasestorage.app",
  messagingSenderId: "409885673101",
  appId: "1:409885673101:web:25bf0483547e2d470304c4"
};
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã« window ã«è¼‰ã›ã‚‹
  window.firebaseDB = { db, ref, push };
</script>


</body>
</html>


















