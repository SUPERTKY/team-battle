<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TURI – 超ムズ</title>
<style>
  html,body{
    margin:0; height:100%; background:#000; overflow:hidden;
  }
  .stage{
    position:relative;
    width:100%; height:100%;
    overflow:hidden;
    background:#000;
  }
  .fish{
    position:absolute;
    transform-origin:center center;
    pointer-events:auto;
    user-select:none;
    will-change: transform, left, top;
  }
  .vanish{
    animation: vanish .25s ease forwards;
  }
  @keyframes vanish{
    to{ opacity:0; transform: scale(0.6) rotate(20deg); filter:blur(2px); }
  }
</style>
</head>
<body>
  <section class="stage" id="stage">
    <div id="fishLayer"></div>
  </section>

<script>
const CONFIG = {
  FISH_MIN_SIZE: 90,
  FISH_MAX_SIZE: 180,
  FISH_MAX_COUNT: 6,

  BASE_SPEED: 240,          // 初速から速い
  SPEED_BOOST: 1.4,         // タップ毎に加速倍率
  SPEED_MAX: 6.0,           // 最大速度倍率
  TURN_RATE: 220,           // 旋回
  EDGE_MARGIN: 40,
  RETARGET_SEC: [1.0, 2.5], // 頻繁に進路変更
  GOAL_RADIUS: 14,

  HP_MIN: 2,
  HP_MAX: 5,
  VANISH_TIME_RANGE: [600, 1500] // 1回目タップ後の寿命(ms)
};

const stage = document.getElementById("stage");
const fishLayer = document.getElementById("fishLayer");
const fishImgSrc = "assets/fish.png";

const FISHES = [];
function rand(a,b){ return Math.random()*(b-a)+a; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function lerp(a,b,t){ return a+(b-a)*t; }
function insideBox(w,h){ return {x:rand(CONFIG.EDGE_MARGIN,w-CONFIG.EDGE_MARGIN), y:rand(CONFIG.EDGE_MARGIN,h-CONFIG.EDGE_MARGIN)}; }
function stepAngle(cur,target,maxStep){ let d=((target-cur+540)%360)-180; return cur+clamp(d,-maxStep,maxStep); }

/* spawn */
function spawnFish(){
  if(FISHES.length>=CONFIG.FISH_MAX_COUNT) return;

  const el=document.createElement("img");
  el.src=fishImgSrc;
  el.className="fish";

  const w=stage.clientWidth,h=stage.clientHeight;
  const pos=insideBox(w,h);
  const size=rand(CONFIG.FISH_MIN_SIZE,CONFIG.FISH_MAX_SIZE);
  el.style.width=size+"px";
  el.style.left=pos.x+"px";
  el.style.top=pos.y+"px";
  fishLayer.appendChild(el);

  const hp=Math.round(lerp(CONFIG.HP_MIN,CONFIG.HP_MAX,(size-CONFIG.FISH_MIN_SIZE)/(CONFIG.FISH_MAX_SIZE-CONFIG.FISH_MIN_SIZE)));

  const f={
    el,x:pos.x,y:pos.y,
    angle:rand(0,360),
    speed:CONFIG.BASE_SPEED,
    target:insideBox(w,h),
    nextRetarget:performance.now()+rand(...CONFIG.RETARGET_SEC)*1000,
    width:size,
    hp,alive:true,
    vanishAt:null
  };
  FISHES.push(f);

  el.addEventListener("pointerdown",()=>{
    if(!f.alive) return;
    f.hp--;
    if(!f.vanishAt){
      f.vanishAt=performance.now()+rand(...CONFIG.VANISH_TIME_RANGE);
    }
    f.speed=Math.min(f.speed*CONFIG.SPEED_BOOST,CONFIG.BASE_SPEED*CONFIG.SPEED_MAX);

    if(f.hp<=0){
      f.alive=false;
      vanishFish(f,true);
    }
  });
}

function vanishFish(f,caught=false){
  f.el.classList.add("vanish");
  setTimeout(()=>{
    const i=FISHES.indexOf(f);
    if(i!==-1)FISHES.splice(i,1);
    f.el.remove();
    spawnFish();
  },250);
}

let last=performance.now();
function tick(now){
  const dt=(now-last)/1000; last=now;
  const w=stage.clientWidth,h=stage.clientHeight;

  for(const f of FISHES){
    if(!f.alive) continue;

    if(f.vanishAt && now>=f.vanishAt){
      f.alive=false;
      vanishFish(f,false);
      continue;
    }

    if(now>=f.nextRetarget){
      f.target=insideBox(w,h);
      f.nextRetarget=now+rand(...CONFIG.RETARGET_SEC)*1000;
    }

    const desired=Math.atan2(f.target.y-f.y,f.target.x-f.x)*180/Math.PI;
    f.angle=stepAngle(f.angle,desired,CONFIG.TURN_RATE*dt);

    const rad=f.angle*Math.PI/180;
    f.x+=Math.cos(rad)*f.speed*dt;
    f.y+=Math.sin(rad)*f.speed*dt;
    f.x=clamp(f.x,CONFIG.EDGE_MARGIN,w-CONFIG.EDGE_MARGIN);
    f.y=clamp(f.y,CONFIG.EDGE_MARGIN,h-CONFIG.EDGE_MARGIN);

    f.el.style.left=f.x+"px";
    f.el.style.top=f.y+"px";
    f.el.style.transform=`rotate(${f.angle+90}deg)`;
  }
  requestAnimationFrame(tick);
}

function init(){
  for(let i=0;i<CONFIG.FISH_MAX_COUNT;i++) spawnFish();
  requestAnimationFrame(tick);
}
window.addEventListener("load",init);
</script>
</body>
</html>
